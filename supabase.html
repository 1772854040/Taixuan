<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>太玄 · 账号与联系</title>
  <!-- 该页面专用 CSP：允许加载 Supabase SDK 与连接到 Supabase 域名 -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data:; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co https://*.supabase.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #8C6E54;
      --accent: #D9B382;
      --ink: #1A1A1A;
      --paper: #F6F4EE;
      --line: rgba(0,0,0,0.12);
      --danger: #B23A2B;
      --success: #2E7D32;
    }
    * { box-sizing: border-box; }
    body { font-family: "Noto Serif SC", serif; background: var(--paper); color: var(--ink); margin: 0; }
    header { background: #2a1e16; color: #F5F1E8; padding: 16px; }
    header .container { max-width: 960px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    header a { color: var(--accent); text-decoration: none; }
    main { max-width: 960px; margin: 24px auto; padding: 0 16px 40px; }
    h1 { font-size: 1.6rem; margin: 0 0 8px; }
    .desc { color: #555; margin-bottom: 16px; }
    .card { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    label { display: block; font-size: 0.95rem; margin: 10px 0 6px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
    textarea { min-height: 100px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row > div { display: flex; flex-direction: column; }
    .actions { display: flex; gap: 8px; margin-top: 12px; }
    button { padding: 10px 16px; border-radius: 24px; border: 1px solid #ddd; background: linear-gradient(to right, var(--accent), var(--primary)); color: #2a1e16; cursor: pointer; }
    button.secondary { background: #fafafa; }
    .status { margin-top: 10px; font-size: 0.95rem; }
    .status.error { color: var(--danger); }
    .status.success { color: var(--success); }
    .muted { color: #666; font-size: 0.9rem; }
    .hidden { display: none; }
    footer { text-align: center; color: #555; padding: 16px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #f3f3f3; border: 1px solid #e6e6e6; border-radius: 6px; padding: 2px 6px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div>
        <strong>太玄 · 账号与联系</strong>
        <div class="muted">此页用于登录/注册与提交联系信息</div>
      </div>
      <a href="./1.html">返回主页</a>
    </div>
  </header>
  <main>
    <section class="card">
      <h1>登录 / 注册</h1>
      <div class="desc">使用邮箱与密码登录；首次使用可注册账号。</div>
      <div id="user-info" class="muted">未登录</div>
      <div id="auth">
        <label for="email">邮箱</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
        <label for="password">密码</label>
        <input id="password" type="password" placeholder="至少 8 位" autocomplete="current-password" />
        <div class="actions">
          <button id="sign-in">登录</button>
          <button id="sign-up" class="secondary">注册</button>
          <button id="check-email-confirm" class="secondary" title="生成临时测试账号以检测是否自动登录">检测邮箱验证</button>
        </div>
        <div id="auth-status" class="status"></div>
      </div>
      <div id="authed" class="hidden">
        <div class="actions">
          <button id="sign-out" class="secondary">退出登录</button>
        </div>
        <div class="muted" style="margin-top:8px;">
          我的用户ID：<span id="my-user-id" class="kbd">(未获取)</span> 
          <button id="copy-user-id" class="secondary" style="margin-left:8px;">复制</button>
        </div>
        <div class="muted" style="margin-top:6px; font-size:0.9rem;">
          赋权 SQL（将下方 <span class="kbd"><ADMIN_UUID></span> 替换为你的用户ID后，粘贴到 Supabase SQL Editor 运行）：
          <div class="kbd" id="grant-admin-sql" style="display:block; white-space: pre-wrap; margin-top:6px;">
insert into public.members (user_id, role)
values ('<ADMIN_UUID>', 'admin')
on conflict (user_id) do update set role = excluded.role;
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h1>联系信息提交</h1>
      <div class="desc">登录后填写姓名、电话与留言，保存到数据库。</div>
      <form id="contact-form">
        <div class="row">
          <div>
            <label for="name">姓名</label>
            <input id="name" type="text" placeholder="张三" />
          </div>
          <div>
            <label for="phone">电话</label>
            <input id="phone" type="tel" placeholder="13800000000" />
          </div>
        </div>
        <label for="message">留言</label>
        <textarea id="message" placeholder="请填写您的需求或问题"></textarea>
        <div class="actions">
          <button type="submit">提交</button>
          <button type="reset" class="secondary">重置</button>
        </div>
        <div id="contact-status" class="status"></div>
      </form>
      <div class="muted" style="margin-top:8px;">
        使用前请在主页右下角点击“配置 Supabase”，填写并保存 <span class="kbd">Project URL</span> 与 <span class="kbd">anon key</span>；本页会自动读取。
      </div>
    </section>

    <section class="card">
      <h1>使用说明</h1>
      <ul class="muted" style="padding-left: 18px; line-height: 1.7;">
        <li>在 Supabase 控制台创建项目，记录 <span class="kbd">Project URL</span> 与 <span class="kbd">anon key</span>。</li>
        <li>在数据库 SQL 运行以下（需已创建 <span class="kbd">profiles</span> 与 <span class="kbd">contacts</span> 表并启用 RLS）：
          <div class="kbd" style="display:block; white-space: pre-wrap; margin-top:6px;">-- 创建表（如已创建可略）：
create table if not exists public.profiles (
  user_id uuid primary key references auth.users (id),
  full_name text,
  updated_at timestamptz default now()
);

create table if not exists public.contacts (
  id bigint generated always as identity primary key,
  user_id uuid references auth.users (id) not null,
  name text not null,
  phone text,
  message text not null,
  created_at timestamptz default now()
);

-- 启用 RLS：
alter table public.profiles enable row level security;
alter table public.contacts enable row level security;

-- 仅本人读写（profiles）：
create policy if not exists profiles_select_own on public.profiles
  for select to authenticated using (auth.uid() = user_id);
create policy if not exists profiles_upsert_own on public.profiles
  for insert to authenticated with check (auth.uid() = user_id);
create policy if not exists profiles_update_own on public.profiles
  for update to authenticated using (auth.uid() = user_id) with check (auth.uid() = user_id);

-- 联系记录：登录用户可写、仅本人可读：
create policy if not exists contacts_select_own on public.contacts
  for select to authenticated using (auth.uid() = user_id);
create policy if not exists contacts_insert_own on public.contacts
  for insert to authenticated with check (auth.uid() = user_id);
          </div></li>
        <li>在主页完成“配置 Supabase”后，本页会自动读取配置；提交到仓库并访问：/Taixuan/supabase.html。</li>
      </ul>
    </section>
  </main>

  <footer>
    <div class="muted">© 太玄 · 使用 GitHub Pages 托管 · Supabase 提供认证与存储</div>
  </footer>

  <!-- 接入全局配置与本地 UMD Supabase（与 1.html / shouji.html 保持一致） -->
  <script src="./supabase.config.js?v=cfg2"></script>
  <script src="./assets/supabase.js?v=local-min-1"></script>

  <script type="module">
    let supabase;
    function isSupabaseConfigValid(){
      try{
        const u = (window.__SUPABASE__ && window.__SUPABASE__.url) || '';
        const a = (window.__SUPABASE__ && window.__SUPABASE__.anon) || '';
        const okDomain = /^https:\/\/[a-z0-9-]+\.supabase\.co$/i.test(u) && !/your-project\.supabase\.co/i.test(u);
        return !!(window.supabase && okDomain && a && a.length > 20);
      }catch(e){ return false; }
    }
    (async () => {
      try {
        if (isSupabaseConfigValid()) {
          supabase = window.supabase.createClient(window.__SUPABASE__.url, window.__SUPABASE__.anon);
          try { const ui = document.getElementById('auth-status'); if (ui) ui.textContent = ''; } catch(e){}
        } else {
          const ui = document.getElementById('auth-status');
          if (ui) ui.textContent = '未检测到项目配置：请先在主页右下角“配置 Supabase”保存 URL 与 anon key';
        }
        initAuthUI();
      } catch (e) {
        const ui = document.getElementById('auth-status');
        if (ui) ui.textContent = 'Supabase 初始化失败：' + (e && e.message ? e.message : e);
        console.error('Supabase init error', e);
      }
    })();

    const $ = (sel) => document.querySelector(sel);
    const status = { auth: $('#auth-status'), contact: $('#contact-status') };

    function setStatus(el, msg, kind = 'info') {
      el.textContent = msg;
      el.className = `status ${kind === 'error' ? 'error' : kind === 'success' ? 'success' : ''}`;
    }

    async function initAuthUI() {
      if (!supabase) return;
      async function refreshUser() {
        const { data } = await supabase.auth.getSession();
        const session = data.session;
        if (session?.user) {
          $('#user-info').textContent = `已登录：${session.user.email}`;
          $('#auth').classList.add('hidden');
          $('#authed').classList.remove('hidden');
          // 填充当前用户ID与赋权SQL
          const uid = session.user.id || '';
          const uidEl = $('#my-user-id');
          if (uidEl) uidEl.textContent = uid || '(未获取)';
          const sqlEl = $('#grant-admin-sql');
          if (sqlEl && uid) {
            sqlEl.textContent = `insert into public.members (user_id, role)\nvalues ('${uid}', 'admin')\non conflict (user_id) do update set role = excluded.role;`;
          }
          // 绑定复制ID按钮
          const copyBtn = $('#copy-user-id');
          if (copyBtn) {
            copyBtn.onclick = async () => {
              try { await navigator.clipboard.writeText(uid); setStatus(status.auth, '用户ID已复制到剪贴板', 'success'); }
              catch (e) { setStatus(status.auth, '复制失败：请手动选择并复制', 'error'); }
            };
          }
        } else {
          $('#user-info').textContent = '未登录';
          $('#auth').classList.remove('hidden');
          $('#authed').classList.add('hidden');
          // 重置显示
          const uidEl = $('#my-user-id');
          if (uidEl) uidEl.textContent = '(未获取)';
          const sqlEl = $('#grant-admin-sql');
          if (sqlEl) {
            sqlEl.textContent = `insert into public.members (user_id, role)\nvalues ('<ADMIN_UUID>', 'admin')\non conflict (user_id) do update set role = excluded.role;`;
          }
        }
      }

      supabase.auth.onAuthStateChange((_event, _session) => { refreshUser(); });
      await refreshUser();

      // 登录
      $('#sign-in').addEventListener('click', async () => {
        const email = $('#email').value.trim();
        const password = $('#password').value;
        if (!email || !password) { setStatus(status.auth, '请填写邮箱与密码'); return; }
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) setStatus(status.auth, `登录失败：${error.message}`, 'error');
        else setStatus(status.auth, '登录成功', 'success');
      });

      // 注册（关闭邮箱验证即可自动登录）
      $('#sign-up').addEventListener('click', async () => {
        const email = $('#email').value.trim();
        const password = $('#password').value;
        if (!email || !password) { setStatus(status.auth, '请填写邮箱与密码'); return; }
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) { setStatus(status.auth, `注册失败：${error.message}`, 'error'); return; }
        if (data && data.session) { setStatus(status.auth, '注册成功，已自动登录（无需邮箱验证）', 'success'); }
        else { setStatus(status.auth, '注册成功。若仍提示需验证，请在控制台关闭“启用邮箱验证”。', 'success'); }
      });

      // 退出
      $('#sign-out').addEventListener('click', async () => { await supabase.auth.signOut(); setStatus(status.auth, '已退出'); });

      // 检测邮箱验证配置（会创建一个临时测试用户）
      $('#check-email-confirm').addEventListener('click', async () => {
        const testEmail = `diagnostic+${Date.now()}@example.com`;
        const testPassword = `DiagTest_${Math.random().toString(36).slice(2)}Aa1!`;
        setStatus(status.auth, `正在检测：尝试注册 ${testEmail}`);
        const { data, error } = await supabase.auth.signUp({ email: testEmail, password: testPassword });
        if (error) { setStatus(status.auth, `检测失败：${error.message}`, 'error'); return; }
        if (data && data.session) { setStatus(status.auth, `检测结果：注册后已自动登录（邮箱验证已关闭）。测试账户：${testEmail}（已自动退出）`, 'success'); await supabase.auth.signOut(); }
        else { setStatus(status.auth, '检测结果：注册未自动登录（邮箱验证仍开启）。请前往 Authentication -> Settings -> Email 关闭 Enable email confirmations。', 'error'); }
      });

      // 联系表单提交
      $('#contact-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { data } = await supabase.auth.getSession();
        const user = data.session?.user;
        if (!user) { setStatus(status.contact, '请先登录后再提交', 'error'); return; }
        const name = $('#name').value.trim();
        const phone = $('#phone').value.trim();
        const message = $('#message').value.trim();
        if (!name || !message) { setStatus(status.contact, '请填写姓名与留言', 'error'); return; }
        const { error } = await supabase.from('contacts').insert({ user_id: user.id, name, phone, message });
        if (error) setStatus(status.contact, `提交失败：${error.message}`, 'error');
        else { setStatus(status.contact, '提交成功！', 'success'); $('#contact-form').reset(); }
      });
    }
  </script>
</body>
</html>