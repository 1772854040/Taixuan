<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data:; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co https://*.supabase.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'">
    <title>太玄文化 - 易学大师个人品牌</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="preload" as="image" href="taixuan-bg.jpg">
    <style>
        :root {
            --primary-color: #8C6E54; /* 低饱和棕色 */
            --secondary-color: #A67C52; /* 暖棕色 */
            --accent-color: #D9B382; /* 强调色 */
            --dark-color: #3D2B1F; /* 深色 */
            --light-color: #F5F1E8; /* 浅色 */
            --text-color: #2C2416; /* 主文本色 */
            --highlight-color: #BF4342; /* 高对比度红色 */
            --mountain-color: #5D7B6F; /* 山脉颜色 - 青灰色 */
            --mountain-light: #7A9C8B; /* 浅山脉色 */
            --mountain-dark: #465A52; /* 深山色 */
            --bronze-color: #B08D57; /* 青铜色 */
            --bronze-dark: #8C6E54; /* 深青铜色 */
            --bronze-light: #D9B382; /* 浅青铜色 */
            --silver-color: #C0C0C0; /* 银色 */
            --silver-dark: #A0A0A0; /* 深银色 */
            --silver-light: #E0E0E0; /* 浅银色 */
            --gold-color: #D4AF37; /* 金色 */
            --gold-dark: #B8860B; /* 深金色 */
            --gold-light: #FFD700; /* 浅金色 */
            --admin-color: #4A235A; /* 管理员紫色 */
            --admin-light: #6C3483; /* 浅紫色 */
            /* 中式极简配色 */
            --paper-bg: #F6F4EE; /* 宣纸底色 */
            --ink-color: #1A1A1A; /* 墨黑文本 */
            --accent-red: #B23A2B; /* 朱红（印章） */
            --accent-navy: #1F3A5B; /* 藏青（点缀） */
            --accent-ochre: #A6743A; /* 赭石（点缀） */
            --divider-ink: rgba(0,0,0,0.12); /* 纤细分隔线 */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Noto Serif SC", "Source Han Serif SC", "SimSun", serif;
            background-color: var(--paper-bg);
            color: var(--ink-color);
            background-image:
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" opacity="0.03"><path d="M0,0 L400,400 M400,0 L0,400" stroke="%233D2B1F" stroke-width="1"/></svg>'),
                radial-gradient(circle at 30% 20%, rgba(0,0,0,0.02), transparent 60%),
                radial-gradient(circle at 70% 80%, rgba(0,0,0,0.015), transparent 50%),
                repeating-linear-gradient(0deg, rgba(0,0,0,0.02) 0, rgba(0,0,0,0.02) 1px, transparent 3px);
            background-size: 40%, cover, cover, auto;
            background-position: center, center, center, 0 0;
            background-repeat: no-repeat, no-repeat, no-repeat, repeat;
            line-height: 1.7;
            position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0,0,0,0.02) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0,0,0,0.02) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 40%, rgba(0,0,0,0.01) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(to bottom, var(--dark-color), #2a1e16);
            color: var(--light-color);
            padding: 10px 0;
            position: relative;
            overflow: visible;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(217, 179, 130, 0.2);
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.05"><path d="M0,0 L200,200 M200,0 L0,200" stroke="%23F5F1E8" stroke-width="1"/></svg>');
            z-index: 1;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 2.0rem;
            color: var(--accent-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
        }
        
        .logo-subtitle {
            font-size: 0.9rem;
            margin-top: 2px;
            margin-left: 0;
            letter-spacing: 3px;
            font-family: "Noto Serif SC", serif;
            display: block;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
        }
        
        nav ul li {
            margin-left: 10px;
            position: relative;
        }
        
        nav ul li a {
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            line-height: 1.5;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.15);
            position: relative;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            cursor: pointer;
        }
        nav ul li a:hover {
            background: rgba(217, 179, 130, 0.1);
            border-color: rgba(217, 179, 130, 0.4);
        }
        nav ul li a::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%,-50%);
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.35s, width 0.35s, height 0.35s;
            pointer-events: none;
        }
        nav ul li a:hover::after {
            opacity: 1;
            width: 180%;
            height: 280%;
        }
        
        nav ul li a::before {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-navy), transparent);
            transition: width 0.3s;
            opacity: 0.7;
        }
        nav ul li a:hover::before {
            width: 100%;
        }
        
        nav ul li a:hover {
            color: var(--accent-color);
            background: rgba(255,255,255,0.10);
            border-color: rgba(255,255,255,0.28);
        }
        /* 新增：邮件气泡与下拉样式（与现有风格一致） */
        .mail-bubble {
            display: inline-block;
            color: #e74c3c;
            margin-left: 6px;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .mail-dropdown {
            background: #fff;
            border: 1px solid #eee;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border-radius: 10px;
            min-width: 320px;
        }
        
        nav ul li a:hover::after {
            width: 100%;
        }
        
        /* 登录按钮样式 */
        .login-btn {
            background: linear-gradient(to right, var(--accent-color), var(--secondary-color));
            color: var(--dark-color);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            font-size: 1rem;
        }
        
        .login-btn:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(217, 179, 130, 0.3);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-color);
            position: relative;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-color);
            font-weight: bold;
        }
        
        .admin-avatar {
            background: linear-gradient(135deg, var(--admin-light), var(--admin-color));
        }
        /* VIP徽标（桌面头像） */
        .user-avatar.vip { position: relative; }
        .user-avatar.vip::after {
            content: 'VIP';
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(135deg, #d9b382, #b08968);
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
            z-index: 2;
        }
        .user-avatar.vip:hover::after {
            opacity: 1;
            transform: translateY(0);
        }
        
        .logout-btn {
            background: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background: var(--accent-color);
            color: var(--dark-color);
        }

        /* 用户等级与奖励提示 */
        .user-tooltip {
            position: absolute;
            top: 48px;
            right: 0;
            min-width: 180px;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(245, 241, 232, 0.95);
            color: var(--dark-color);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
            z-index: 20;
            font-size: 0.95rem;
        }
        .user-info:hover .user-tooltip,
        .user-avatar:hover + .user-tooltip,
        .user-info span:hover ~ .user-tooltip {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .user-tooltip .line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
        }
        .user-tooltip .label {
            color: #555;
        }
        .user-tooltip .value {
            color: var(--text-color);
            font-weight: 600;
        }
        .user-progress {
            margin-top: 6px;
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.08);
            border-radius: 4px;
            overflow: hidden;
        }
        .user-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-color), #f4c27a);
            transition: width 0.3s ease;
        }

        /* 管理员面板样式 */
        .admin-section {
            padding: 100px 0;
            background: linear-gradient(135deg, rgba(61, 43, 31, 0.03), rgba(217, 179, 130, 0.05));
            display: none;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .admin-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #ddd;
        }

        .admin-tab {
            padding: 12px 22px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            color: #555;
            border-bottom: 3px solid transparent;
            border-radius: 10px;
            background: rgba(74, 35, 90, 0.06);
        }

        .admin-tab.active {
            color: var(--admin-color);
            border-bottom: 3px solid var(--admin-color);
            background: rgba(74, 35, 90, 0.12);
            box-shadow: 0 4px 14px rgba(74, 35, 90, 0.12);
        }

        .admin-tab:hover {
            color: var(--admin-light);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(74, 35, 90, 0.10);
        }

        .admin-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            border: 1px solid rgba(140, 110, 84, 0.1);
        }

        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: var(--admin-color);
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            border-bottom: 2px solid rgba(74, 35, 90, 0.2);
            padding-bottom: 10px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--admin-light), var(--admin-color));
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .search-bar {
            display: flex;
            margin-bottom: 25px;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }
        .search-bar input:focus {
            border-color: var(--admin-color);
            box-shadow: 0 0 0 3px rgba(74, 35, 90, 0.15);
        }

        .search-bar button {
            background: linear-gradient(to right, var(--admin-light), var(--admin-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(74, 35, 90, 0.18);
        }

        .search-bar button:hover {
            background: linear-gradient(to right, var(--admin-color), var(--admin-light));
            transform: translateY(-2px);
            filter: brightness(1.05);
        }
        .search-bar button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(74, 35, 90, 0.16);
            filter: brightness(0.98);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .admin-table th,
        .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .admin-table th {
            background-color: rgba(74, 35, 90, 0.1);
            color: var(--admin-color);
            font-weight: 600;
        }

        .admin-table tr:hover {
            background-color: rgba(74, 35, 90, 0.05);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .edit-btn, .delete-btn, .save-btn, .cancel-btn {
            padding: 9px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 0.95rem;
            font-family: "Noto Serif SC", serif;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .edit-btn {
            background: linear-gradient(135deg, rgba(217, 179, 130, 0.35), rgba(217, 179, 130, 0.5));
            color: var(--secondary-color);
        }

        .delete-btn {
            background: linear-gradient(135deg, rgba(191, 67, 66, 0.35), rgba(191, 67, 66, 0.55));
            color: var(--highlight-color);
        }

        .save-btn {
            background: linear-gradient(135deg, rgba(74, 35, 90, 0.35), rgba(74, 35, 90, 0.55));
            color: var(--admin-color);
        }

        .cancel-btn {
            background: linear-gradient(135deg, rgba(102, 102, 102, 0.25), rgba(102, 102, 102, 0.35));
            color: #666;
        }

        .edit-btn:hover, .delete-btn:hover, .save-btn:hover, .cancel-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
        }
        .edit-btn:active, .delete-btn:active, .save-btn:active, .cancel-btn:active {
            transform: translateY(0);
            filter: brightness(0.98);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        }
        .edit-btn:focus, .delete-btn:focus, .save-btn:focus, .cancel-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 35, 90, 0.12);
        }

        .add-new-btn {
            background: linear-gradient(to right, var(--admin-light), var(--admin-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(74, 35, 90, 0.18);
        }

        .add-new-btn:hover {
            background: linear-gradient(to right, var(--admin-color), var(--admin-light));
            transform: translateY(-2px);
            filter: brightness(1.05);
            box-shadow: 0 6px 14px rgba(74, 35, 90, 0.22);
        }
        .add-new-btn:active {
            transform: translateY(0);
            filter: brightness(0.98);
            box-shadow: 0 3px 8px rgba(74, 35, 90, 0.18);
        }

        .admin-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(74, 35, 90, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(74, 35, 90, 0.1);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--admin-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--admin-color);
            box-shadow: 0 0 0 2px rgba(74, 35, 90, 0.2);
            outline: none;
        }

        .form-full-width {
            grid-column: 1 / -1;
        }

        .course-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--admin-light), var(--admin-color));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            min-width: 40px;
            text-align: right;
            font-size: 0.9rem;
            color: #666;
        }

        /* 弹窗样式 */
        .student-edit-modal, .group-edit-modal, .course-edit-modal, .public-class-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .student-edit-content, .group-edit-content, .course-edit-content, .public-class-edit-content {
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s;
        }

        .student-edit-title, .group-edit-title, .course-edit-title, .public-class-edit-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 30px;
            color: var(--admin-color);
        }

        .student-edit-form, .group-edit-form, .course-edit-form, .public-class-edit-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .student-edit-form .form-group, .group-edit-form .form-group, .course-edit-form .form-group, .public-class-edit-form .form-group {
            margin-bottom: 20px;
        }

        .student-edit-form .form-full-width, .group-edit-form .form-full-width, .course-edit-form .form-full-width, .public-class-edit-form .form-full-width {
            grid-column: 1 / -1;
        }

        .student-edit-actions, .group-edit-actions, .course-edit-actions, .public-class-edit-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        /* 我的课程页面样式 */
        .my-courses-section {
            padding: 100px 0;
            background: linear-gradient(135deg, rgba(61, 43, 31, 0.03), rgba(217, 179, 130, 0.05));
            display: none;
        }

        .courses-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .courses-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .course-stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(140, 110, 84, 0.1);
        }

        .course-stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .course-stat-label {
            color: #666;
            font-size: 1.1rem;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
        }

        .course-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            border: 1px solid rgba(140, 110, 84, 0.1);
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .course-image {
            height: 200px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            position: relative;
            overflow: hidden;
        }

        .course-image::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><path d="M0,50 Q25,25 50,50 T100,50" stroke="%23F5F1E8" fill="none" stroke-width="2"/></svg>');
        }

        .course-content {
            padding: 25px;
        }

        .course-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .course-progress-bar {
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .course-progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .course-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }

        .course-actions {
            display: flex;
            gap: 10px;
        }

        .continue-btn, .review-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
        }

        .continue-btn {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .review-btn {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .continue-btn:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
        }

        .review-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 20px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li {
                margin: 0 10px 10px;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
            }
            
            .courses-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .course-actions {
                flex-direction: column;
            }

            .admin-form {
                grid-template-columns: 1fr;
            }

            .student-edit-form, .group-edit-form, .course-edit-form, .public-class-edit-form {
                grid-template-columns: 1fr;
            }

            .admin-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* 修复英雄区域背景图片偏移问题 */
        .hero {
            position: relative;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--light-color);
            overflow: hidden;
        }
        
        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(61, 43, 31, 0.75), rgba(61, 43, 31, 0.85)), 
                url('https://images.unsplash.com/photo-1518839577686-2e50ed1d5b73?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') center/cover no-repeat;
            z-index: -1;
        }
        
        .hero::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400" opacity="0.05"><circle cx="200" cy="200" r="180" fill="none" stroke="%23F5F1E8" stroke-width="2"/><path d="M100,200 A100,100 0 1,1 300,200 A100,100 0 1,1 100,200" fill="none" stroke="%23F5F1E8" stroke-width="1"/><path d="M150,150 L250,250 M150,250 L250,150" stroke="%23F5F1E8" stroke-width="1"/><circle cx="150" cy="150" r="20" fill="none" stroke="%23F5F1E8" stroke-width="1"/><circle cx="250" cy="250" r="20" fill="none" stroke="%23F5F1E8" stroke-width="1"/></svg>'),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><path d="M0,50 Q25,25 50,50 T100,50" stroke="%23F5F1E8" fill="none" stroke-width="1"/></svg>');
            background-size: 40%, 100%;
            background-position: center, 0 0;
            background-repeat: no-repeat, repeat;
            z-index: 1;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            padding: 0 20px;
        }
        
        .hero-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 4.5rem;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
            letter-spacing: 2px;
        }
        
        .hero-subtitle {
            font-size: 1.6rem;
            margin-bottom: 40px;
            font-weight: 300;
            font-family: "Noto Serif SC", serif;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* 全屏滚动与分屏吸附 */
        html, body {
            height: 100%;
            scroll-behavior: smooth;
        }
        body {
            scroll-snap-type: y mandatory;
        }
        /* 吸附对齐（不强制拉满高度） */
        .hero, .teacher-section, .section#courses, .sponsor-section, .section#public-classes, .section, footer {
            scroll-snap-align: start;
            scroll-snap-stop: always;
        }
        /* 主要分屏的最小高度，保留少量留白 */
        .hero,
        .teacher-section,
        .section#courses,
        .sponsor-section,
        .section#public-classes {
            min-height: 92vh;
        }
        @media (max-width: 768px) {
            body { scroll-snap-type: y proximity; }
        }
        /* 轻量入场动效 */
        .hero-content, .teacher-container, #courseCardsContainer, .sponsor-container, #publicClassesScroll, .message-board, .footer-content {
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 600ms ease, transform 600ms ease;
            will-change: opacity, transform;
        }
        .hero.section-visible .hero-content,
        .teacher-section.section-visible .teacher-container,
        .section#courses.section-visible #courseCardsContainer,
        .sponsor-section.section-visible .sponsor-container,
        .section#public-classes.section-visible #publicClassesScroll,
        .section.section-visible .message-board,
        footer.section-visible .footer-content {
            opacity: 1;
            transform: none;
        }
        .hero-search {
            margin-bottom: 24px;
        }
        .hero-search .search-container {
            max-width: 720px;
        }
        .hero-search .search-box {
            background-color: rgba(255, 255, 255, 0.95);
        }
        .hero-search .search-button {
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.15);
        }
        
        .cta-button {
            display: inline-block;
            position: relative;
            background: linear-gradient(135deg, var(--accent-red), #9c2a1f);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 14px 28px;
            text-decoration: none;
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 1.2rem;
            letter-spacing: 2px;
            box-shadow: 0 4px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            overflow: hidden;
            font-weight: 500;
        }
        .cta-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="40" opacity="0.1"><path d="M0,20 Q25,5 50,20 T100,20" stroke="%23FFFFFF" stroke-width="2" fill="none"/></svg>');
            background-size: cover;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.4);
            background: linear-gradient(135deg, #b23a2b, #8c2417);
            color: white;
            border-color: transparent;
        }
        .cta-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        /* 搜索框样式 */
        .search-section {
            padding: 60px 0;
            background: linear-gradient(135deg, rgba(217, 179, 130, 0.1), rgba(140, 110, 84, 0.05));
            text-align: center;
        }
        
        .search-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: var(--dark-color);
        }
        
        .search-container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }
        
        .search-box {
            width: 100%;
            padding: 18px 25px;
            font-size: 1.1rem;
            border: 2px solid var(--primary-color);
            border-radius: 50px;
            background-color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            font-family: "Noto Serif SC", serif;
            outline: none;
        }
        
        .search-box:focus {
            border-color: var(--highlight-color);
            box-shadow: 0 5px 25px rgba(191, 67, 66, 0.2);
            transform: translateY(-2px);
        }
        
        .search-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease, background 0.3s ease;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            overflow: hidden;
            will-change: transform, box-shadow, filter;
        }
        
        /* 光扫效果 */
        .search-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -35%;
            width: 30%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.35) 50%, rgba(255,255,255,0.0) 100%);
            transform: skewX(-20deg);
            opacity: 0;
            pointer-events: none;
        }
        .search-button:hover::before {
            animation: search-shine 800ms ease;
        }
        
        /* 点击涟漪 */
        .search-button::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, rgba(255,255,255,0.75) 0%, rgba(255,255,255,0.4) 35%, rgba(255,255,255,0.0) 60%);
            transform: translate(-50%,-50%) scale(0);
            opacity: 0;
            pointer-events: none;
            border-radius: 50%;
            filter: blur(0.2px);
        }
        .search-button:active::after {
            animation: search-ripple 600ms ease-out forwards;
        }
        
        .search-button:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-50%) scale(1.06);
            box-shadow: 0 8px 20px rgba(191, 67, 66, 0.35), inset 0 1px 0 rgba(255,255,255,0.18);
            filter: saturate(1.08);
        }
        .search-button:active {
            transform: translateY(-50%) scale(0.97);
            box-shadow: 0 4px 12px rgba(191, 67, 66, 0.28), inset 0 2px 0 rgba(0,0,0,0.05);
            filter: saturate(1.0) brightness(0.98);
        }
        .search-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.6), 0 0 0 6px rgba(191,67,66,0.3);
        }
        
        @keyframes search-shine {
            0% { left: -35%; opacity: 0; }
            20% { opacity: 0.6; }
            100% { left: 135%; opacity: 0; }
        }
        @keyframes search-ripple {
            0% { opacity: 0.7; transform: translate(-50%,-50%) scale(0); }
            100% { opacity: 0; transform: translate(-50%,-50%) scale(14); }
        }
        
        .search-tags {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        
        .search-tag {
            background-color: rgba(140, 110, 84, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-tag:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* 讲师介绍区域 */
        .teacher-section {
            padding: 100px 0;
            background: linear-gradient(135deg, rgba(61, 43, 31, 0.03), rgba(217, 179, 130, 0.05));
            position: relative;
            overflow: hidden;
        }
        
        .teacher-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.02"><path d="M0,100 Q50,50 100,100 T200,100" stroke="%233D2B1F" stroke-width="1" fill="none"/></svg>'),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.015"><circle cx="50" cy="50" r="40" stroke="%233D2B1F" stroke-width="0.5" fill="none"/></svg>');
            background-size: 200px 200px, 100px 100px;
            background-position: 10% 20%, 90% 80%;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 0;
        }
        
        .teacher-container {
            position: relative;
            z-index: 2;
        }
        
        .teacher-content {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 50px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 40px;
            border: 1px solid rgba(140, 110, 84, 0.1);
        }
        
        .teacher-image {
            flex: 1;
            min-width: 300px;
            text-align: center;
            position: relative;
        }
        
        .teacher-portrait {
            width: 280px;
            height: 350px;
            background: linear-gradient(135deg, var(--dark-color), var(--primary-color));
            border-radius: 12px;
            position: relative;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .teacher-portrait::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.1"><path d="M0,0 L200,200 M200,0 L0,200" stroke="%23F5F1E8" stroke-width="1"/></svg>');
        }
        
        .teacher-portrait::after {
            content: "荡";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            color: rgba(255, 255, 255, 0.2);
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
        }
        
        .teacher-info {
            flex: 2;
            min-width: 300px;
        }
        
        .teacher-name {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 3rem;
            color: var(--dark-color);
            margin-bottom: 15px;
            position: relative;
            display: inline-block;
        }
        
        .teacher-name::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100px;
            height: 4px;
            background-color: var(--accent-color);
        }
        
        .teacher-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 600;
        }
        
        .teacher-quote {
            font-style: italic;
            font-size: 1.2rem;
            color: var(--dark-color);
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(217, 179, 130, 0.1);
            border-left: 4px solid var(--accent-color);
            border-radius: 0 8px 8px 0;
        }
        
        .teacher-bio {
            margin-bottom: 25px;
            line-height: 1.8;
        }
        
        .teacher-expertise {
            margin-bottom: 30px;
        }
        
        .expertise-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .expertise-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .expertise-item {
            background-color: var(--light-color);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.95rem;
            border: 1px solid rgba(140, 110, 84, 0.2);
        }
        
        .teacher-publication {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(191, 67, 66, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--highlight-color);
        }
        
        .publication-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        /* 卡片布局 - 古代铜币风格 */
        .section {
            padding: 100px 0;
            position: relative;
        }
        .section::before,
        .section::after {
            content: "";
            position: absolute;
            left: 5%;
            right: 5%;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-ochre), transparent);
            opacity: 0.4;
        }
        .section::before { top: 0; }
        .section::after { bottom: 0; }
        
        .section-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 3rem;
            text-align: center;
            margin-bottom: 60px;
            color: var(--dark-color);
            position: relative;
        }
        
        .section-title::after {
            content: "";
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--accent-red), transparent);
            opacity: 0.9;
        }
        .section-title::before {
            content: "";
            position: absolute;
            right: 12%;
            top: -6px;
            width: 10px;
            height: 10px;
            background: transparent;
            border-radius: 50%;
            border: 1px solid rgba(178,58,43,0.25);
            opacity: 0.12;
            transform: none;
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 40px;
            margin-top: 40px;
        }
        
        .card {
            position: relative;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(166, 116, 58, 0.2);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px solid rgba(166, 116, 58, 0.1);
            pointer-events: none;
            z-index: 1;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: rgba(166, 116, 58, 0.4);
        }
        
        .card-header {
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card.bronze .card-header {
            background: linear-gradient(135deg, var(--bronze-color), var(--bronze-dark));
        }
        
        .card.silver .card-header {
            background: linear-gradient(135deg, var(--silver-color), var(--silver-dark));
        }
        
        .card.gold .card-header {
            background: linear-gradient(135deg, var(--gold-color), var(--gold-dark));
        }
        
        .card-header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        
        .card-body {
            padding: 25px;
            position: relative;
        }
        
        .card-price {
            font-size: 2.2rem;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            font-family: "Noto Serif SC", serif;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .card.bronze .card-price {
            color: var(--bronze-dark);
        }
        
        .card.silver .card-price {
            color: var(--silver-dark);
        }
        
        .card.gold .card-price {
            color: var(--gold-dark);
        }
        
        .card-price::before, .card-price::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--divider-ink), transparent);
            opacity: 0.6;
        }
        
        .card-price::before {
            left: 10%;
        }
        
        .card-price::after {
            right: 10%;
        }
        
        .card-button {
            display: block;
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 20px;
            transition: all 0.3s;
            font-family: "Noto Serif SC", serif;
            cursor: pointer;
            border: none;
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 1px;
        }
        
        .card.bronze .card-button {
            background: linear-gradient(to right, var(--bronze-color), var(--bronze-dark));
        }
        
        .card.silver .card-button {
            background: linear-gradient(to right, var(--silver-color), var(--silver-dark));
        }
        
        .card.gold .card-button {
            background: linear-gradient(to right, var(--gold-color), var(--gold-dark));
        }
        
        .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .card.bronze .card-button:hover {
            background: linear-gradient(to right, var(--bronze-dark), var(--bronze-color));
        }
        
        .card.silver .card-button:hover {
            background: linear-gradient(to right, var(--silver-dark), var(--silver-color));
        }
        
        .card.gold .card-button:hover {
            background: linear-gradient(to right, var(--gold-dark), var(--gold-color));
        }
        
        /* 精选课程按钮：国风质感 + 触感强化（仅限精选课程区）*/
        section#courses .card-button {
            /* 国风青铜配色的立体渐变 */
            background: linear-gradient(135deg, var(--bronze-light) 0%, var(--bronze-color) 50%, var(--bronze-dark) 100%);
            /* 细边与倒角 */
            border: 1.5px solid rgba(140, 110, 84, 0.35);
            border-radius: 8px;
            /* 立体阴影：外部台阶 + 内部高光 */
            box-shadow:
                0 6px 0 rgba(85, 64, 48, 0.40),
                inset 0 1px 0 rgba(255, 255, 255, 0.25),
                0 0 0 1px rgba(217, 179, 130, 0.15);
            letter-spacing: 2px;
            text-shadow: 0 1px 0 rgba(0,0,0,0.20);
            position: relative;
            overflow: hidden;
        }
        /* 低调纹理覆盖，增强东方纹理气息 */
        section#courses .card-button::before {
            content: "";
            position: absolute;
            inset: 0;
            opacity: 0.06;
            pointer-events: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="40" opacity="0.06"><path d="M0,40 L120,0 M-30,40 L90,0 M30,40 L150,0" stroke="%23D9B382" stroke-width="2" stroke-linecap="round"/></svg>');
            background-size: cover;
        }
        /* 底部金色暗纹，呼应青铜质感 */
        section#courses .card-button::after {
            content: "";
            position: absolute;
            left: 0; right: 0; bottom: 0;
            height: 8px;
            opacity: 0.8;
            pointer-events: none;
            background: linear-gradient(to right, transparent, rgba(217, 179, 130, 0.5), transparent);
        }
        /* 悬停：微抬起 + 饱和度提升 + 光晕 */
        section#courses .card-button:hover {
            transform: translateY(-2px);
            filter: saturate(1.05);
            box-shadow:
                0 8px 0 rgba(85, 64, 48, 0.45),
                inset 0 1px 0 rgba(255, 255, 255, 0.28),
                0 0 0 1px rgba(217, 179, 130, 0.18),
                0 10px 18px rgba(85, 64, 48, 0.20);
            background: linear-gradient(135deg, var(--bronze-light) 5%, var(--bronze-color) 55%, var(--bronze-dark) 100%);
        }
        /* 按下：回弹，模拟真实按钮手感 */
        section#courses .card-button:active {
            transform: translateY(0px);
            box-shadow:
                0 3px 0 rgba(85, 64, 48, 0.40),
                inset 0 1px 0 rgba(255, 255, 255, 0.20),
                0 0 0 1px rgba(217, 179, 130, 0.15);
        }
        /* 防遮挡：精选课程区按钮与正文置于装饰层之上 */
        section#courses .card-body { position: relative; z-index: 3; }
        section#courses .card-button { position: relative; z-index: 4; }
        section#courses .coin-decoration { z-index: 1; }
         /* 精选课程：统一卡片高度并让按钮底对齐 */
         section#courses .card-container { grid-auto-rows: 1fr; }
         section#courses .card { height: 100%; display: flex; flex-direction: column; }
         section#courses .card-body { flex: 1; display: flex; flex-direction: column; }
         section#courses .card-button { margin-top: auto; }
         /* 铜币装饰元素 */
         .coin-decoration {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .coin-decoration::before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--light-color);
            border-radius: 50%;
            z-index: 1;
        }
        
        .card.bronze .coin-decoration {
            background: radial-gradient(circle, var(--bronze-light), var(--bronze-dark));
            border: 3px solid var(--bronze-dark);
        }
        
        .card.silver .coin-decoration {
            background: radial-gradient(circle, var(--silver-light), var(--silver-dark));
            border: 3px solid var(--silver-dark);
        }
        
        .card.gold .coin-decoration {
            background: radial-gradient(circle, var(--gold-light), var(--gold-dark));
            border: 3px solid var(--gold-dark);
        }
        
        .coin-top-left {
            top: -20px;
            left: -20px;
        }
        
        .coin-top-right {
            top: -20px;
            right: -20px;
        }
        
        .coin-bottom-left {
            bottom: -20px;
            left: -20px;
        }
        
        .coin-bottom-right {
            bottom: -20px;
            right: -20px;
        }
        
        .coin-text {
            position: absolute;
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--dark-color);
            text-align: center;
            width: 70%;
            line-height: 1.2;
        }
        
        .card.bronze .coin-text {
            color: var(--bronze-dark);
        }
        
        .card.silver .coin-text {
            color: var(--silver-dark);
        }
        
        .card.gold .coin-text {
            color: var(--gold-dark);
        }
        
        /* 赞助会员区域 */
        .sponsor-section {
            background: linear-gradient(135deg, rgba(61, 43, 31, 0.05), rgba(217, 179, 130, 0.05));
            padding: 100px 0;
            position: relative;
            overflow: hidden;
        }
        
        .sponsor-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.02"><path d="M0,100 Q50,50 100,100 T200,100" stroke="%233D2B1F" stroke-width="1" fill="none"/></svg>'),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.015"><circle cx="50" cy="50" r="40" stroke="%233D2B1F" stroke-width="0.5" fill="none"/></svg>');
            background-size: 200px 200px, 100px 100px;
            background-position: 10% 20%, 90% 80%;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 0;
        }
        
        .sponsor-container {
            position: relative;
            z-index: 2;
        }
        
        .sponsor-intro {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 60px;
            font-size: 1.2rem;
            line-height: 1.7;
            color: #555;
        }
        
        .river-progress {
            background-color: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 60px;
            border: 1px solid rgba(140, 110, 84, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .river-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark-color);
        }
        
        .river-container {
            height: 120px;
            background: linear-gradient(to bottom, #e6f2f2, #c2d6d6);
            border-radius: 60px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 40px 0;
        }
        
        .river-water {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80%;
            background: linear-gradient(to bottom, #4A8B8B, #5da0a0);
            border-radius: 60px 60px 0 0;
            animation: riverFlow 8s infinite linear;
        }
        
        .river-water::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 20px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.3));
            border-radius: 50%;
        }
        
        .river-water::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="20" viewBox="0 0 100 20"><path d="M0,10 Q25,5 50,10 T100,10" fill="none" stroke="%23FFFFFF" stroke-width="2" opacity="0.3"/></svg>') repeat-x;
            animation: waveMove 4s infinite linear;
        }
        
        .river-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            position: relative;
        }
        
        .river-marker {
            text-align: center;
            position: relative;
            flex: 1;
        }
        
        .river-marker::before {
            content: "";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 20px;
            background-color: var(--dark-color);
        }
        
        .river-marker:nth-child(1)::before { height: 10px; }
        .river-marker:nth-child(2)::before { height: 15px; }
        .river-marker:nth-child(3)::before { height: 20px; }
        .river-marker:nth-child(4)::before { height: 25px; }
        .river-marker:nth-child(5)::before { height: 30px; }
        
        .river-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .river-symbols {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .river-symbol {
            position: absolute;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            animation: float 6s infinite ease-in-out;
        }
        
        .river-symbol:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
        .river-symbol:nth-child(2) { top: 40%; left: 25%; animation-delay: 1s; }
        .river-symbol:nth-child(3) { top: 60%; left: 40%; animation-delay: 2s; }
        .river-symbol:nth-child(4) { top: 30%; left: 60%; animation-delay: 3s; }
        .river-symbol:nth-child(5) { top: 50%; left: 75%; animation-delay: 4s; }
        .river-symbol:nth-child(6) { top: 70%; left: 90%; animation-delay: 5s; }
        
        @keyframes riverFlow {
            0% { background-position: 0 0; }
            100% { background-position: 100px 0; }
        }
        
        @keyframes waveMove {
            0% { background-position: 0 0; }
            100% { background-position: 100px 0; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .sponsor-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .sponsor-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.4s;
            position: relative;
            border: 1px solid rgba(140, 110, 84, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sponsor-card.featured {
            transform: scale(1.05);
            border: 2px solid var(--accent-color);
            box-shadow: 0 12px 30px rgba(217, 179, 130, 0.2);
        }
        
        .sponsor-card.featured .sponsor-card-header {
            background: linear-gradient(135deg, var(--dark-color), var(--highlight-color));
        }
        
        .sponsor-card.featured .sponsor-badge {
            display: block;
        }
        
        .sponsor-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .sponsor-card.featured:hover {
            transform: scale(1.05) translateY(-10px);
        }
        
        /* 山脉样式 */
        .mountain-container {
            position: relative;
            height: 150px;
            overflow: hidden;
            background: linear-gradient(to bottom, #a8d1d1, #c2d6d6);
        }
        
        .small-mountain {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .small-mountain::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: 
                linear-gradient(75deg, transparent 30%, var(--mountain-color) 30%),
                linear-gradient(-75deg, var(--mountain-color) 70%, transparent 70%);
            clip-path: polygon(0% 100%, 20% 60%, 40% 80%, 60% 50%, 80% 70%, 100% 40%, 100% 100%);
        }
        
        .small-mountain::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: var(--mountain-light);
            clip-path: polygon(10% 100%, 30% 70%, 50% 90%, 70% 60%, 90% 80%, 100% 60%, 100% 100%);
            opacity: 0.7;
        }
        
        .large-mountain {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .large-mountain::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: 
                linear-gradient(70deg, transparent 25%, var(--mountain-dark) 25%),
                linear-gradient(-70deg, var(--mountain-dark) 75%, transparent 75%);
            clip-path: polygon(0% 100%, 15% 40%, 30% 70%, 45% 30%, 60% 60%, 75% 20%, 90% 50%, 100% 10%, 100% 100%);
        }
        
        .large-mountain::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: var(--mountain-color);
            clip-path: polygon(5% 100%, 20% 60%, 35% 80%, 50% 40%, 65% 70%, 80% 30%, 95% 60%, 100% 40%, 100% 100%);
            opacity: 0.8;
        }
        
        .large-mountain .mountain-peak {
            position: absolute;
            bottom: 80px;
            left: 75%;
            width: 30px;
            height: 30px;
            background: white;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .mountain-sun {
            position: absolute;
            top: 20px;
            right: 30px;
            width: 40px;
            height: 40px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 20px #FFD700, 0 0 40px rgba(255, 215, 0, 0.5);
            animation: sunPulse 3s infinite alternate;
        }
        
        @keyframes sunPulse {
            0% { transform: scale(1); box-shadow: 0 0 20px #FFD700, 0 0 40px rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1.1); box-shadow: 0 0 30px #FFD700, 0 0 60px rgba(255, 215, 0, 0.7); }
        }
        
        .sponsor-card-header {
            color: var(--light-color);
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .monthly-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .yearly-header {
            background: linear-gradient(135deg, var(--dark-color), var(--highlight-color));
        }
        
        .sponsor-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--highlight-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
        }
        
        .sponsor-card.featured .sponsor-badge {
            display: block;
        }
        
        .sponsor-card-body {
            padding: 25px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .sponsor-price {
            font-size: 2.5rem;
            color: var(--highlight-color);
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .sponsor-features {
            list-style: none;
            margin: 20px 0;
            flex-grow: 1;
        }
        
        .sponsor-features li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            padding-left: 30px;
        }
        
        .sponsor-features li:last-child {
            border-bottom: none;
        }
        
        .sponsor-features li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--highlight-color);
            font-weight: bold;
        }
        
        .yearly-features li::before {
            color: var(--highlight-color);
        }
        
        .sponsor-button {
            display: block;
            position: relative;
            background: linear-gradient(135deg, var(--accent-red), #9c2a1f);
            color: white;
            text-align: center;
            padding: 14px 28px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            cursor: pointer;
            border: none;
            font-size: 1.2rem;
            font-weight: 500;
            letter-spacing: 2px;
            overflow: hidden;
            box-shadow: 0 4px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        .sponsor-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="40" opacity="0.1"><path d="M0,20 Q25,5 50,20 T100,20" stroke="%23FFFFFF" stroke-width="2" fill="none"/></svg>');
            background-size: cover;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .yearly-button {
            background: linear-gradient(to right, var(--highlight-color), #d9534f);
        }
        
        .sponsor-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.4);
            background: linear-gradient(135deg, #b23a2b, #8c2417);
        }
        .sponsor-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .yearly-button:hover {
            background: linear-gradient(to right, #d9534f, var(--highlight-color));
        }
        
        /* 横向滑动组件 */
        .horizontal-scroll {
            overflow-x: auto;
            white-space: nowrap;
            padding: 30px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--light-color);
        }
        
        .horizontal-scroll::-webkit-scrollbar {
            height: 10px;
        }
        
        .horizontal-scroll::-webkit-scrollbar-track {
            background: var(--light-color);
            border-radius: 10px;
        }
        
        .horizontal-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
        }
        
        .scroll-item {
            display: inline-block;
            width: 320px;
            margin-right: 25px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            vertical-align: top;
            white-space: normal;
            transition: all 0.3s;
            border: 1px solid rgba(140, 110, 84, 0.1);
        }
        
        .scroll-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        
        .scroll-item:last-child {
            margin-right: 0;
        }
        
        /* 留言板 */
        .message-board {
            background-color: var(--light-color);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            margin-top: 40px;
            border: 1px solid rgba(140, 110, 84, 0.1);
        }
        
        .message-form {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            font-family: "Noto Serif SC", serif;
            color: var(--dark-color);
        }
        
        .form-group input,
        .form-group textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(140, 110, 84, 0.2);
            outline: none;
        }
        
        .submit-button {
            position: relative;
            background: linear-gradient(135deg, var(--accent-red), #9c2a1f);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-weight: 500;
            letter-spacing: 2px;
            overflow: hidden;
            box-shadow: 0 4px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        .submit-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="40" opacity="0.1"><path d="M0,20 Q25,5 50,20 T100,20" stroke="%23FFFFFF" stroke-width="2" fill="none"/></svg>');
            background-size: cover;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.4);
            background: linear-gradient(135deg, #b23a2b, #8c2417);
        }
        .submit-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        /* 感谢支持界面 */
        .thank-you-message {
            display: none;
            text-align: center;
            padding: 50px 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(140, 110, 84, 0.1);
        }
        
        .thank-you-icon {
            font-size: 5rem;
            color: var(--highlight-color);
            margin-bottom: 25px;
        }
        
        .thank-you-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .thank-you-text {
            font-size: 1.2rem;
            line-height: 1.7;
            max-width: 600px;
            margin: 0 auto;
            color: #555;
        }
        
        /* 夜间模式：留言板（降低亮度） */
        html[data-theme="dark"] .message-board {
            background-color: #111111;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: none;
            color: #eaeaea;
        }
        html[data-theme="dark"] .message-board .form-group label {
            color: rgba(255, 255, 255, 0.85);
        }
        html[data-theme="dark"] .message-board .form-group input,
        html[data-theme="dark"] .message-board .form-group textarea {
            background-color: #0d0d0d;
            color: #eeeeee;
            border-color: rgba(255, 255, 255, 0.14);
            box-shadow: none;
        }
        html[data-theme="dark"] .message-board .form-group input::placeholder,
        html[data-theme="dark"] .message-board .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.45);
        }
        html[data-theme="dark"] .message-board .form-group input:focus,
        html[data-theme="dark"] .message-board .form-group textarea:focus {
            border-color: rgba(217, 179, 130, 0.45);
            box-shadow: 0 0 0 2px rgba(217, 179, 130, 0.18);
            outline: none;
        }
        html[data-theme="dark"] .message-board .submit-button {
            background: linear-gradient(135deg, #5a1f1a, #441611);
            box-shadow: 0 2px 0 rgba(80, 20, 15, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        html[data-theme="dark"] .message-board .submit-button::before {
            opacity: 0.06;
        }
        html[data-theme="dark"] .message-board .submit-button:hover {
            background: linear-gradient(135deg, #6a271f, #3b130f);
            box-shadow: 0 3px 0 rgba(80, 20, 15, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        html[data-theme="dark"] .thank-you-message {
            background-color: #111111;
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: none;
        }
        html[data-theme="dark"] .thank-you-title {
            color: rgba(255, 255, 255, 0.92);
        }
        html[data-theme="dark"] .thank-you-text {
            color: rgba(255, 255, 255, 0.75);
        }
        
        /* 页脚 */
        footer {
            background: linear-gradient(135deg, var(--dark-color), #2a1e16);
            color: var(--light-color);
            padding: 40px 0 8px;
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.03"><path d="M0,0 L200,200 M200,0 L0,200" stroke="%23F5F1E8" stroke-width="1"/></svg>');
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 36px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }
        
        .footer-section h3 {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--accent-color);
            position: relative;
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            padding-bottom: 10px;
        }
        
        .footer-section h3::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 2px;
            background-color: var(--accent-color);
        }
        
        .footer-section p {
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-link {
            display: inline-block;
            width: 45px;
            height: 45px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            text-align: center;
            line-height: 45px;
            transition: all 0.3s;
            font-size: 1.2rem;
        }
        
        .social-link:hover {
            background-color: var(--accent-color);
            transform: translateY(-3px);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.95rem;
            color: #aaa;
            position: relative;
            z-index: 2;
            font-family: "Noto Serif SC", serif;
        }
        
        /* 联系导师弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            position: relative;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--dark-color);
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--highlight-color);
        }
        
        .modal-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .qq-info {
            margin: 25px 0;
            font-size: 1.8rem;
            color: var(--highlight-color);
            font-weight: bold;
            padding: 15px 25px;
            background-color: rgba(191, 67, 66, 0.1);
            border-radius: 8px;
            display: inline-block;
        }
        
        .contact-instructions {
            margin-top: 20px;
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        /* 会员登录弹窗样式 */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .login-content {
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            position: relative;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s;
        }
        
        .login-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark-color);
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
        }
        
        .login-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: "Noto Serif SC", serif;
            font-weight: 500;
            color: #666;
        }
        
        .login-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .login-tab:hover {
            color: var(--primary-color);
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(140, 110, 84, 0.2);
            outline: none;
        }
        
        /* 日间模式：提高密码输入可视性 */
        html:not([data-theme="dark"]) .login-content .form-group input[type="password"] {
            color: #222;
            background-color: #ffffff;
            caret-color: #222;
        }
        html:not([data-theme="dark"]) .login-content .form-group input[type="password"]::placeholder {
            color: #888;
        }
        /* 登录输入可视性（所有字段） */
        .login-content .form-group input {
            color: #222;
            background-color: #ffffff;
            caret-color: #222;
        }
        .login-content .form-group input::placeholder {
            color: #666;
        }
        /* 夜间模式下也保持登录输入高对比 */
        html[data-theme="dark"] .login-content .form-group input {
            background-color: #ffffff;
            color: #222;
        }
        html[data-theme="dark"] .login-content .form-group input::placeholder {
            color: #666;
        }
        /* 桌面端赞助码输入可视性 */
        #desktopVipActivationInput {
            color: #222;
            background-color: #ffffff;
            caret-color: #222;
        }
        #desktopVipActivationInput::placeholder {
            color: #666;
        }
        html[data-theme="dark"] #desktopVipActivationInput {
            background-color: #ffffff;
            color: #222;
        }
        html[data-theme="dark"] #desktopVipActivationInput::placeholder {
            color: #666;
        }
        /* 折扣激活码搜索输入可视性 */
        #discountCodeSearch {
            color: #222;
            background-color: #ffffff;
        }
        #discountCodeSearch::placeholder { color: #666; }
        html[data-theme="dark"] #discountCodeSearch {
            background-color: #161616;
            color: #eaeaea;
        }
        html[data-theme="dark"] #discountCodeSearch::placeholder { color: #bbbbbb; }
        
        .login-submit {
            width: 100%;
            position: relative;
            background: linear-gradient(135deg, var(--accent-red), #9c2a1f);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            font-weight: 500;
            margin-top: 10px;
            letter-spacing: 2px;
            overflow: hidden;
            box-shadow: 0 4px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        .login-submit::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="40" opacity="0.1"><path d="M0,20 Q25,5 50,20 T100,20" stroke="%23FFFFFF" stroke-width="2" fill="none"/></svg>');
            background-size: cover;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .login-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.4);
            background: linear-gradient(135deg, #b23a2b, #8c2417);
        }
        .login-submit:active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 rgba(120, 30, 20, 0.8), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .login-links {
            text-align: center;
            margin-top: 20px;
        }
        
        .login-links a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .login-links a:hover {
            text-decoration: none;
            position: relative;
        }
        .login-links a:hover::after {
            content: "";
            position: absolute;
            left: 50%;
            bottom: -2px;
            transform: translateX(-50%);
            width: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-navy), transparent);
            animation: ink-swell 0.8s forwards ease-out;
            opacity: 0.5;
        }
        @keyframes ink-swell {
            to { width: 90%; opacity: 0.8; }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 20px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li {
                margin: 0 10px 10px;
            }
            
            .hero-title {
                font-size: 2.8rem;
            }
            
            .hero-subtitle {
                font-size: 1.3rem;
            }
            
            .section-title {
                font-size: 2.2rem;
            }
            
            .teacher-content {
                flex-direction: column;
                padding: 25px;
            }
            
            .teacher-name {
                font-size: 2.5rem;
            }
            
            .teacher-portrait {
                width: 240px;
                height: 300px;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .sponsor-card.featured {
                transform: scale(1);
            }
            
            .sponsor-card.featured:hover {
                transform: translateY(-10px);
            }
            
            .sponsor-options {
                grid-template-columns: 1fr;
            }
            
            .river-container {
                height: 80px;
            }
            
            .river-markers {
                flex-wrap: wrap;
            }
            
            .river-marker {
                flex: 0 0 33.33%;
                margin-bottom: 15px;
            }
            
            .mountain-container {
                height: 120px;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .footer-section h3::after {
                left: 50%;
                transform: translateX(-50%);
            }
        }
        /* 中式表单元素 */
        .form-group input, .form-group textarea, .form-group select {
            border: 1px solid rgba(166, 116, 58, 0.3);
            border-radius: 4px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 2px rgba(178, 58, 43, 0.1);
            background: white;
        }

        /* 中式标签样式 */
        .expertise-item, .search-tag {
            background: rgba(166, 116, 58, 0.1);
            border: 1px solid rgba(166, 116, 58, 0.2);
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .expertise-item:hover, .search-tag:hover {
            background: rgba(166, 116, 58, 0.2);
            border-color: rgba(166, 116, 58, 0.4);
        }

        /* 中式进度条 */
        .progress-bar, .course-progress-bar {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill, .course-progress-fill {
            background: linear-gradient(to right, var(--accent-red), var(--accent-ochre));
            border-radius: 4px;
        }

        /* 中式页脚装饰 */
        footer { position: relative; }
        footer::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-color), transparent);
            opacity: 0.5;
        }

        /* 中式分隔线 */
        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-ochre), transparent);
            margin: 30px 0;
            opacity: 0.5;
        }

        /* 中式模态窗口 */
        .modal-content {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(166, 116, 58, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .modal-title {
            font-family: "Ma Shan Zheng", "STKaiti", "KaiTi", cursive;
            color: var(--dark-color);
            position: relative;
            display: inline-block;
            padding: 0 15px;
        }
        .modal-title::before, .modal-title::after {
            content: "•";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-red);
            font-size: 1.5rem;
            opacity: 0.7;
        }
        .modal-title::before { left: 0; }
        .modal-title::after { right: 0; }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .section-title::before, .section-title::after {
                font-size: 1rem;
            }
            .cta-button, .sponsor-button, .login-submit, .submit-button {
                padding: 12px 20px;
                font-size: 1.1rem;
            }
        }
        /* 按钮 - 中式现代缎面（更精致） */
        .cta-button, .sponsor-button, .submit-button, .login-submit {
            position: relative;
            background: linear-gradient(140deg, #b4372b, #992a21);
            color: #fff;
            border: 1px solid rgba(166, 116, 58, 0.22);
            border-radius: 12px;
            padding: 14px 24px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.35s ease, background 0.35s ease;
            letter-spacing: 0.8px;
            overflow: hidden;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12), 0 6px 18px rgba(178,58,43,0.18);
            -webkit-font-smoothing: antialiased;
            font-family: "Noto Serif SC", serif;
        }
        /* 顶部缎面高光 */
        .cta-button::before, .sponsor-button::before, .submit-button::before, .login-submit::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0.26), rgba(255,255,255,0.08) 40%, rgba(255,255,255,0) 65%);
            opacity: 0.22;
        }
        /* 斜向流光（悬停出现，轻柔丝滑） */
        .cta-button::after, .sponsor-button::after, .submit-button::after, .login-submit::after {
            content: "";
            position: absolute;
            top: 0; left: -60%;
            width: 50%; height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0.35), rgba(255,255,255,0.0) 60%);
            transform: skewX(-20deg);
            transition: transform 0.5s ease, left 0.5s ease, opacity 0.5s ease;
            opacity: 0;
            pointer-events: none;
        }
        .cta-button:hover::after, .sponsor-button:hover::after, .submit-button:hover::after, .login-submit:hover::after {
            left: 110%;
            opacity: 0.35;
        }
        /* 悬停与按压交互 */
        .cta-button:hover, .sponsor-button:hover, .submit-button:hover, .login-submit:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 26px rgba(0,0,0,0.14), 0 10px 24px rgba(178,58,43,0.22);
            background: linear-gradient(140deg, #c04234, #a12f25);
        }
        .cta-button:active, .sponsor-button:active, .submit-button:active, .login-submit:active {
            transform: translateY(0) scale(0.99);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12), 0 4px 12px rgba(178,58,43,0.18);
            background: linear-gradient(140deg, #9c2a21, #8a251d);
        }
        .cta-button:focus-visible, .sponsor-button:focus-visible, .submit-button:focus-visible, .login-submit:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(178,58,43,0.18), 0 10px 22px rgba(178,58,43,0.25);
        }
        /* 特例：CTA 胶囊更现代 */
        .cta-button { border-radius: 999px; padding: 14px 28px; }
        /* 保持登录提交按钮全宽 */
        .login-submit { width: 100%; }
        /* 禁用态（可选） */
        .cta-button[disabled], .sponsor-button[disabled], .submit-button[disabled], .login-submit[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(10%);
        }
        /* 首页探索课程按钮：镂空居中 + 荧光 */
        .hero .cta-button {
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            border-radius: 999px;
            padding: 14px 32px;
            display: block;
            width: fit-content;
            margin: 24px auto 0;
            box-shadow: none;
            letter-spacing: 1px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        /* 移除通用缎面高光，改用纯镂空 */
        .hero .cta-button::before {
            background: none;
            opacity: 0;
        }
        /* 悬停时斜向荧光扫过 */
        .hero .cta-button::after {
            content: "";
            position: absolute;
            top: 0; left: -60%;
            width: 50%; height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0.7), rgba(255,255,255,0) 60%);
            transform: skewX(-20deg);
            transition: transform 0.6s ease, left 0.6s ease, opacity 0.6s ease;
            opacity: 0;
            pointer-events: none;
        }
        .hero .cta-button:hover::after {
            left: 110%;
            opacity: 0.5;
        }
        .hero .cta-button:hover {
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 0 10px rgba(217, 179, 130, 0.6), 0 0 20px rgba(217, 179, 130, 0.4), 0 0 35px rgba(217, 179, 130, 0.25);
            text-shadow: 0 0 8px rgba(217, 179, 130, 0.8);
            border-color: var(--accent-color);
        }
        .hero .cta-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 0 8px rgba(217, 179, 130, 0.5), 0 0 18px rgba(217, 179, 130, 0.35);
        }
        .hero .cta-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(217, 179, 130, 0.35), 0 0 18px rgba(217, 179, 130, 0.35);
        }
        /* 首页课程卡片-立即购买按钮：现代极简（干净实心 + 微交互） */
        .card-button.purchase-btn {
            display: block;
            width: fit-content;
            margin: 16px auto 0;
            padding: 12px 24px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e44a3a 0%, #bf2e25 100%);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.12);
            font-weight: 600;
            letter-spacing: 0.6px;
            text-decoration: none;
            box-shadow: 0 10px 18px rgba(191, 46, 37, 0.25);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.25s ease, filter 0.25s ease, background 0.25s ease;
        }
        /* 移除伪元素扫光与纹样，保持干净现代 */
        .card-button.purchase-btn::before,
        .card-button.purchase-btn::after { content: none !important; }

        .card-button.purchase-btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.05);
            box-shadow: 0 12px 22px rgba(191, 46, 37, 0.28);
        }
        .card-button.purchase-btn:active {
            transform: translateY(0) scale(0.99);
            filter: brightness(0.95);
            box-shadow: 0 8px 16px rgba(191, 46, 37, 0.22);
        }
        .card-button.purchase-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(191, 46, 37, 0.25), 0 6px 16px rgba(191, 46, 37, 0.25);
        }
        .card-button.purchase-btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            filter: none;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 已移除全局粒子容器：保留语录横幅粒子效果 -->
    
    <!-- 头部导航 -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo" id="homeLogo">
                    <span class="logo-title">太玄文化</span>
                    <span class="logo-subtitle">TAI XUAN WEN HUA</span>
                </div>
                <nav>
                    <ul>
                        <li><a href="#home" id="homeLink">首页</a></li>
                        <li><a href="#teacher">讲师介绍</a></li>
                        <li><a href="#courses">课程</a></li>
                        <li><a href="#sponsor">会员赞助</a></li>
                        <li><a href="#public-classes">公众课</a></li>
                        <li><a href="#my-courses" id="myCoursesLink" style="display: none;">我的课程</a></li>
                        <li id="mailNavItem" style="position: relative; display: none;">
                            <a href="#" id="mailToggle">邮件</a>
                        </li>
                        <li><a href="#admin-panel" id="adminPanelLink" style="display: none;">管理面板</a></li>
                        <li><a href="#contact">联系</a></li>
                        <li>
                            <div id="authSection">
                                <button class="login-btn" id="loginBtn">会员登录</button>
                            </div>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>


    <!-- 学员编辑弹窗 -->
    <div class="student-edit-modal" id="studentEditModal">
        <div class="student-edit-content">
            <span class="close-btn" id="closeStudentEditModal">&times;</span>
            <h2 class="student-edit-title" id="studentEditTitle">编辑学员</h2>
            
            <form class="student-edit-form" id="studentEditForm">
                <div class="form-group">
                    <label for="editStudentName">学员姓名</label>
                    <input type="text" id="editStudentName" required>
                </div>
                <div class="form-group">
                    <label for="editStudentEmail">邮箱</label>
                    <input type="email" id="editStudentEmail" required>
                </div>
                <div class="form-group">
                    <label for="editStudentGroup">分组</label>
                    <select id="editStudentGroup" required>
                        <!-- 分组选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="editStudentJoinDate">加入日期</label>
                    <input type="date" id="editStudentJoinDate" required>
                </div>
                <div class="form-group">
                    <label for="editStudentProgress">学习进度 (%)</label>
                    <input type="number" id="editStudentProgress" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label for="editStudentStudyTime">学习时长 (小时)</label>
                    <input type="number" id="editStudentStudyTime" min="0" required>
                </div>
                <div class="form-group form-full-width">
                    <label for="editStudentCourses">已购课程</label>
                    <textarea id="editStudentCourses" rows="3" placeholder="请输入学员已购课程，用逗号分隔"></textarea>
                </div>
                <div class="form-group form-full-width">
                    <label>课程选择（勾选或手动输入）</label>
                    <div id="editStudentCoursesList"></div>
                </div>
                <div class="student-edit-actions">
                    <button type="submit" class="save-btn">保存更改</button>
                    <button type="button" class="cancel-btn" id="cancelStudentEdit">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 分组编辑弹窗 -->
    <div class="group-edit-modal" id="groupEditModal">
        <div class="group-edit-content">
            <span class="close-btn" id="closeGroupEditModal">&times;</span>
            <h2 class="group-edit-title" id="groupEditTitle">编辑分组</h2>
            
            <form class="group-edit-form" id="groupEditForm">
                <div class="form-group">
                    <label for="editGroupName">分组名称</label>
                    <input type="text" id="editGroupName" required>
                </div>
                <div class="form-group">
                    <label for="editGroupManager">负责人</label>
                    <input type="text" id="editGroupManager" required>
                </div>
                <div class="form-group">
                    <label for="editGroupLevel">班组级别</label>
                    <select id="editGroupLevel" required>
                        <option value="1">绿（低）</option>
                        <option value="2">黄（中）</option>
                        <option value="3">红（高）</option>
                        <option value="4">黑（最高）</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editGroupCreateDate">创建日期</label>
                    <input type="date" id="editGroupCreateDate" required>
                </div>
                <div class="form-group form-full-width">
                    <label for="editGroupDescription">分组描述</label>
                    <textarea id="editGroupDescription" rows="3" placeholder="请输入分组描述"></textarea>
                </div>
                <div class="group-edit-actions">
                    <button type="submit" class="save-btn">保存更改</button>
                    <button type="button" class="cancel-btn" id="cancelGroupEdit">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 课程编辑弹窗 -->
    <div class="course-edit-modal" id="courseEditModal">
        <div class="course-edit-content">
            <span class="close-btn" id="closeCourseEditModal">&times;</span>
            <h2 class="course-edit-title" id="courseEditTitle">编辑课程</h2>
            
            <form class="course-edit-form" id="courseEditForm">
                <div class="form-group">
                    <label for="editCourseName">课程名称</label>
                    <input type="text" id="editCourseName" required>
                </div>
                <div class="form-group">
                    <label for="editCourseCategory">课程分类</label>
                    <select id="editCourseCategory" required>
                        <option value="易经基础">易经基础</option>
                        <option value="命理预测">命理预测</option>
                        <option value="风水实践">风水实践</option>
                        <option value="占卜预测">占卜预测</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCourseInstructor">讲师</label>
                    <input type="text" id="editCourseInstructor" required>
                </div>
                <div class="form-group">
                    <label for="editCoursePrice">价格</label>
                    <input type="number" id="editCoursePrice" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editCourseLevel">课程等级</label>
                    <select id="editCourseLevel" required>
                        <option value="bronze">青铜</option>
                        <option value="silver">白银</option>
                        <option value="gold">黄金</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCourseDuration">课时数</label>
                    <input type="number" id="editCourseDuration" min="1" required>
                </div>
                <div class="form-group">
                    <label for="editCourseStudents">学员数</label>
                    <input type="number" id="editCourseStudents" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editCourseProgress">平均进度 (%)</label>
                    <input type="number" id="editCourseProgress" min="0" max="100" required>
                </div>
                <!-- 新增封面图URL字段 -->
                <div class="form-group form-full-width">
                    <label for="editCourseImageUrl">封面图URL</label>
                    <input type="text" id="editCourseImageUrl" placeholder="例如：https://example.com/cover.jpg">
                </div>
                <div class="form-group form-full-width">
                    <label for="editCourseDescription">课程描述</label>
                    <textarea id="editCourseDescription" rows="4" placeholder="请输入课程描述" required></textarea>
                </div>
                <div class="course-edit-actions">
                    <button type="submit" class="save-btn">保存更改</button>
                    <button type="button" class="cancel-btn" id="cancelCourseEdit">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 公众课编辑弹窗 -->
    <div class="public-class-edit-modal" id="publicClassEditModal">
        <div class="public-class-edit-content">
            <span class="close-btn" id="closePublicClassEditModal">&times;</span>
            <h2 class="public-class-edit-title" id="publicClassEditTitle">编辑公众课</h2>
            
            <form class="public-class-edit-form" id="publicClassEditForm">
                <div class="form-group">
                    <label for="editPublicClassName">课程标题</label>
                    <input type="text" id="editPublicClassName" required>
                </div>
                <div class="form-group">
                    <label for="editPublicClassTime">时间</label>
                    <input type="text" id="editPublicClassTime" placeholder="例如：每周三 20:00-21:30" required>
                </div>
                <div class="form-group">
                    <label for="editPublicClassPlatform">平台</label>
                    <input type="text" id="editPublicClassPlatform" placeholder="例如：腾讯会议" required>
                </div>
                <div class="form-group form-full-width">
                    <label for="editPublicClassDescription">课程描述</label>
                    <textarea id="editPublicClassDescription" rows="4" placeholder="请输入课程描述" required></textarea>
                </div>
                <div class="public-class-edit-actions">
                    <button type="submit" class="save-btn">保存更改</button>
                    <button type="button" class="cancel-btn" id="cancelPublicClassEdit">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 管理员面板 -->
    <section class="admin-section" id="admin-panel">
        <div class="container">
            <div class="admin-header">
                <h2 class="section-title">管理面板</h2>
                <p>最高权限管理界面 - 学员管理与课程分组</p>
            </div>

            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="students">学员管理</div>
                <div class="admin-tab" data-tab="courses">课程管理</div>
                <div class="admin-tab" data-tab="groups">分组管理</div>
                <div class="admin-tab" data-tab="public-classes">公众课管理</div>
                <div class="admin-tab" data-tab="whitelist">白名单</div>
                <div class="admin-tab" data-tab="messages">留言管理</div>
                <div class="admin-tab" data-tab="stats">数据统计</div>
                <div class="admin-tab" data-tab="user-stats">用户属性</div>
                <div class="admin-tab" data-tab="discount-codes">折扣激活码</div>
                <div class="admin-tab" data-tab="vip-codes">VIP赞助激活码</div>
                <div class="admin-tab" data-tab="diagnostics">云读写诊断</div>
            </div>

            <div class="admin-panel" id="students-panel">
                <h3 class="panel-title">学员管理</h3>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">总学员数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeStudents">0</div>
                        <div class="stat-label">活跃学员</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="newStudents">0</div>
                        <div class="stat-label">本月新增</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgProgress">0%</div>
                        <div class="stat-label">平均进度</div>
                    </div>
                </div>

                <div class="search-bar">
                    <input type="text" id="studentSearch" placeholder="搜索学员姓名、邮箱或分组...">
                    <button id="searchStudentBtn">搜索</button>
                </div>

                <button class="add-new-btn" id="addStudentBtn">添加新学员</button>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>邮箱</th>
                            <th>会员状态</th>
                            <th>分组</th>
                            <th>加入日期</th>
                            <th>学习进度</th>
                            <th>学习时长</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- 学员数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>

            <div class="admin-panel" id="courses-panel" style="display: none;">
                <h3 class="panel-title">课程管理</h3>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCourses">0</div>
                        <div class="stat-label">总课程数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudentsInCourses">0</div>
                        <div class="stat-label">总学员数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgCourseProgress">0%</div>
                        <div class="stat-label">平均进度</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalRevenue">¥0</div>
                        <div class="stat-label">总收入</div>
                    </div>
                </div>

                <div class="search-bar">
                    <input type="text" id="courseSearch" placeholder="搜索课程名称...">
                    <button id="searchCourseBtn">搜索</button>
                </div>

                <button class="add-new-btn" id="addCourseBtn">添加新课程</button>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>分类</th>
                            <th>讲师</th>
                            <th>价格</th>
                            <th>学员数</th>
                            <th>平均进度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="coursesTableBody">
                        <!-- 课程数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>

            <div class="admin-panel" id="groups-panel" style="display: none;">
                <h3 class="panel-title">分组管理</h3>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalGroups">0</div>
                        <div class="stat-label">总分组数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgGroupSize">0</div>
                        <div class="stat-label">平均人数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="largestGroup">0</div>
                        <div class="stat-label">最大分组</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ungroupedStudents">0</div>
                        <div class="stat-label">未分组学员</div>
                    </div>
                </div>

                <div class="search-bar">
                    <input type="text" id="groupSearch" placeholder="搜索分组名称...">
                    <button id="searchGroupBtn">搜索</button>
                </div>

                <button class="add-new-btn" id="addGroupBtn">添加新分组</button>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>分组名称</th>
                            <th>学员数量</th>
                            <th>创建日期</th>
                            <th>负责人</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="groupsTableBody">
                        <!-- 分组数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>

            <div class="admin-panel" id="public-classes-panel" style="display: none;">
                <h3 class="panel-title">公众课管理</h3>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPublicClasses">0</div>
                        <div class="stat-label">总公众课数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weeklyClasses">0</div>
                        <div class="stat-label">每周课程</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthlyClasses">0</div>
                        <div class="stat-label">每月课程</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAttendance">0</div>
                        <div class="stat-label">总参与人数</div>
                    </div>
                </div>

                <div class="search-bar">
                    <input type="text" id="publicClassSearch" placeholder="搜索公众课名称...">
                    <button id="searchPublicClassBtn">搜索</button>
                </div>

                <button class="add-new-btn" id="addPublicClassBtn">添加新公众课</button>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>课程标题</th>
                            <th>时间</th>
                            <th>平台</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="publicClassesTableBody">
                        <!-- 公众课数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>

            <div class="admin-panel" id="whitelist-panel" style="display: none;">
                <h3 class="panel-title">白名单与邀请码</h3>
                <div class="search-bar">
                    <input type="text" id="inviteCodeInput" placeholder="请输入邀请码内容">
                    <input type="number" id="inviteCodeMinutes" placeholder="有效分钟数（例如60）" min="1" value="60">
                    <button class="add-new-btn" id="createInviteCodeBtn" onclick="createLimitedInviteCode()">创建限时邀请码</button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>邀请码</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>过期时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="inviteCodesTableBody"></tbody>
                </table>

                <h3 class="panel-title" style="margin-top: 30px;">待审批会员</h3>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>邀请码</th>
                            <th>注册时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="pendingMembersTableBody"></tbody>
                </table>
            </div>

            <div class="admin-panel" id="messages-panel" style="display: none;">
            <h3 class="panel-title">留言管理</h3>

            <div class="action-bar">
                <div class="search-bar">
                    <input type="text" id="messagesSearch" placeholder="搜索留言（姓名或内容）">
                </div>
            </div>
            <div class="action-bar" style="margin-top: 10px;">
                <div class="search-bar">
                    <input type="text" id="announceTitleInput" placeholder="公告标题">
                    <input type="text" id="announceContentInput" placeholder="公告内容">
                    <button class="add-new-btn" id="publishAnnouncementBtn" onclick="publishAnnouncement()">发布公告</button>
                </div>
            </div>

            <h3 class="panel-title" style="margin-top: 10px;">公告管理</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>标题</th>
                        <th>内容</th>
                        <th>时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="announcementsTableBody"></tbody>
            </table>

            <table class="admin-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>留言内容</th>
                        <th>时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="messagesTableBody"></tbody>
            </table>
        </div>

        <div class="admin-panel" id="stats-panel" style="display: none;">
                <h3 class="panel-title">数据统计</h3>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="statsTotalRevenue">¥0</div>
                        <div class="stat-label">总收入</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthlyRevenue">¥0</div>
                        <div class="stat-label">本月收入</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="courseCompletion">0%</div>
                        <div class="stat-label">课程完成率</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeRate">0%</div>
                        <div class="stat-label">学员活跃率</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px;">
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.08);">
                        <h4 style="margin-bottom: 20px; color: var(--admin-color);">热门课程</h4>
                        <div id="popularCourses">
                            <!-- 热门课程数据将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.08);">
                        <h4 style="margin-bottom: 20px; color: var(--admin-color);">分组分布</h4>
                        <div id="groupDistribution">
                            <!-- 分组分布数据将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-panel" id="user-stats-panel" style="display: none;">
                <h3 class="panel-title">用户属性</h3>
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="currentLevel">Lv0</div>
                        <div class="stat-label">当前等级</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="currentCoins">0</div>
                        <div class="stat-label">当前铜币</div>
                    </div>
                </div>
                <div id="levelProgressWrapper" style="margin-top: 10px;">
                    <div class="line"><span class="label">经验值</span><span class="value" id="currentProgressLabel">0/0</span></div>
                    <div class="user-progress"><div class="user-progress-bar" id="currentProgressBar" style="width: 0%;"></div></div>
                </div>
                <div class="search-bar" style="margin-top:20px;">
                    <input type="text" id="statsTarget" placeholder="请输入要修改的用户名或邮箱（留空为当前登录用户）">
                </div>
                <div class="admin-form" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="statsLevel">等级 (1-6)</label>
                        <input type="number" id="statsLevel" min="1" max="6" required>
                    </div>
                    <div class="form-group">
                        <label for="statsXp">经验 (>=0)</label>
                        <input type="number" id="statsXp" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="statsCoins">铜币 (>=0)</label>
                        <input type="number" id="statsCoins" min="0" required>
                    </div>
                </div>
                <div class="public-class-edit-actions" style="margin-top: 10px;">
                    <button class="save-btn" id="saveUserStatsBtn">保存</button>
                </div>
                <p style="margin-top:10px;color:#666;">提示：留空目标将直接修改当前登录用户并实时生效；填写用户名或邮箱将仅在该用户本地可用。</p>
            </div>
        </div>
    <div class="admin-panel" id="discount-codes-panel" style="display: none;">
        <h3 class="panel-title">折扣激活码审批</h3>
        <div class="search-bar">
            <input type="text" id="discountCodeSearch" placeholder="搜索激活码/学员/课程...">
            <button id="searchDiscountCodeBtn">搜索</button>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>激活码</th>
                    <th>学员</th>
                    <th>邮箱</th>
                    <th>课程</th>
                    <th>原价</th>
                    <th>折扣</th>
                    <th>铜币</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="discountCodesTableBody"></tbody>
        </table>
    </div>

    <!-- VIP赞助激活码面板 -->
    <div class="admin-panel" id="vip-codes-panel" style="display: none;">
        <h3 class="panel-title">VIP赞助激活码管理</h3>
        <div class="search-bar">
            <button class="add-new-btn" id="desktopVipNewMonthlyBtn">生成月度VIP激活码</button>
            <button class="add-new-btn" id="desktopVipNewYearlyBtn" style="margin-left:8px;">生成年度VIP激活码</button>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>激活码</th>
                    <th>类型</th>
                    <th>状态</th>
                    <th>发放给</th>
                    <th>使用者</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="vipCodesTableBodyDesktop">
                <tr id="vipCodesEmptyDesktop"><td colspan="7">暂无激活码</td></tr>
            </tbody>
        </table>
    </div>

    <div class="admin-panel" id="diagnostics-panel" style="display: none;">
        <h3 class="panel-title">云读写诊断</h3>
        <div id="supabase-diagnostics-content" style="font-size: 12px; background: #f6ffed; border: 1px solid #b7eb8f; color: #135200; padding: 8px 12px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.06);">初始化中…</div>
        <p style="margin-top:8px;color:#666;font-size:12px;">仅管理员可见；内容每秒刷新，持续 10 秒。</p>
    </div>

    </section>

    <!-- 我的课程页面 -->
    <section class="my-courses-section" id="my-courses">
        <div class="container">
            <div class="courses-header">
                <h2 class="section-title">我的课程</h2>
                <p>在这里查看您的学习进度和课程详情</p>
                <div class="user-group-info">所在班组：<span id="userGroupName">未分组</span></div>
            </div>

            <div class="courses-stats">
                <div class="course-stat-card">
                    <div class="course-stat-number" id="totalUserCourses">0</div>
                    <div class="course-stat-label">总课程数</div>
                </div>
                <div class="course-stat-card">
                    <div class="course-stat-number" id="completedUserCourses">0</div>
                    <div class="course-stat-label">已完成课程</div>
                </div>
                <div class="course-stat-card">
                    <div class="course-stat-number" id="totalUserProgress">0%</div>
                    <div class="course-stat-label">总体进度</div>
                </div>
                <div class="course-stat-card">
                    <div class="course-stat-number" id="userStudyTime">0</div>
                    <div class="course-stat-label">学习时长(小时)</div>
                </div>
            </div>

            <div class="courses-grid" id="coursesGrid">
                <!-- 课程卡片将通过JavaScript动态生成 -->
            </div>
        </div>
    </section>

    <!-- 英雄区域 - 已修复背景偏移问题 -->
    <section class="hero" id="home">
        <div class="hero-background"></div>
        <canvas id="hero-quotes-canvas" class="quotes-canvas"></canvas>
        <div class="hero-content">
            <div class="hero-search">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="输入课程名称、关键词或讲师姓名...">
                    <button class="search-button">搜索</button>
                </div>
            </div>
            <h1 class="hero-title">太玄文化</h1>
            <p class="hero-subtitle">探索玄学奥秘，传承千年智慧，开启人生新境界</p>
            <a href="#courses" class="cta-button">探索课程</a>
        </div>
    </section>

    <!-- 搜索课程栏已移至英雄区域顶部，原区块移除以避免重复显示 -->

    <!-- 语录展示模块已移至课程下方 -->

    <!-- 讲师介绍区域 -->
    <section class="teacher-section" id="teacher">
        <div class="container teacher-container">
            <h2 class="section-title">讲师介绍</h2>
            <div class="teacher-content">
                <div class="teacher-image">
                    <div class="teacher-portrait"></div>
                </div>
                <div class="teacher-info">
                    <h2 class="teacher-name">荡气</h2>
                    <p class="teacher-title">太玄文化创始人 · 易学研究者</p>
                    
                    <blockquote class="teacher-quote">
                        "荡者阴阳气也，阴阳气气而叠生四象也"
                    </blockquote>
                    
                    <div class="teacher-bio">
                        <p>荡气讲师自幼受家族乡老启蒙，研习黄老之学，对传统文化有深厚情感。自习易数载至今已有五年，期间深入研究各家易学，包括梅花易数、京氏易等。在广泛涉猎的基础上，逐渐领悟到"用少而精"的治学之道，专注于深入研究少数核心领域，追求精专而非泛泛。</p>
                    </div>
                    
                    <div class="teacher-expertise">
                        <h3 class="expertise-title">专长领域</h3>
                        <div class="expertise-list">
                            <div class="expertise-item">太乙神数</div>
                            <div class="expertise-item">太玄数</div>
                            <div class="expertise-item">易经哲学</div>
                            <div class="expertise-item">黄老之学</div>
                            <div class="expertise-item">梅花易数</div>
                            <div class="expertise-item">京氏易学</div>
                        </div>
                    </div>
                    
                    <div class="teacher-publication">
                        <h3 class="publication-title">著作成果</h3>
                        <p>荡气讲师潜心研究，著有《太玄入门》一篇，系统梳理太玄数理论基础，为初学者提供清晰的学习路径，深受学员好评。</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 课程区域 - 古代铜币风格 -->
    <section class="section" id="courses">
        <div class="container">
            <h2 class="section-title">精选课程</h2>
            <div class="card-container" id="courseCardsContainer">
                <!-- 课程卡片将通过JavaScript动态生成 -->
            </div>
        </div>
    </section>

    <!-- 语录展示模块（移至课程下方） -->
    <section class="section" id="quotes">
        <!-- 粒子画布移除：提词器不显示粒子效果 -->
        <!-- 语录相关HTML -->
        <div class="quote-container">
            <div class="quote" id="quote">上善若水，水善利万物而不争</div>
            <div class="quote-author" id="quote-author">——《道德经》第八章</div>
        </div>

        <style>
             /* 语录背景样式（黑色背景移除） */
             section#quotes {
                 position: relative;
                 padding: 16px 0;
                 background: transparent; /* 无背景 */
             }
             section#quotes::before { content: none; }
 
             /* 语录相关样式 */
             .quote-container {
                 position: relative;
                 z-index: 2;
                 height: auto;
                 min-height: 180px;
                 max-width: 960px;
                 margin: 0 auto;
                 display: flex;
                 flex-direction: column;
                 justify-content: center;
                 align-items: center;
                 text-align: center;
                 padding: 16px 20px;
             }
             .quotes-canvas {
                 position: absolute;
                 top: 0; left: 0;
                 width: 100%; height: 100%;
                 z-index: 1;
                 pointer-events: none;
             }
            .quote {
                font-family: 'Ma Shan Zheng', cursive;
                font-size: clamp(1.4rem, 2.6vw, 2.2rem);
                color: #FFD700;
                margin-bottom: 1rem;
                text-shadow: 0 0 12px rgba(255, 215, 0, 0.35);
                transition: opacity 1s ease-in-out, transform 1s ease-in-out;
                will-change: opacity, transform;
                max-width: 80%;
            }
            .quote-author {
                font-family: 'Noto Serif SC', serif;
                font-size: clamp(0.9rem, 1.6vw, 1.2rem);
                color: rgba(255, 215, 0, 0.9);
                margin-top: 0.5rem;
                text-shadow: 0 0 8px rgba(255, 215, 0, 0.25);
                transition: opacity 1s ease-in-out;
                will-change: opacity;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .quote, .quote-author { animation: fadeIn 1.5s ease-out forwards; }
        </style>

        <script>
            (function(){
                // 语录轮播
                const taoistQuotes = [
                    { text: "上善若水，水善利万物而不争", author: "——《道德经》第八章" },
                    { text: "人法地，地法天，天法道，道法自然", author: "——《道德经》第二十五章" },
                    { text: "道生一，一生二，二生三，三生万物", author: "——《道德经》第四十二章" },
                    { text: "天地不仁，以万物为刍狗", author: "——《道德经》第五章" },
                    { text: "祸兮福之所倚，福兮祸之所伏", author: "——《道德经》第五十八章" },
                    { text: "千里之行，始于足下", author: "——《道德经》第六十四章" },
                    { text: "知足者富，强行者有志", author: "——《道德经》第三十三章" },
                    { text: "大直若屈，大巧若拙，大辩若讷", author: "——《道德经》第四十五章" },
                    { text: "反者道之动，弱者道之用", author: "——《道德经》第四十章" },
                    { text: "治大国，若烹小鲜", author: "——《道德经》第六十章" },
                    { text: "知者不言，言者不知", author: "——《道德经》第五十六章" },
                    { text: "为学日益，为道日损", author: "——《道德经》第四十八章" }
                ];
                const quoteElement = document.getElementById('quote');
                const quoteAuthorElement = document.getElementById('quote-author');
                if (quoteElement && quoteAuthorElement) {
                    function fadeQuote(){
                        quoteElement.style.opacity = '0';
                        quoteElement.style.transform = 'translateY(20px)';
                        quoteAuthorElement.style.opacity = '0';
                        setTimeout(()=>{
                            const idx = Math.floor(Math.random() * taoistQuotes.length);
                            const q = taoistQuotes[idx];
                            quoteElement.textContent = q.text;
                            quoteAuthorElement.textContent = q.author;
                            quoteElement.style.opacity = '1';
                            quoteElement.style.transform = 'translateY(0)';
                            quoteAuthorElement.style.opacity = '1';
                        }, 1000);
                    }
                    setInterval(fadeQuote, 8000);
                }

                // 粒子效果初始化函数（复用于 quotes 与 hero）
                function initBanner(sectionId, canvasId) {
                    const bannerCanvas = document.getElementById(canvasId);
                    const bannerSection = document.getElementById(sectionId);
                    if (!bannerCanvas || !bannerSection) return;
                    const ctx = bannerCanvas.getContext('2d');
                    const dpr = Math.min(2, window.devicePixelRatio || 1);
                    let w = 0, h = 0;
                    function resizeBanner() {
                        const rect = bannerSection.getBoundingClientRect();
                        const nw = Math.max(1, Math.floor(rect.width));
                        const nh = Math.max(1, Math.floor(rect.height));
                        if (nw === w && nh === h) return;
                        w = nw; h = nh;
                        bannerCanvas.width = Math.floor(w * dpr);
                        bannerCanvas.height = Math.floor(h * dpr);
                        bannerCanvas.style.width = w + 'px';
                        bannerCanvas.style.height = h + 'px';
                    }
                    resizeBanner();
                    const resizeBannerDebounced = (() => { let t; return () => { clearTimeout(t); t = setTimeout(resizeBanner, 120); }; })();
                    window.addEventListener('resize', resizeBannerDebounced);

                    const mouse = { x: -9999, y: -9999 };
                    bannerSection.addEventListener('mousemove', (e) => {
                        const rect = bannerSection.getBoundingClientRect();
                        mouse.x = (e.clientX - rect.left) * dpr;
                        mouse.y = (e.clientY - rect.top) * dpr;
                    });
                    bannerSection.addEventListener('mouseleave', () => { mouse.x = -9999; mouse.y = -9999; });

                    const particles = [];
                    function createParticles() {
                        particles.length = 0;
                        const count = Math.max(40, Math.floor(w / 22));
                        for (let i = 0; i < count; i++) {
                            const phase = Math.random() * Math.PI * 2;
                            const alpha = 0.3 + Math.random() * 0.5;
                            particles.push({
                                x: Math.random() * w * dpr,
                                y: Math.random() * h * dpr,
                                baseY: Math.random() * h * dpr,
                                speed: (0.4 + Math.random() * 0.8) * dpr,
                                size: (0.6 + Math.random() * 1.4) * dpr,
                                phase,
                                sinPhase: Math.sin(phase),
                                cosPhase: Math.cos(phase),
                                amp: (2 + Math.random() * 8) * dpr,
                                alpha,
                                fillStyle: `rgba(255,215,0,${alpha})`
                            });
                        }
                    }
                    createParticles();

                    const glyphs = ['道','玄','太','易','德','气','无','有','☯'];
                    const runes = [];
                    function spawnRune() {
                        const size = (12 + Math.random() * 10) * dpr;
                        runes.push({
                            char: glyphs[Math.floor(Math.random() * glyphs.length)],
                            x: -20 * dpr,
                            y: Math.random() * h * dpr,
                            vx: (0.6 + Math.random() * 1.2) * dpr,
                            rot: (Math.random() * 0.1 - 0.05),
                            alpha: 0,
                            life: 0,
                            size,
                            font: `${size}px "Ma Shan Zheng","Noto Serif SC",serif`
                        });
                    }
                    let lastSpawn = performance.now();
                    for (let i = 0; i < 3; i++) spawnRune();

                    const threshold = 70 * dpr;
                    const thresholdSq = threshold * threshold;
                    const mouseBoostRadius = 80 * dpr;
                    const delta = 0.02;
                    const cosDelta = Math.cos(delta);
                    const sinDelta = Math.sin(delta);
                    const boostRadiusSq = mouseBoostRadius * mouseBoostRadius;
                    let bannerActive = true;
                    let pageVisible = true;
                    const bannerObserver = new IntersectionObserver((entries) => {
                        bannerActive = entries[0].isIntersecting;
                    }, { threshold: 0.01 });
                    bannerObserver.observe(bannerSection);
                    document.addEventListener('visibilitychange', () => {
                        pageVisible = document.visibilityState === 'visible';
                    });

                    function drawBanner() {
                        ctx.clearRect(0, 0, bannerCanvas.width, bannerCanvas.height);
                        ctx.save();
                        ctx.globalCompositeOperation = 'lighter';
                        if (!bannerActive || !pageVisible) { ctx.restore(); requestAnimationFrame(drawBanner); return; }

                        ctx.shadowColor = 'rgba(255,215,0,0.6)';
                        ctx.shadowBlur = 6 * dpr;
                        for (let i = 0, len = particles.length; i < len; i++) {
                            const p = particles[i];
                            const sinNew = p.sinPhase * cosDelta + p.cosPhase * sinDelta;
                            const cosNew = p.cosPhase * cosDelta - p.sinPhase * sinDelta;
                            p.sinPhase = sinNew;
                            p.cosPhase = cosNew;
                            p.y = p.baseY + sinNew * p.amp;
                            p.x += p.speed;
                            if (p.x > bannerCanvas.width + 20 * dpr) { p.x = -20 * dpr; p.baseY = Math.random() * h * dpr; }
                            let boost = 1.0;
                            if (mouse.x !== -9999) {
                                const dx = p.x - mouse.x;
                                const dy = p.y - mouse.y;
                                const distSq = dx*dx + dy*dy;
                                if (distSq < boostRadiusSq) boost = 1.8;
                            }
                            ctx.beginPath();
                            ctx.fillStyle = p.fillStyle;
                            ctx.arc(p.x, p.y, p.size * boost, 0, Math.PI * 2);
                            ctx.fill();
                        }

                        ctx.lineWidth = 0.6 * dpr;
                        const cellSize = threshold;
                        const cols = Math.ceil(bannerCanvas.width / cellSize);
                        const rows = Math.ceil(bannerCanvas.height / cellSize);
                        const grid = Array.from({ length: cols * rows }, () => []);
                        for (let i = 0, len = particles.length; i < len; i++) {
                            const p = particles[i];
                            const cx = Math.max(0, Math.min(cols - 1, Math.floor(p.x / cellSize)));
                            const cy = Math.max(0, Math.min(rows - 1, Math.floor(p.y / cellSize)));
                            grid[cy * cols + cx].push(i);
                        }
                        for (let i = 0, len = particles.length; i < len; i++) {
                            const p = particles[i];
                            const cx = Math.max(0, Math.min(cols - 1, Math.floor(p.x / cellSize)));
                            const cy = Math.max(0, Math.min(rows - 1, Math.floor(p.y / cellSize)));
                            for (let oy = -1; oy <= 1; oy++) {
                                const ny = cy + oy; if (ny < 0 || ny >= rows) continue;
                                for (let ox = -1; ox <= 1; ox++) {
                                    const nx = cx + ox; if (nx < 0 || nx >= cols) continue;
                                    const bucket = grid[ny * cols + nx];
                                    for (let k = 0; k < bucket.length; k++) {
                                        const j = bucket[k]; if (j <= i) continue;
                                        const q = particles[j];
                                        const dx = p.x - q.x;
                                        const dy = p.y - q.y;
                                        const distSq = dx*dx + dy*dy;
                                        if (distSq < thresholdSq) {
                                            const d = Math.sqrt(distSq);
                                            const a = (1 - d / threshold) * 0.25;
                                            ctx.strokeStyle = `rgba(255,215,0,${a})`;
                                            ctx.beginPath();
                                            ctx.moveTo(p.x, p.y);
                                            ctx.lineTo(q.x, q.y);
                                            ctx.stroke();
                                        }
                                    }
                                }
                            }
                        }

                        for (let i = runes.length - 1; i >= 0; i--) {
                            const r = runes[i];
                            r.life += 1;
                            r.alpha = Math.min(1, r.life / 40);
                            r.x += r.vx;
                            ctx.save();
                            ctx.translate(r.x, r.y);
                            ctx.rotate(r.rot);
                            ctx.font = r.font;
                            ctx.fillStyle = `rgba(255,215,0,${0.65 * r.alpha})`;
                            ctx.shadowColor = 'rgba(255,215,0,0.5)';
                            ctx.shadowBlur = 6 * dpr;
                            ctx.fillText(r.char, 0, 0);
                            ctx.restore();
                            if (r.x > bannerCanvas.width + 30 * dpr) { runes.splice(i, 1); }
                        }
                        // 符文生成节流：每隔2.5秒生成一个
                        const now = performance.now();
                        if (bannerActive && pageVisible && (now - lastSpawn) >= 2500) {
                            spawnRune();
                            lastSpawn = now;
                        }
                        ctx.restore();
                        requestAnimationFrame(drawBanner);
                    }
                    requestAnimationFrame(drawBanner);
                }

                // 仅在首页英雄区启用
                if (document.getElementById('home') && document.getElementById('hero-quotes-canvas')) {
                    initBanner('home','hero-quotes-canvas');
                }
            })();
        </script>
    </section>

    <!-- 赞助会员区域 -->
    <section class="sponsor-section" id="sponsor">
        <div class="container sponsor-container">
            <h2 class="section-title">会员赞助计划</h2>
            <p class="sponsor-intro">加入太玄文化会员，支持传统文化传承，享受专属权益，与我们一起探索玄学奥秘，开启智慧人生。</p>
            
            <div class="river-progress">
                <h3 class="river-title">赞助河流</h3>
                <p style="text-align: center; margin-bottom: 20px; color: #666;">每一份支持都如涓涓细流，汇聚成河，滋养传统文化的传承与发展</p>
                
                <div class="river-container">
                    <div class="river-water">
                        <div class="river-symbols">
                            <div class="river-symbol">☯</div>
                            <div class="river-symbol">☰</div>
                            <div class="river-symbol">☷</div>
                            <div class="river-symbol">☲</div>
                            <div class="river-symbol">☵</div>
                            <div class="river-symbol">☴</div>
                        </div>
                    </div>
                </div>
                
                <div class="river-markers">
                    <div class="river-marker">
                        <div class="river-label">初始</div>
                    </div>
                    <div class="river-marker">
                        <div class="river-label">成长</div>
                    </div>
                    <div class="river-marker">
                        <div class="river-label">发展</div>
                    </div>
                    <div class="river-marker">
                        <div class="river-label">繁荣</div>
                    </div>
                    <div class="river-marker">
                        <div class="river-label">鼎盛</div>
                    </div>
                </div>
            </div>
            
            <div class="sponsor-options">
                <div class="sponsor-card">
                    <div class="mountain-container">
                        <div class="small-mountain"></div>
                    </div>
                    <div class="sponsor-card-header monthly-header">
                        <h3>月度赞助</h3>
                        <div class="sponsor-badge">推荐</div>
                    </div>
                    <div class="sponsor-card-body">
                        <div class="sponsor-price">¥68<span style="font-size: 1rem;">/月</span></div>
                        <ul class="sponsor-features">
                            <li>月度会员专属内容</li>
                            <li>参与线上交流活动</li>
                            <li>每月一次答疑机会</li>
                            <li>最新课程资讯优先获取</li>
                            <li>会员专属社区访问权</li>
                        </ul>
                        <button class="sponsor-button purchase-btn" data-product="月度赞助">立即赞助</button>
                    </div>
                </div>
                
                <div class="sponsor-card featured">
                    <div class="mountain-container">
                        <div class="large-mountain">
                            <div class="mountain-peak"></div>
                            <div class="mountain-sun"></div>
                        </div>
                    </div>
                    <div class="sponsor-card-header yearly-header">
                        <h3>年度会员</h3>
                        <div class="sponsor-badge">超值</div>
                    </div>
                    <div class="sponsor-card-body">
                        <div class="sponsor-price">¥699<span style="font-size: 1rem;">/年</span></div>
                        <ul class="sponsor-features yearly-features">
                            <li>全年会员专属内容</li>
                            <li>免费参与所有公开课</li>
                            <li>优先答疑权</li>
                            <li>会员专属礼品</li>
                            <li>个性化咨询服务8折</li>
                            <li>年度会员专属证书</li>
                            <li>新品课程优先体验权</li>
                            <li>专属年度总结报告</li>
                        </ul>
                        <button class="sponsor-button yearly-button purchase-btn" data-product="年度会员">立即赞助</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 公众课日程 -->
    <section class="section" id="public-classes">
        <div class="container">
            <h2 class="section-title">公众课日程</h2>
            <div class="horizontal-scroll" id="publicClassesScroll">
                <!-- 公众课卡片将通过JavaScript动态生成 -->
            </div>
        </div>
    </section>

    <!-- 留言板 -->
    <section class="section">
        <div class="container">
            <h2 class="section-title">互动留言板</h2>
            <div class="message-board">
                <form class="message-form" id="messageForm">

                    <div class="form-group">
                        <label for="message">留言内容</label>
                        <textarea id="message" rows="5" placeholder="请输入您的留言..." required></textarea>
                    </div>
                    <button type="submit" class="submit-button">提交留言</button>
                </form>
                
                <div class="thank-you-message" id="thankYouMessage">
                    <div class="thank-you-icon">✓</div>
                    <h3 class="thank-you-title">感谢您的留言！</h3>
                    <p class="thank-you-text">您的留言已成功发送，我们会尽快查看并回复。感谢您对太玄文化的支持与关注！我们将继续努力，为您提供更优质的易学内容与服务。</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 夜间模式：浮动按钮与主题样式 -->
    <style>
      /* 悬浮切换按钮（固定右下角） */
      .floating-toggle {
        position: fixed;
        right: 18px;
        bottom: 18px;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: none;
        outline: none;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 24px rgba(0,0,0,0.25);
        cursor: pointer;
        z-index: 2000;
        transition: transform .2s ease, background-color .2s ease;
        pointer-events: auto;
      }
      .floating-toggle:hover { transform: translateY(-1px); }
      html[data-theme="dark"] .floating-toggle { background: rgba(255,255,255,0.2); color: #ffd166; }

      /* 夜间主题基础 */
      html { color-scheme: light dark; }
      html[data-theme="dark"],
      html[data-theme="dark"] body {
        background-color: var(--dark-color, #0f0f14);
        color: var(--light-color, #eaeaea);
      }
      html[data-theme="dark"] a { color: var(--accent-color, #e6af2e); }
      html[data-theme="dark"] .section-title { color: var(--light-color, #eaeaea); }
      /* 夜间模式下：章节标题下横条改为更柔和的浅色，以避免过亮 */
      html[data-theme="dark"] .section-title::after {
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.28), transparent);
        opacity: 0.45;
      }

      /* 常见卡片/内容块暗色适配（尽量不破坏现有结构） */
      html[data-theme="dark"] .card,
      html[data-theme="dark"] .sponsor-card,
      html[data-theme="dark"] .mobile-card,
      html[data-theme="dark"] .course-card,
      html[data-theme="dark"] .feature-card,
      html[data-theme="dark"] .teacher-card,
      html[data-theme="dark"] .container-box {
        background-color: #1a1a1a !important;
        color: var(--light-color, #eaeaea) !important;
        border-color: rgba(255,255,255,0.12) !important;
        box-shadow: none !important;
      }

      /* 夜间模式：讲师介绍与相关白底块适配 */
      html[data-theme="dark"] .teacher-section {
        background: #000000 !important;
      }
      html[data-theme="dark"] .teacher-section::before {
        background: none !important;
        opacity: 0;
      }
      html[data-theme="dark"] .teacher-container { z-index: 2; }
      html[data-theme="dark"] .teacher-content {
        background-color: #111111 !important;
        border-color: rgba(255,255,255,0.12) !important;
        box-shadow: none !important;
      }
      html[data-theme="dark"] .teacher-name,
      html[data-theme="dark"] .expertise-title,
      html[data-theme="dark"] .publication-title {
        color: var(--light-color, #eaeaea) !important;
      }
      html[data-theme="dark"] .teacher-portrait::before { background-image: none !important; }
      html[data-theme="dark"] .expertise-item {
        background: rgba(255,255,255,0.06) !important;
        border-color: rgba(255,255,255,0.15) !important;
        color: var(--light-color, #eaeaea) !important;
      }
      html[data-theme="dark"] .expertise-item:hover {
        background: rgba(255,255,255,0.12) !important;
        border-color: rgba(255,255,255,0.25) !important;
      }
      /* 夜间模式：英雄区搜索框适配（避免亮白） */
      html[data-theme="dark"] .hero-search .search-box {
        background-color: rgba(0,0,0,0.6) !important;
        color: var(--light-color, #eaeaea) !important;
      }
      html[data-theme="dark"] .hero-search .search-button {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3) !important;
      }
      /* 夜间模式：英雄区背景与装饰层处理，避免底部出现褐色横带 */
      html[data-theme="dark"] .hero-background {
        background: #000000 !important;
      }
      html[data-theme="dark"] .hero::before {
        background: none !important;
        opacity: 0 !important;
        content: "" !important;
      }

      /* 夜间模式：公众课日程色系与卡片降亮 */
      html[data-theme="dark"] .section#public-classes { background: #000000 !important; }
      html[data-theme="dark"] #publicClassesScroll .scroll-item {
        background-color: #111111 !important;
        border-color: rgba(255,255,255,0.12) !important;
        box-shadow: none !important;
        color: var(--light-color, #eaeaea) !important;
      }
      html[data-theme="dark"] #publicClassesScroll .card-header {
        background: linear-gradient(135deg, rgba(217,179,130,0.15), rgba(140,110,84,0.25)) !important;
      }
      html[data-theme="dark"] #publicClassesScroll .card-header::before { background: none !important; }
      html[data-theme="dark"] #publicClassesScroll .card-body { color: var(--light-color, #eaeaea) !important; }
      /* 夜间模式：公众课滚动条色系（适配暗背景） */
      html[data-theme="dark"] .horizontal-scroll { scrollbar-color: rgba(217,179,130,0.6) rgba(255,255,255,0.12); }
      html[data-theme="dark"] .horizontal-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.12) !important; }
      html[data-theme="dark"] .horizontal-scroll::-webkit-scrollbar-thumb { background: linear-gradient(to right, rgba(217,179,130,0.7), rgba(140,110,84,0.6)) !important; }

      /* 夜间模式：通用白底覆盖和分割线调整 */
      html[data-theme="dark"] .section::before,
      html[data-theme="dark"] .section::after {
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
        opacity: 0.2;
      }
      /* 覆盖内联白底块（如管理面板中的白底卡） */
      html[data-theme="dark"] [style*="background: white"],
      html[data-theme="dark"] [style*="background-color: white"] {
        background: #111111 !important;
        box-shadow: none !important;
        border-color: rgba(255,255,255,0.12) !important;
        color: var(--light-color, #eaeaea) !important;
      }
      /* 通用搜索框在夜间降亮 */
      html[data-theme="dark"] .search-box {
        background-color: rgba(0,0,0,0.6) !important;
        color: var(--light-color, #eaeaea) !important;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25) !important;
      }

      /* 表单与输入控件 */
      html[data-theme="dark"] input,
      html[data-theme="dark"] select,
      html[data-theme="dark"] textarea {
        background-color: #161616;
        color: var(--light-color, #eaeaea);
        border-color: rgba(255,255,255,0.2);
      }

      /* 覆盖通用配色变量（如果页面已使用这些变量，将自动适配暗色） */
      html[data-theme="dark"] {
        --light-color: #eaeaea;
        --dark-color: #0f0f14;
        --primary-color: #d9b282;
        --secondary-color: #8c6e54;
        --highlight-color: #e6af2e;
        --accent-color: #e6af2e;
        /* 夜间模式：管理面板主色系降亮（深紫） */
        --admin-color: #6f5db3;
        --admin-light: #4f3f8f;
      }
      /* 夜间模式：管理面板整体降亮 */
      html[data-theme="dark"] .admin-section {
        background: #000000 !important;
      }
      html[data-theme="dark"] .admin-tabs {
        border-bottom-color: rgba(255, 255, 255, 0.12) !important;
      }
      html[data-theme="dark"] .admin-tab {
        color: rgba(255, 255, 255, 0.75);
        background: rgba(79, 63, 143, 0.12);
        border-bottom-color: transparent;
      }
      html[data-theme="dark"] .admin-tab.active {
        color: var(--admin-color);
        background: rgba(79, 63, 143, 0.18);
        box-shadow: none;
        border-bottom-color: var(--admin-color);
      }
      html[data-theme="dark"] .admin-panel {
        background: #111111;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: none;
        color: var(--light-color, #eaeaea);
      }
      html[data-theme="dark"] .panel-title {
        color: var(--admin-color);
        border-bottom-color: rgba(79, 63, 143, 0.25);
      }
      html[data-theme="dark"] .stat-card {
        background: linear-gradient(135deg, rgba(111, 93, 179, 0.35), rgba(79, 63, 143, 0.35));
        box-shadow: none;
      }
      html[data-theme="dark"] .admin-table th,
      html[data-theme="dark"] .admin-table td {
        background: transparent;
        color: rgba(255, 255, 255, 0.9);
        border-color: rgba(255, 255, 255, 0.12);
      }
      html[data-theme="dark"] .admin-table tr:hover {
        background-color: rgba(255, 255, 255, 0.06);
      }
    </style>

    <!-- 夜间模式切换脚本 -->
    <button id="themeToggle" class="floating-toggle" aria-label="切换夜间模式" title="夜间模式">🌙</button>
    <script>
      (function () {
        const STORAGE_KEY = 'theme';
        const root = document.documentElement;
        const btn = document.getElementById('themeToggle');

        function applyTheme(theme) {
          if (theme === 'dark') {
            root.setAttribute('data-theme', 'dark');
            btn.textContent = '☀️';
            btn.setAttribute('aria-label', '切换为日间模式');
            btn.title = '日间模式';
          } else {
            root.removeAttribute('data-theme');
            btn.textContent = '🌙';
            btn.setAttribute('aria-label', '切换为夜间模式');
            btn.title = '夜间模式';
          }
        }

        // 初次加载：先取本地存储，否则跟随系统偏好
        const saved = localStorage.getItem(STORAGE_KEY);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initial = saved ? saved : (prefersDark ? 'dark' : 'light');
        applyTheme(initial);

        // 点击切换与持久化
        btn.addEventListener('click', function () {
          const isDark = root.getAttribute('data-theme') === 'dark';
          const next = isDark ? 'light' : 'dark';
          localStorage.setItem(STORAGE_KEY, next);
          applyTheme(next);
        });
      })();
    </script>

    <!-- 页脚 -->
    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>联系方式</h3>
                    <p>邮箱: 1772854040@qq.com</p>
                    <p>电话: 13063939865</p>
                    <p>QQ: 3316651632</p>
                </div>
                
                <div class="footer-section">
                    <h3>快速链接</h3>
                    <p><a href="#teacher" style="color: var(--light-color); text-decoration: none;">讲师介绍</a></p>
                    <p><a href="#courses" style="color: var(--light-color); text-decoration: none;">课程介绍</a></p>
                    <p><a href="#sponsor" style="color: var(--light-color); text-decoration: none;">会员赞助</a></p>
                    <p><a href="#public-classes" style="color: var(--light-color); text-decoration: none;">公众课日程</a></p>
                    <p><a href="#home" style="color: var(--light-color); text-decoration: none;">返回首页</a></p>
                </div>
                
                <div class="footer-section">
                    <h3>关注我们</h3>
                    <p>关注我们的社交媒体，获取最新课程信息与易学知识</p>
                    <div class="social-links">
                        <a href="#" class="social-link">微</a>
                        <a href="#" class="social-link">抖</a>
                        <a href="#" class="social-link">知</a>
                        <a href="#" class="social-link">B</a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2023 太玄文化 版权所有 | 传承千年智慧，启迪现代人生</p>
            </div>
        </div>
    </footer>

    <!-- 会员登录弹窗 -->
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <span class="close-btn" id="closeLoginModal">&times;</span>
            <h2 class="login-title">会员登录</h2>
            
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">登录</div>
                <div class="login-tab" data-tab="register">注册</div>
            </div>
            
            <form class="login-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">用户名/邮箱</label>
                    <input type="text" id="loginUsername" placeholder="请输入用户名或邮箱" required autocomplete="username" minlength="3">
                </div>
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码" required autocomplete="current-password" minlength="6">
                </div>
                <button type="submit" class="login-submit">登录</button>
                <div class="login-links">
                    <a href="#" id="forgotPassword">忘记密码？</a>
                </div>
            </form>
            
            <form class="login-form" id="registerForm">
                <div class="form-group">
                    <label for="registerUsername">用户名</label>
                    <input type="text" id="registerUsername" placeholder="请输入用户名" required autocomplete="username" minlength="3">
                </div>
                <div class="form-group">
                    <label for="registerEmail">邮箱</label>
                    <input type="email" id="registerEmail" placeholder="请输入邮箱" required autocomplete="email" inputmode="email">
                </div>
                <div class="form-group">
                    <label for="registerInviteCode">邀请码</label>
                    <input type="text" id="registerInviteCode" placeholder="请输入邀请码（必填）" required autocomplete="one-time-code" inputmode="text" minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" placeholder="请输入密码" required autocomplete="new-password" minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">确认密码</label>
                    <input type="password" id="registerConfirmPassword" placeholder="请再次输入密码" required autocomplete="new-password" minlength="6">
                </div>
                <button type="submit" class="login-submit">注册</button>
            </form>
        </div>
    </div>

    <!-- 联系导师弹窗 -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <h2 class="modal-title">联系导师</h2>
            <p>请添加导师QQ进行课程咨询和购买：</p>
            <div class="qq-info">QQ: 3316651632</div>
            <div class="contact-instructions">
                <p>添加时请备注"课程咨询"，我们的导师荡气会尽快与您联系。</p>
                <p>工作时间：周一至周五 9:00-18:00</p>
            </div>
        </div>
    </div>

    <!-- VIP激活弹窗 -->
    <div class="modal" id="vipActivateModal" style="display:none;">
        <div class="modal-content" style="max-width: 420px;">
            <span class="close-btn" id="closeVipActivateModal">&times;</span>
            <h2 class="modal-title">激活VIP</h2>
            <div class="form-group">
                <label for="desktopVipActivationInput">激活码</label>
                <input type="text" id="desktopVipActivationInput" placeholder="请输入激活码">
            </div>
            <button class="card-button" id="desktopVipActivateBtn" style="margin-top: 10px;">激活VIP</button>
        </div>
    </div>

    <!-- 铜币优惠购买弹窗 -->
    <div class="modal" id="discountModal" style="display:none;">
        <div class="modal-content" style="max-width: 460px;">
            <span class="close-btn" id="closeDiscountModal">&times;</span>
            <h2 class="modal-title">课程购买优惠</h2>
            <div style="margin: 8px 0; color:#555;">
                <div>课程：<span id="discountCourseName">-</span></div>
                <div>原价：¥<span id="discountOriginalPrice">0</span></div>
                <div>可用铜币：<span id="discountUserCoins">0</span></div>
            </div>
            <div style="padding:10px;border:1px solid #eee;border-radius:8px;margin-top:8px;">
                <div style="font-weight:600;margin-bottom:6px;">选择优惠</div>
                <label style="display:block;margin-bottom:6px;">
                    <input type="radio" name="discountOption" value="0" id="discountNone" checked>
                    不使用铜币
                </label>
                <label style="display:block;margin-bottom:6px;">
                    <input type="radio" name="discountOption" value="5" id="discount5">
                    使用 50 铜币，优惠 5%
                </label>
                <label style="display:block;margin-bottom:6px;">
                    <input type="radio" name="discountOption" value="10" id="discount10">
                    使用 100 铜币，优惠 10%
                </label>
                <div style="margin-top:8px;">优惠后应付：¥<span id="discountFinalPrice">0</span></div>
            </div>
            <div id="discountCodeInfo" style="display:none;margin-top:12px;padding:8px;border:1px dashed #ddd;border-radius:8px;color:#333;">
                <div>激活码：<span id="generatedDiscountCode">-</span></div>
                <div>私密链接：<a id="generatedDiscountLink" href="#" target="_blank">-</a></div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
                <button class="save-btn" id="confirmDiscountBtn">生成激活码</button>
                <button class="cancel-btn" id="cancelDiscountBtn">取消</button>
            </div>
            <p style="margin-top:8px;color:#888;font-size:12px;">
                提示：激活码生成后需管理员在“折扣激活码”面板审批，审批通过后自动纳入课程并扣除相应铜币。
            </p>
        </div>
    </div>

    <!-- 邮件弹窗 -->
    <div class="modal" id="mailModal" style="display:none;">
        <div class="modal-content" style="max-width: 420px;">
            <span class="close-btn" id="closeMailModal">&times;</span>
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <h2 class="modal-title" style="margin:0;">管理员公告</h2>
                <button id="refreshMailModalBtn" style="padding:6px 10px;font-size:12px;">刷新</button>
            </div>
            <div id="mailAnnouncementsModalList" style="max-height:240px; overflow-y:auto;"></div>
            <div style="margin-top: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px;">我的留言与回复</div>
                <div id="mailRepliesModalList" style="max-height:240px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // 数据存储
        let students = JSON.parse(localStorage.getItem('taixuanStudents')) || [
            {
                id: 1,
                name: "张三",
                email: "zhangsan@example.com",
                group: "初级班",
                joinDate: "2023-09-15",
                progress: 65,
                studyTime: 42,
                courses: ["易经入门", "八字命理精讲"]
            },
            {
                id: 2,
                name: "李四",
                email: "lisi@example.com",
                group: "进阶班",
                joinDate: "2023-08-22",
                progress: 82,
                studyTime: 78,
                courses: ["八字命理精讲", "风水实战应用"]
            },
            {
                id: 3,
                name: "王五",
                email: "wangwu@example.com",
                group: "VIP班",
                joinDate: "2023-10-05",
                progress: 45,
                studyTime: 25,
                courses: ["易经入门", "风水实战应用", "梅花易数精解"]
            },
            {
                id: 4,
                name: "赵六",
                email: "zhaoliu@example.com",
                group: "未分组",
                joinDate: "2023-11-12",
                progress: 30,
                studyTime: 15,
                courses: ["易经入门"]
            },
            {
                id: 5,
                name: "钱七",
                email: "qianqi@example.com",
                group: "高级班",
                joinDate: "2023-07-30",
                progress: 75,
                studyTime: 95,
                courses: ["八字命理精讲", "风水实战应用", "梅花易数精解"]
            }
        ];

        let groups = JSON.parse(localStorage.getItem('taixuanGroups')) || [
            {
                id: 1,
                name: "初级班",
                studentCount: 45,
                createDate: "2023-01-15",
                manager: "荡气",
                description: "适合初学者的入门课程"
            },
            {
                id: 2,
                name: "进阶班",
                studentCount: 32,
                createDate: "2023-03-20",
                manager: "荡气",
                description: "适合有一定基础的学员"
            },
            {
                id: 3,
                name: "高级班",
                studentCount: 18,
                createDate: "2023-05-10",
                manager: "荡气",
                description: "深入探讨易学高级主题"
            },
            {
                id: 4,
                name: "VIP班",
                studentCount: 12,
                createDate: "2023-07-05",
                manager: "荡气",
                description: "一对一指导，个性化学习方案"
            }
        ];

        let courses = JSON.parse(localStorage.getItem('taixuanCourses')) || [
            {
                id: 1,
                name: "易经入门",
                category: "易经基础",
                instructor: "荡气",
                price: 299,
                description: "从零开始学习易经基础知识，了解八卦、六十四卦的基本含义与应用，掌握易经核心思想。",
                level: "bronze",
                duration: 12,
                students: 156,
                avgProgress: 72
            },
            {
                id: 2,
                name: "八字命理精讲",
                category: "命理预测",
                instructor: "荡气",
                price: 599,
                description: "深入学习八字命理，掌握排盘、解读技巧，洞悉人生轨迹，预测运势走向。",
                level: "silver",
                duration: 20,
                students: 89,
                avgProgress: 65
            },
            {
                id: 3,
                name: "风水实战应用",
                category: "风水实践",
                instructor: "荡气",
                price: 799,
                description: "学习风水布局原理，掌握家居、办公环境优化方法，提升生活品质与事业运势。",
                level: "gold",
                duration: 15,
                students: 67,
                avgProgress: 58
            }
        ];

        // 公众课数据
        let publicClasses = JSON.parse(localStorage.getItem('taixuanPublicClasses')) || [
            {
                id: 1,
                title: "易经基础公开课",
                time: "每周三 20:00-21:30",
                platform: "腾讯会议",
                description: "免费公开课，讲解易经基础知识与应用，适合零基础学员。"
            },
            {
                id: 2,
                title: "八字命理入门课",
                time: "每周五 19:30-21:00",
                platform: "钉钉直播",
                description: "免费入门课，了解八字命理的基本概念与排盘方法。"
            },
            {
                id: 3,
                title: "家居风水讲座",
                time: "每月第二个周日 15:00-16:30",
                platform: "Zoom会议",
                description: "免费讲座，学习家居风水布局技巧，优化居住环境。"
            },
            {
                id: 4,
                title: "易学答疑专场",
                time: "每月最后一个周六 10:00-11:30",
                platform: "微信视频号",
                description: "免费答疑，解答易学学习中的疑问，分享实用技巧。"
            }
        ];

        // 会员课程数据
        const userCourses = [
            {
                id: 1,
                title: "易经入门精讲",
                progress: 85,
                lastStudy: "2023-11-15",
                totalLessons: 12,
                completedLessons: 10,
                studyTime: 15,
                instructor: "荡气",
                category: "易经基础"
            },
            {
                id: 2,
                title: "八字命理实战",
                progress: 60,
                lastStudy: "2023-11-10",
                totalLessons: 20,
                completedLessons: 12,
                studyTime: 22,
                instructor: "荡气",
                category: "命理预测"
            },
            {
                id: 3,
                title: "风水布局应用",
                progress: 45,
                lastStudy: "2023-11-05",
                totalLessons: 15,
                completedLessons: 7,
                studyTime: 12,
                instructor: "荡气",
                category: "风水实践"
            },
            {
                id: 4,
                title: "梅花易数精解",
                progress: 30,
                lastStudy: "2023-10-28",
                totalLessons: 18,
                completedLessons: 5,
                studyTime: 8,
                instructor: "荡气",
                category: "占卜预测"
            }
        ];

        // 管理员账户
        const adminAccount = {
            username: "admin",
            password: "admin123",
            role: "admin"
        };

        const MEMBER_STATUS = {
            pending: 'pending',
            active: 'active',
            revoked: 'revoked'
        };
        function getMembers() {
            try { return JSON.parse(localStorage.getItem('taixuanMembers')) || []; } catch(e) { return []; }
        }
        function saveMembers(members) { localStorage.setItem('taixuanMembers', JSON.stringify(members)); }
        function getInviteCodes() {
            try { return JSON.parse(localStorage.getItem('taixuanInviteCodes')) || []; } catch(e) { return []; }
        }
        function saveInviteCodes(codes) { localStorage.setItem('taixuanInviteCodes', JSON.stringify(codes)); }
        (function(){
            // 仅首次初始化示例邀请码，后续可删除且不再自动回填
            const inited = localStorage.getItem('taixuanInviteInit');
            if (!inited) {
                const codes = getInviteCodes();
                if (codes.length === 0) { saveInviteCodes(['TX-2025-OPEN']); }
                localStorage.setItem('taixuanInviteInit', '1');
            }
        })();
        function requireAdmin() {
            try {
                const u = JSON.parse(localStorage.getItem('taixuanUser'));
                return !!(u && u.role === 'admin' && u.username === adminAccount.username);
            } catch(e) { return false; }
        }
        function approveMember(email) {
            if (!requireAdmin()) { alert('需要管理员权限'); return false; }
            const members = getMembers();
            const m = members.find(x => x.email === email);
            if (!m) { alert('未找到该会员'); return false; }
            m.status = MEMBER_STATUS.active;
            saveMembers(members);
            
            // 审批通过后，自动在学员列表创建对应记录（如不存在）
            try {
                const existsStudent = students.some(s => s.email === m.email);
                if (!existsStudent) {
                    const newId = students.length > 0 ? Math.max(...students.map(s => s.id || 0)) + 1 : 1;
                    students.push({
                        id: newId,
                        name: m.username || '',
                        email: m.email || '',
                        group: '未分组',
                        joinDate: new Date().toLocaleDateString(),
                        progress: 0,
                        studyTime: 0,
                        courses: []
                    });
                    localStorage.setItem('taixuanStudents', JSON.stringify(students));
                    if (typeof renderStudentsTable === 'function') renderStudentsTable();
                    if (typeof renderGroupsTable === 'function') renderGroupsTable();
                }
            } catch(e) {}
            
            alert('已批准该会员');
            return true;
        }
        function revokeMember(email) {
            if (!requireAdmin()) { alert('需要管理员权限'); return false; }
            const members = getMembers();
            const m = members.find(x => x.email === email);
            if (!m) { alert('未找到该会员'); return false; }
            try {
                const current = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                if ((current.email && current.email === m.email) || m.role === 'admin') {
                    alert('不允许注销当前管理员用户');
                    return false;
                }
            } catch(e) {}
            m.status = MEMBER_STATUS.revoked;
            saveMembers(members);
            try {
                const current = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                if (current.email && current.email === m.email) {
                    localStorage.removeItem('taixuanUser');
                    updateAuthUI('', 'user');
                }
            } catch(e) {}
            alert('已注销该会员');
            return true;
        }
        function addInviteCode(code) {
            if (!requireAdmin()) { alert('需要管理员权限'); return false; }
            const s = safeText(code || '');
            if (!s) { alert('邀请码不能为空'); return false; }
            const codes = getInviteCodes();
            // 兼容字符串和对象两种存储
            const normalized = Array.isArray(codes) ? codes.map(c => typeof c === 'string' ? {code: c} : c) : [];
            if (!normalized.some(c => c.code === s)) { normalized.push({code: s}); saveInviteCodes(normalized); }
            alert('已添加邀请码');
            return true;
        }

        // 邀码工具（限时与校验）
        function normalizeInviteCodes(raw) {
            const arr = Array.isArray(raw) ? raw : [];
            return arr.map(c => typeof c === 'string' ? { code: c, createdAt: Date.now(), expiresAt: null } : c);
        }
        function isInviteValid(codeInput) {
            const list = normalizeInviteCodes(getInviteCodes());
            const item = list.find(x => x.code === codeInput);
            return !!item && (!item.expiresAt || Date.now() < item.expiresAt);
        }
        function createLimitedInviteCode() {
            if (!requireAdmin()) { alert('需要管理员权限'); return; }
            const code = (document.getElementById('inviteCodeInput').value || '').trim();
            const minutes = parseInt(document.getElementById('inviteCodeMinutes').value, 10) || 0;
            if (!code || minutes <= 0) { alert('请输入有效的邀请码和分钟数'); return; }
            const now = Date.now();
            const codes = normalizeInviteCodes(getInviteCodes());
            if (codes.some(c => c.code === code)) { alert('该邀请码已存在'); return; }
            codes.push({ code: safeText(code), createdAt: now, expiresAt: now + minutes * 60 * 1000 });
            saveInviteCodes(codes);
            alert('已创建限时邀请码');
            renderInviteCodesTable();
        }
        function deleteInviteCode(code) {
            if (!requireAdmin()) { alert('需要管理员权限'); return; }
            const codes = normalizeInviteCodes(getInviteCodes()).filter(c => c.code !== code);
            saveInviteCodes(codes);
            alert('已删除邀请码');
            renderInviteCodesTable();
        }
        function renderInviteCodesTable() {
            const list = normalizeInviteCodes(getInviteCodes());
            const tbody = document.getElementById('inviteCodesTableBody');
            if (!tbody) return;
            tbody.innerHTML = list.map(c => {
                const status = c.expiresAt && Date.now() >= c.expiresAt ? '已过期' : '有效';
                const created = c.createdAt ? new Date(c.createdAt).toLocaleString() : '-';
                const expires = c.expiresAt ? new Date(c.expiresAt).toLocaleString() : '永久';
                const sCode = safeText(c.code || '');
                return `
                <tr>
                    <td>${sCode}</td>
                    <td>${status}</td>
                    <td>${created}</td>
                    <td>${expires}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="delete-btn" onclick="deleteInviteCode('${sCode}')">删除</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        function renderPendingMembersTable() {
            const members = getMembers().filter(m => m.status === MEMBER_STATUS.pending);
            const tbody = document.getElementById('pendingMembersTableBody');
            if (!tbody) return;
            const safeMembers = members.map(m => ({
                username: safeText(m.username || ''),
                email: safeText(m.email || ''),
                inviteCode: safeText(m.inviteCode || ''),
                createdAt: m.createdAt
            }));
            tbody.innerHTML = safeMembers.map(m => `
                <tr>
                    <td>${m.username}</td>
                    <td>${m.email}</td>
                    <td>${m.inviteCode}</td>
                    <td>${m.createdAt ? new Date(m.createdAt).toLocaleString() : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="save-btn" onclick="approveMember('${m.email}'); renderWhitelist();">批准</button>
                            <button class="delete-btn" onclick="revokeMember('${m.email}'); renderWhitelist();">拒绝</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        function renderWhitelist() {
            renderInviteCodesTable();
            renderPendingMembersTable();
        }

        // 页面元素
        const loginBtn = document.getElementById('loginBtn');
        const loginModal = document.getElementById('loginModal');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const loginTabs = document.querySelectorAll('.login-tab');
        const loginForms = document.querySelectorAll('.login-form');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const authSection = document.getElementById('authSection');
        const myCoursesLink = document.getElementById('myCoursesLink');
        const myCoursesSection = document.getElementById('my-courses');
        const adminPanelLink = document.getElementById('adminPanelLink');
        const adminSection = document.getElementById('admin-panel');
        const homeLogo = document.getElementById('homeLogo');
        const homeLink = document.getElementById('homeLink');

        // 等级与奖励逻辑
        function getLevelThreshold(level) {
            if (level === 1) return 100;
            if (level === 2) return 300;
            if (level === 3) return 400;
            if (level === 4) return 500;
            if (level === 5) return 600;
            return Infinity; // 6级及以上无下一阈值
        }

        function ensureUserStats(user) {
            const u = { ...user };
            if (typeof u.coins !== 'number') u.coins = 0;
            if (typeof u.xp !== 'number') u.xp = 0;
            if (typeof u.level !== 'number' || !u.level) u.level = 1;
            if (!u.lastRewardDate) u.lastRewardDate = '';
            return u;
        }
        function normalizeLevelXp(level, xp) {
            let l = Math.max(1, Math.min(6, Number(level) || 1));
            let x = Math.max(0, Number(xp) || 0);
            while (l < 6) {
                const need = getLevelThreshold(l);
                if (x >= need) {
                    l += 1;
                    x = 0;
                } else {
                    break;
                }
            }
            if (l >= 6) x = 0; // 满级不再积累经验
            return { level: l, xp: x };
        }

        function applyDailyLoginReward(user) {
            const u = ensureUserStats(user);
            if (u.role !== 'admin') {
                const today = new Date().toDateString();
                if (u.lastRewardDate !== today) {
                    u.coins += 2;
                    u.xp += 10;
                    u.lastRewardDate = today;
                    // 升级检查：达到阈值后升级并经验清零
                    while (u.level < 6) {
                        const need = getLevelThreshold(u.level);
                        if (u.xp >= need) {
                            u.level += 1;
                            u.xp = 0;
                        } else {
                            break;
                        }
                    }
                    // 铜币上限
                    if (u.coins > 999) u.coins = 999;
                }
            }
            return u;
        }

        // 管理员面板元素
        const adminTabs = document.querySelectorAll('.admin-tab');
        const adminPanels = document.querySelectorAll('.admin-panel');
        const studentsTableBody = document.getElementById('studentsTableBody');
        const groupsTableBody = document.getElementById('groupsTableBody');
        const coursesTableBody = document.getElementById('coursesTableBody');
        const publicClassesTableBody = document.getElementById('publicClassesTableBody');
        
        // 学员管理元素
        const addStudentBtn = document.getElementById('addStudentBtn');
        const studentEditModal = document.getElementById('studentEditModal');
        const studentEditForm = document.getElementById('studentEditForm');
        const closeStudentEditModal = document.getElementById('closeStudentEditModal');
        const cancelStudentEdit = document.getElementById('cancelStudentEdit');
        const studentEditTitle = document.getElementById('studentEditTitle');
        
        // 分组管理元素
        const addGroupBtn = document.getElementById('addGroupBtn');
        const groupEditModal = document.getElementById('groupEditModal');
        const groupEditForm = document.getElementById('groupEditForm');
        const closeGroupEditModal = document.getElementById('closeGroupEditModal');
        const cancelGroupEdit = document.getElementById('cancelGroupEdit');
        const groupEditTitle = document.getElementById('groupEditTitle');
        
        // 课程管理元素
        const addCourseBtn = document.getElementById('addCourseBtn');
        const courseEditModal = document.getElementById('courseEditModal');
        const courseEditForm = document.getElementById('courseEditForm');
        const closeCourseEditModal = document.getElementById('closeCourseEditModal');
        const cancelCourseEdit = document.getElementById('cancelCourseEdit');
        const courseEditTitle = document.getElementById('courseEditTitle');
        
        // 公众课管理元素
        const addPublicClassBtn = document.getElementById('addPublicClassBtn');
        const publicClassEditModal = document.getElementById('publicClassEditModal');
        const publicClassEditForm = document.getElementById('publicClassEditForm');
        const closePublicClassEditModal = document.getElementById('closePublicClassEditModal');
        const cancelPublicClassEdit = document.getElementById('cancelPublicClassEdit');
        const publicClassEditTitle = document.getElementById('publicClassEditTitle');

        // 课程容器
        const courseCardsContainer = document.getElementById('courseCardsContainer');
        const publicClassesScroll = document.getElementById('publicClassesScroll');

        // 安全工具函数
        function safeText(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/`/g, '&#96;');
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 渲染首页课程
            renderCourseCards();
            
            // 渲染公众课
            renderPublicClasses();
            
            // 检查登录状态（发放当日奖励后再更新UI）
            const userInfo = JSON.parse(localStorage.getItem('taixuanUser'));
            if (userInfo && userInfo.isLoggedIn) {
                if (userInfo.role === 'admin') {
                    // 管理员不参与等级/经验/铜币逻辑
                    updateAuthUI(userInfo.username, userInfo.role);
                } else {
                    const enriched = ensureUserStats(userInfo);
                    const rewarded = applyDailyLoginReward(enriched);
                    if (rewarded.coins > 999) rewarded.coins = 999;
                    localStorage.setItem('taixuanUser', JSON.stringify(rewarded));
                    // 如果是会员，同步到 taixuanMembers
                    if (rewarded.role === 'user') {
                        const members = getMembers();
                        const mm = members.find(x => x.email === rewarded.email || x.username === rewarded.username);
                        if (mm) {
                            mm.level = rewarded.level;
                            mm.xp = rewarded.xp;
                            mm.coins = rewarded.coins;
                            mm.lastRewardDate = rewarded.lastRewardDate;
                            saveMembers(members);
                        }
                    }
                    updateAuthUI(rewarded.username, rewarded.role);
                }
            }
            
            // 绑定首页链接事件（阻止默认并触发返回顶部）
            homeLink.addEventListener('click', function(e) { e.preventDefault(); showHomePage(); });
            homeLogo.addEventListener('click', function(e) { e.preventDefault(); showHomePage(); });
            // 兜底：所有 href="#home" 的链接也绑定返回首页
            document.querySelectorAll('a[href="#home"]').forEach(a => {
                a.addEventListener('click', function(e) { e.preventDefault(); showHomePage(); });
            });
            
            // 从管理面板返回并滚动到指定区域
            function navigateToSection(sectionId) {
                showHomePage();
                const target = document.getElementById(sectionId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // 若找不到目标，兜底回到顶部
                    window.scrollTo(0, 0);
                }
            }
            
            // 讲师介绍、课程、会员赞助、公众课、联系 导航绑定
            document.querySelectorAll('a[href="#teacher"]').forEach(a => {
                a.addEventListener('click', function(e) { e.preventDefault(); navigateToSection('teacher'); });
            });
            document.querySelectorAll('a[href="#courses"]').forEach(a => {
                a.addEventListener('click', function(e) { e.preventDefault(); navigateToSection('courses'); });
            });
            document.querySelectorAll('a[href="#sponsor"]').forEach(a => {
                a.addEventListener('click', function(e) { e.preventDefault(); navigateToSection('sponsor'); });
            });
            document.querySelectorAll('a[href="#public-classes"]').forEach(a => {
                a.addEventListener('click', function(e) { e.preventDefault(); navigateToSection('public-classes'); });
            });
            document.querySelectorAll('a[href="#contact"]').forEach(a => {
                a.addEventListener('click', function(e) { e.preventDefault(); navigateToSection('contact'); });
            });
            // 邮件导航绑定
            // 邮件下拉：仅登录用户显示
            const mailNavItem = document.getElementById('mailNavItem');
            const mailToggle = document.getElementById('mailToggle');
            const mailDropdown = document.getElementById('mailDropdown');
            
            function updateMailVisibility() {
                try {
                    const user = JSON.parse(localStorage.getItem('taixuanUser'));
                    const isLoggedIn = user && user.isLoggedIn;
                    const isAdmin = user && user.role === 'admin';
                    if (mailNavItem) mailNavItem.style.display = (isLoggedIn && !isAdmin) ? 'block' : 'none';
                } catch(e) {}
            }
            function updateMailIndicator() {
                // 红点提示已取消，保留函数占位以兼容既有调用
                try {
                    // no-op
                } catch(e) {}
            }
            if (mailToggle) {
                mailToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('mailModal');
                    if (modal) {
                        renderMailAnnouncementsModal();
                        renderMailRepliesModal();
                        modal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                });
                document.addEventListener('click', function(e) {
                    if (mailNavItem && !mailNavItem.contains(e.target)) {
                        if (mailDropdown) { mailDropdown.style.display = 'none'; }
                    }
                });
            }
            updateMailVisibility();
            updateMailIndicator();
            
            // 绑定购买按钮事件（课程弹优惠，其它保持联系导师）
            document.querySelectorAll('.purchase-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productName = this.getAttribute('data-product') || '';
                    const course = courses.find(c => c.name === productName);
                    const cuRaw = localStorage.getItem('taixuanUser');
                    const cu = cuRaw ? JSON.parse(cuRaw) : null;
                    // 未登录跳转QQ联系（打开联系弹窗）
                    if (!cu) {
                        const contactModalEl = document.getElementById('contactModal');
                        if (contactModalEl) contactModalEl.style.display = 'flex';
                        return;
                    }
                    if (cu && cu.role === 'admin') {
                        alert('管理员不能购买课程');
                        return;
                    }
                    // 已拥有课程拦截（会员）
                    if (course) {
                        const student = cu ? (
                            students.find(s => (s.email && cu.email && s.email === cu.email) || (s.name === cu.username))
                        ) : null;
                        if (student && Array.isArray(student.courses) && student.courses.length > 0) {
                            const ownedSet = new Set(student.courses.map(cItem => {
                                const numericId = typeof cItem === 'number' ? cItem : parseInt(cItem, 10);
                                let cc = null;
                                if (!isNaN(numericId)) {
                                    cc = courses.find(c => c.id === numericId);
                                }
                                if (!cc) {
                                    cc = courses.find(c => c.name === String(cItem));
                                }
                                return String(cc ? cc.name : cItem).toLowerCase().trim();
                            }));
                            const targetName = String(course.name).toLowerCase().trim();
                            if (ownedSet.has(targetName)) {
                                alert('您已拥有该课程，无法重复购买');
                                return;
                            }
                        }
                        openDiscountModal(course);
                    } else {
                        const isSponsor = /赞助|会员/.test(productName);
                        if (isSponsor) {
                            // 设置目标赞助类型（用于限制激活码类型）
                            const desiredPlan = (/月度/.test(productName) ? 'monthly' : (/年度/.test(productName) ? 'yearly' : ''));
                            if (desiredPlan) { localStorage.setItem('vipDesiredPlan', desiredPlan); } else { localStorage.removeItem('vipDesiredPlan'); }
                            const modal = document.getElementById('vipActivateModal');
                            if (modal) {
                                modal.style.display = 'flex';
                                document.body.style.overflow = 'hidden';
                            }
                            return;
                        } else {
                            const cm = document.getElementById('contactModal');
                            if (cm) cm.style.display = 'flex';
                        }
                    }
                });
            });
            
            // 绑定留言表单提交事件（需登录，保存到管理员后台）
            document.getElementById('messageForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const currentUser = JSON.parse(localStorage.getItem('taixuanUser'));
                if (!currentUser || !currentUser.isLoggedIn) {
                    alert('请先登录后再留言');
                    const lm = document.getElementById('loginModal');
                    if (lm) lm.style.display = 'flex';
                    return;
                }

                const msgVal = document.getElementById('message').value.trim();

                if (!msgVal) {
                    alert('请填写留言内容');
                    return;
                }

                const name = safeText(currentUser.username || '');
                const content = safeText(msgVal);

                const messages = JSON.parse(localStorage.getItem('taixuanMessages')) || [];

                // 学员用户限制：每天一次留言，且最多100字（管理员不受限）
                if (!currentUser.role || currentUser.role !== 'admin') {
                    if ((msgVal || '').length > 100) {
                        alert('留言内容最多100字');
                        return;
                    }
                    const todayStr = new Date().toDateString();
                    const uname = safeText(currentUser.username || '');
                    const hasToday = messages.some(m => (m.user === uname) && (new Date(m.time).toDateString() === todayStr));
                    if (hasToday) {
                        alert('您今天已留言过，请明天再来。');
                        return;
                    }
                }

                const nextId = messages.length ? Math.max(...messages.map(m => m.id || 0)) + 1 : 1;

                messages.push({
                    id: nextId,
                    name,
                    content,
                    user: safeText(currentUser.username || ''),
                    time: new Date().toISOString(),
                    status: 'new'
                });

                localStorage.setItem('taixuanMessages', JSON.stringify(messages));
                try { if (typeof updateMailIndicator === 'function') updateMailIndicator(); } catch(e) {}

                document.getElementById('messageForm').style.display = 'none';
                document.getElementById('thankYouMessage').style.display = 'block';
            });
        });

        // 显示主页（恢复原始布局并确保滚动复位）
        function showHomePage() {
            document.querySelectorAll('section').forEach(section => {
                // 移除内联 display，恢复各区块原本的 CSS 布局（如 .hero 的 flex）
                section.style.removeProperty('display');
            });
            adminSection.style.display = 'none';
            myCoursesSection.style.display = 'none';
            // 强制滚动复位，兼容不同浏览器
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
        }

        // 渲染首页课程卡片
        function renderCourseCards() {
            const safeCourses = courses.map(c => ({...c, name: safeText(c.name), category: safeText(c.category), instructor: safeText(c.instructor), description: safeText(c.description), imageUrl: safeText(c.imageUrl || '')}));
            courseCardsContainer.innerHTML = safeCourses.map(course => {
                const levelClass = course.level === 'bronze' ? 'bronze' : 
                                 course.level === 'silver' ? 'silver' : 'gold';
                
                return `
                    <div class="card ${levelClass}">
                        <div class="coin-decoration coin-top-left">
                            <div class="coin-text">${course.category}</div>
                        </div>
                        ${course.level === 'silver' || course.level === 'gold' ? `
                        <div class="coin-decoration coin-top-right">
                            <div class="coin-text">${course.level === 'silver' ? '精讲' : '应用'}</div>
                        </div>
                        ` : ''}
                        <div class="card-header">
                            <h3>${course.name}</h3>
                        </div>
                        ${course.imageUrl ? `
                        <div class="card-cover" style="text-align:center;">
                            <img src="${course.imageUrl}" alt="${course.name} 封面" style="max-width:100%;height:auto;border-radius:8px;">
                        </div>` : ''}
                        <div class="card-body">
                            <p>${course.description}</p>
                            <div class="card-price">¥${course.price}</div>
                            <button class="card-button purchase-btn" data-product="${course.name}">立即购买</button>
                        </div>
                        <div class="coin-decoration coin-bottom-left">
                            <div class="coin-text">太玄文化</div>
                        </div>
                        ${course.level === 'silver' || course.level === 'gold' ? `
                        <div class="coin-decoration coin-bottom-right">
                            <div class="coin-text">${course.instructor}主讲</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // 渲染公众课卡片
        function renderPublicClasses() {
            publicClassesScroll.innerHTML = publicClasses.map(publicClass => `
                <div class="scroll-item">
                    <div class="card-header">
                        <h3>${publicClass.title}</h3>
                    </div>
                    <div class="card-body">
                        <p><strong>时间：</strong>${publicClass.time}</p>
                        <p><strong>平台：</strong>${publicClass.platform}</p>
                        <p>${publicClass.description}</p>
                        <button class="card-button purchase-btn" data-product="${publicClass.title}">预约参加</button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染学员表格
        function renderStudentsTable() {
            // VIP状态来源：激活码使用记录（usedBy为用户名）
            let vipUsedUsernames = new Set();
            try {
                const vipList = JSON.parse(localStorage.getItem('taixuanVipCodes')) || [];
                vipUsedUsernames = new Set(vipList.filter(i => i.status === 'used' && i.usedBy).map(i => i.usedBy));
            } catch(e) {}
            // 合并正式学员与会员（未注销）为统一视图
            const members = getMembers().filter(m => m.status !== MEMBER_STATUS.revoked);
            const memberRows = members.map((m, idx) => ({
                id: 'm_' + idx,
                name: safeText(m.username || ''),
                email: safeText(m.email || ''),
                group: '未分组',
                joinDate: m.createdAt ? new Date(m.createdAt).toLocaleDateString() : '',
                progress: 0,
                studyTime: 0,
                courses: []
            }));
            const memberRowsNoAdmin = memberRows.filter(m => m.name !== adminAccount.username);
            const safeStudents = students.map(student => ({...student, name: safeText(student.name), email: safeText(student.email), group: safeText(student.group), joinDate: safeText(student.joinDate)}));
            const safeStudentsNoAdmin = safeStudents.filter(s => s.name !== adminAccount.username);
            // 去重：若已存在同邮箱的学员，则不再显示对应会员行
            const studentEmails = new Set(safeStudentsNoAdmin.map(s => s.email));
            const memberRowsDedup = memberRowsNoAdmin.filter(m => !studentEmails.has(m.email));
            const allRows = [...safeStudentsNoAdmin, ...memberRowsDedup];

            studentsTableBody.innerHTML = allRows.map(student => `
                <tr>
                    <td>${student.name}</td>
                    <td>${student.email}</td>
                    <td>${vipUsedUsernames.has(student.name) ? 'VIP' : '普通'}</td>
                    <td>${student.group}</td>
                    <td>${student.joinDate}</td>
                    <td>
                        <div class="course-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${student.progress}%"></div>
                            </div>
                            <div class="progress-text">${student.progress}%</div>
                        </div>
                    </td>
                    <td>${student.studyTime}小时</td>
                    <td>
                        <div class="action-buttons">
                            ${String(student.id).startsWith('m_')
                                ? `
                                    <button class="edit-btn" onclick="alert('会员信息请在白名单面板审批/管理');">编辑</button>
                                    <button class="delete-btn" onclick="revokeMember('${student.email}'); renderStudentsTable(); if (typeof renderWhitelist === 'function') renderWhitelist();">删除</button>
                                  `
                                : `
                                    <button class="edit-btn" onclick="openStudentEditModal(${student.id})">编辑</button>
                                    <button class="delete-btn" onclick="deleteStudent(${student.id})">删除</button>
                                  `
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // 更新学员统计数据
            updateStudentStats();
        }

        // 渲染分组表格
        function renderGroupsTable() {
            // 更新每个分组的学员数量
            groups.forEach(group => {
                group.studentCount = students.filter(student => student.group === group.name).length;
            });
            
            const safeGroups = groups.map(group => ({...group, name: safeText(group.name), createDate: safeText(group.createDate), manager: safeText(group.manager)}));
            groupsTableBody.innerHTML = safeGroups.map(group => `
                <tr>
                    <td>${group.name}</td>
                    <td>${group.studentCount}</td>
                    <td>${group.createDate}</td>
                    <td>${group.manager}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="openGroupEditModal(${group.id})">编辑</button>
                            <button class="delete-btn" onclick="deleteGroup(${group.id})">删除</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // 更新分组统计数据
            updateGroupStats();
        }

        // 渲染课程表格
        function renderCoursesTable() {
            const safeCourses = courses.map(course => ({...course, name: safeText(course.name), category: safeText(course.category), instructor: safeText(course.instructor)}));
            coursesTableBody.innerHTML = safeCourses.map(course => `
                <tr>
                    <td>${course.name}</td>
                    <td>${course.category}</td>
                    <td>${course.instructor}</td>
                    <td>¥${course.price}</td>
                    <td>${course.students}</td>
                    <td>
                        <div class="course-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${course.avgProgress}%"></div>
                            </div>
                            <div class="progress-text">${course.avgProgress}%</div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="openCourseEditModal(${course.id})">编辑</button>
                            <button class="delete-btn" onclick="deleteCourse(${course.id})">删除</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // 更新课程统计数据
            updateCourseStats();
        }

        // 渲染公众课表格
        function renderPublicClassesTable() {
            const safePublicClasses = publicClasses.map(publicClass => ({...publicClass, title: safeText(publicClass.title), time: safeText(publicClass.time), platform: safeText(publicClass.platform), description: safeText(publicClass.description)}));
            publicClassesTableBody.innerHTML = safePublicClasses.map(publicClass => `
                <tr>
                    <td>${publicClass.title}</td>
                    <td>${publicClass.time}</td>
                    <td>${publicClass.platform}</td>
                    <td>${publicClass.description}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="openPublicClassEditModal(${publicClass.id})">编辑</button>
                            <button class="delete-btn" onclick="deletePublicClass(${publicClass.id})">删除</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // 更新公众课统计数据
            updatePublicClassStats();
        }

        // 更新学员统计数据
        function updateStudentStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('activeStudents').textContent = students.filter(s => s.progress > 0).length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const newStudents = students.filter(s => {
                const joinDate = new Date(s.joinDate);
                return joinDate.getMonth() === currentMonth && joinDate.getFullYear() === currentYear;
            }).length;
            document.getElementById('newStudents').textContent = newStudents;
            
            const avgProgress = students.reduce((sum, student) => sum + student.progress, 0) / students.length;
            document.getElementById('avgProgress').textContent = `${Math.round(avgProgress)}%`;
        }

        // 更新课程统计数据
        function updateCourseStats() {
            document.getElementById('totalCourses').textContent = courses.length;
            document.getElementById('totalStudentsInCourses').textContent = courses.reduce((sum, course) => sum + course.students, 0);
            
            const avgCourseProgress = courses.reduce((sum, course) => sum + course.avgProgress, 0) / courses.length;
            document.getElementById('avgCourseProgress').textContent = `${Math.round(avgCourseProgress)}%`;
            
            const totalRevenue = courses.reduce((sum, course) => sum + course.price * course.students, 0);
            document.getElementById('totalRevenue').textContent = `¥${totalRevenue.toLocaleString()}`;
        }

        // 更新分组统计数据
        function updateGroupStats() {
            document.getElementById('totalGroups').textContent = groups.length;
            
            const totalStudentsInGroups = groups.reduce((sum, group) => sum + group.studentCount, 0);
            const avgGroupSize = totalStudentsInGroups / groups.length;
            document.getElementById('avgGroupSize').textContent = Math.round(avgGroupSize);
            
            const largestGroup = Math.max(...groups.map(group => group.studentCount));
            document.getElementById('largestGroup').textContent = largestGroup;
            
            const ungroupedStudents = students.filter(student => student.group === "未分组").length;
            document.getElementById('ungroupedStudents').textContent = ungroupedStudents;
        }

        // 新增：渲染留言表格与删除、搜索
        function renderMessagesTable() {
            const messages = JSON.parse(localStorage.getItem('taixuanMessages')) || [];
            const searchInput = document.getElementById('messagesSearch');
            const kw = (searchInput && searchInput.value || '').toLowerCase();

            const filtered = messages.filter(m => {
                const name = (m.name || '').toLowerCase();
                const content = (m.content || '').toLowerCase();
                return !kw || name.includes(kw) || content.includes(kw);
            });

            const tbody = document.getElementById('messagesTableBody');
            const safeMsgs = filtered.map(m => ({
                ...m,
                name: safeText(m.name || ''),
                content: safeText(m.content || '')
            }));

            tbody.innerHTML = safeMsgs.map(m => `
                <tr>
                    <td>${m.name}</td>
                    <td>${m.content}</td>
                    <td>${new Date(m.time).toLocaleString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="save-btn" onclick="replyMessage(${m.id})">回复</button>
                            <button class="delete-btn" onclick="deleteMessage(${m.id})">删除</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('messagesSearch')?.addEventListener('input', renderMessagesTable);

        function deleteMessage(id) {
                const messages = JSON.parse(localStorage.getItem('taixuanMessages')) || [];
                const next = messages.filter(m => m.id !== id);
                localStorage.setItem('taixuanMessages', JSON.stringify(next));
                renderMessagesTable();
                try { if (typeof updateMailIndicator === 'function') updateMailIndicator(); } catch(e) {}
            }

            function publishAnnouncement() {
                const titleEl = document.getElementById('announceTitleInput');
                const contentEl = document.getElementById('announceContentInput');
                if (!titleEl || !contentEl) return;
                const title = safeText(titleEl.value.trim());
                const content = safeText(contentEl.value.trim());
                if (!title || !content) {
                    alert('请填写公告标题和内容');
                    return;
                }
                const anns = JSON.parse(localStorage.getItem('taixuanAnnouncements')) || [];
                const nextId = anns.length ? Math.max(...anns.map(a => a.id || 0)) + 1 : 1;
                const ann = { id: nextId, title, content, time: new Date().toISOString() };
                localStorage.setItem('taixuanAnnouncements', JSON.stringify([ann, ...anns]));
                titleEl.value = '';
                contentEl.value = '';
                alert('公告已发布');
                try { if (typeof updateMailIndicator === 'function') updateMailIndicator(); } catch(e) {}
                renderMail();
                renderAnnouncementsTable();
            }

            // 公告管理：渲染、编辑、删除
            function renderAnnouncementsTable() {
                const anns = JSON.parse(localStorage.getItem('taixuanAnnouncements')) || [];
                const tbody = document.getElementById('announcementsTableBody');
                if (!tbody) return;
                const safeAnns = anns.map(a => ({
                    ...a,
                    title: safeText(a.title || ''),
                    content: safeText(a.content || '')
                }));
                tbody.innerHTML = safeAnns.map(a => `
                    <tr>
                        <td>${a.title}</td>
                        <td>${a.content}</td>
                        <td>${a.time ? new Date(a.time).toLocaleString() : ''}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editAnnouncement(${a.id})">编辑</button>
                                <button class="delete-btn" onclick="deleteAnnouncement(${a.id})">删除</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            function editAnnouncement(id) {
                const anns = JSON.parse(localStorage.getItem('taixuanAnnouncements')) || [];
                const idx = anns.findIndex(a => a.id === id);
                if (idx === -1) return;
                const current = anns[idx];
                const newTitle = prompt('修改公告标题：', current.title || '');
                if (newTitle === null) return;
                const newContent = prompt('修改公告内容：', current.content || '');
                if (newContent === null) return;
                const sTitle = safeText(newTitle.trim());
                const sContent = safeText(newContent.trim());
                if (!sTitle || !sContent) {
                    alert('标题或内容不能为空');
                    return;
                }
                anns[idx].title = sTitle;
                anns[idx].content = sContent;
                anns[idx].time = new Date().toISOString();
                localStorage.setItem('taixuanAnnouncements', JSON.stringify(anns));
                renderAnnouncementsTable();
                renderMail();
                try {
                    const mailModal = document.getElementById('mailModal');
                    if (mailModal && mailModal.style.display === 'flex') {
                        renderMailAnnouncementsModal();
                    }
                } catch(e) {}
                alert('公告已更新');
            }

            function deleteAnnouncement(id) {
                if (!confirm('确认删除该公告？')) return;
                const anns = JSON.parse(localStorage.getItem('taixuanAnnouncements')) || [];
                const next = anns.filter(a => a.id !== id);
                localStorage.setItem('taixuanAnnouncements', JSON.stringify(next));
                renderAnnouncementsTable();
                renderMail();
                try {
                    const mailModal = document.getElementById('mailModal');
                    if (mailModal && mailModal.style.display === 'flex') {
                        renderMailAnnouncementsModal();
                    }
                } catch(e) {}
                alert('公告已删除');
            }

            function replyMessage(id) {
                 const reply = prompt('请输入回复内容：');
                 if (reply === null) return;
                 const safeReply = safeText(reply.trim());
                 if (!safeReply) {
                     alert('回复内容不能为空');
                     return;
                 }
                 const messages = JSON.parse(localStorage.getItem('taixuanMessages')) || [];
                 const idx = messages.findIndex(m => m.id === id);
                 if (idx === -1) return;
                 messages[idx].reply = safeReply;
                 messages[idx].replyTime = new Date().toISOString();
                 messages[idx].replyBy = 'admin';
                 localStorage.setItem('taixuanMessages', JSON.stringify(messages));
                 renderMessagesTable();
                 renderMail();
                 try { if (typeof updateMailIndicator === 'function') updateMailIndicator(); } catch(e) {}
                 // 若弹窗已打开，自动刷新
                 try {
                     const mailModal = document.getElementById('mailModal');
                     if (mailModal && mailModal.style.display === 'flex') {
                         renderMailAnnouncementsModal();
                         renderMailRepliesModal();
                     }
                 } catch(e) {}
                 alert('回复已保存');
             }

        // 弹窗：渲染管理员公告
        function renderMailAnnouncementsModal() {
                const announcements = JSON.parse(localStorage.getItem('taixuanAnnouncements')) || [];
                const container = document.getElementById('mailAnnouncementsModalList');
                if (!container) return;
                container.innerHTML = announcements.length === 0
                    ? '<div style="color:#888;">暂无公告</div>'
                    : announcements.map(a => `
                        <div style="padding:12px 16px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;">
                            <div style="font-weight:600;">${safeText(a.title || '公告')}</div>
                            <div style="color:#666;margin-top:6px;">${safeText(a.content || '')}</div>
                            <div style="color:#999;margin-top:6px;font-size:12px;">${a.time ? new Date(a.time).toLocaleString() : ''}</div>
                        </div>
                    `).join('');
            }

            function renderMailRepliesModal() {
                const currentUser = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                const messages = JSON.parse(localStorage.getItem('taixuanMessages')) || [];
                const uname = safeText(currentUser.username || '');
                const mine = uname ? messages.filter(m => m.user === uname) : [];
                const repContainer = document.getElementById('mailRepliesModalList');
                if (!repContainer) return;
                repContainer.innerHTML = mine.length === 0
                    ? '<div style="color:#888;">暂无您的留言记录或尚未登录</div>'
                    : mine
                        .sort((a, b) => new Date(b.time) - new Date(a.time))
                        .map(m => `
                            <div style="padding:12px 16px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;">
                                <div style="font-weight:600;">我的留言</div>
                                <div style="color:#333;margin-top:6px;">${safeText(m.content || '')}</div>
                                <div style="color:#999;margin-top:6px;font-size:12px;">${new Date(m.time).toLocaleString()}</div>
                                <div style="margin-top:10px;border-top:1px dashed #eee;padding-top:8px;">
                                    <div style="font-weight:600;">管理员回复</div>
                                    <div style="color:#444;margin-top:6px;">${safeText(m.reply || '尚未回复')}</div>
                                </div>
                            </div>
                        `).join('');
                // 标记已读：当前用户的有回复且未读的留言
                if (uname) {
                    let changed = false;
                    messages.forEach(m => {
                        if (m.user === uname && m.reply && String(m.reply).trim() !== '' && !m.replyRead) {
                            m.replyRead = true;
                            changed = true;
                        }
                    });
                    if (changed) {
                        localStorage.setItem('taixuanMessages', JSON.stringify(messages));
                        try { if (typeof updateMailIndicator === 'function') updateMailIndicator(); } catch(e) {}
                    }
                }
            }

        // 新增：渲染“邮件中心”内容
        function renderMail() {
            const announcements = JSON.parse(localStorage.getItem('taixuanAnnouncements')) || [];
            const annBody = document.getElementById('mailAnnouncementsList');
            if (annBody) {
                annBody.innerHTML = announcements.length === 0
                    ? '<div style="color:#888;">暂无公告</div>'
                    : announcements.map(a => `
                        <div style="padding:12px 16px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;">
                            <div style="font-weight:600;">${safeText(a.title || '公告')}</div>
                            <div style="color:#666;margin-top:6px;">${safeText(a.content || '')}</div>
                            <div style="color:#999;margin-top:6px;font-size:12px;">${a.time ? new Date(a.time).toLocaleString() : ''}</div>
                        </div>
                    `).join('');
            }

            const currentUser = JSON.parse(localStorage.getItem('taixuanUser')) || {};
            const messages = JSON.parse(localStorage.getItem('taixuanMessages')) || [];
            const uname = safeText(currentUser.username || '');
            const mine = uname ? messages.filter(m => m.user === uname) : [];
            const repBody = document.getElementById('mailRepliesList');
            if (repBody) {
                repBody.innerHTML = mine.length === 0
                    ? '<div style="color:#888;">暂无您的留言记录或尚未登录</div>'
                    : mine
                        .sort((a, b) => new Date(b.time) - new Date(a.time))
                        .map(m => `
                            <div style="padding:12px 16px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;">
                                <div style="font-weight:600;">我的留言</div>
                                <div style="color:#333;margin-top:6px;">${safeText(m.content || '')}</div>
                                <div style="color:#999;margin-top:6px;font-size:12px;">${new Date(m.time).toLocaleString()}</div>
                                <div style="margin-top:10px;border-top:1px dashed #eee;padding-top:8px;">
                                    <div style="font-weight:600;">管理员回复</div>
                                    <div style="color:#444;margin-top:6px;">${safeText(m.reply || '尚未回复')}</div>
                                </div>
                            </div>
                        `).join('');
            }
        }

        // 更新公众课统计数据
        function updatePublicClassStats() {
            document.getElementById('totalPublicClasses').textContent = publicClasses.length;
            
            const weeklyClasses = publicClasses.filter(pc => pc.time.includes('每周')).length;
            document.getElementById('weeklyClasses').textContent = weeklyClasses;
            
            const monthlyClasses = publicClasses.filter(pc => pc.time.includes('每月')).length;
            document.getElementById('monthlyClasses').textContent = monthlyClasses;
            
            // 这里可以计算总参与人数，假设每个公众课有固定参与人数
            document.getElementById('totalAttendance').textContent = publicClasses.length * 50; // 假设每堂课50人
        }

        // 辅助：渲染课程复选框列表，并与文本框同步
        function renderCourseCheckboxList(selectedIds = []) {
            const container = document.getElementById('editStudentCoursesList');
            if (!container) return;

            container.innerHTML = '';
            const selectedSet = new Set((selectedIds || []).map(id => String(id)));

            courses.forEach(course => {
                const wrapper = document.createElement('label');
                wrapper.style.display = 'block';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = String(course.id);
                cb.checked = selectedSet.has(String(course.id));
                cb.addEventListener('change', syncSelectedCoursesToTextarea);

                const text = document.createTextNode(`${course.name}（ID: ${course.id}）`);

                wrapper.appendChild(cb);
                wrapper.appendChild(text);
                container.appendChild(wrapper);
            });

            // 初始同步一次到文本框
            syncSelectedCoursesToTextarea();
        }

        function syncSelectedCoursesToTextarea() {
            const selectedIds = Array
                .from(document.querySelectorAll('#editStudentCoursesList input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            const textarea = document.getElementById('editStudentCourses');
            if (textarea) {
                textarea.value = selectedIds.join(', ');
            }
        }

        // 打开学员编辑弹窗
        function openStudentEditModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('editStudentName').value = student.name;
                document.getElementById('editStudentEmail').value = student.email;
                document.getElementById('editStudentJoinDate').value = student.joinDate;
                document.getElementById('editStudentProgress').value = student.progress;
                document.getElementById('editStudentStudyTime').value = student.studyTime;
                document.getElementById('editStudentCourses').value = student.courses.join(', ');
                // 渲染课程复选框列表
                renderCourseCheckboxList(student.courses);
                
                // 填充分组下拉菜单
                const groupSelect = document.getElementById('editStudentGroup');
                groupSelect.innerHTML = '';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.name;
                    option.textContent = group.name;
                    if (group.name === student.group) {
                        option.selected = true;
                    }
                    groupSelect.appendChild(option);
                });
                
                // 设置表单提交时的学员ID
                studentEditForm.setAttribute('data-student-id', studentId);
                studentEditTitle.textContent = '编辑学员';
                
                studentEditModal.style.display = 'flex';
            }
        }

        // 关闭学员编辑弹窗
        closeStudentEditModal.addEventListener('click', function() {
            studentEditModal.style.display = 'none';
        });

        cancelStudentEdit.addEventListener('click', function() {
            studentEditModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === studentEditModal) {
                studentEditModal.style.display = 'none';
            }
        });

        // 学员编辑表单提交
        studentEditForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = parseInt(this.getAttribute('data-student-id'));
            const studentIndex = students.findIndex(s => s.id === studentId);
            
            // 统一读取课程选择（优先复选框，其次文本框，支持名称→ID）
            const selectedFromCheckbox = Array
                .from(document.querySelectorAll('#editStudentCoursesList input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.value))
                .filter(n => !isNaN(n));
            const tokens = document
                .getElementById('editStudentCourses')
                .value
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
            const fallbackFromTextarea = tokens
                .map(tok => {
                    const n = parseInt(tok);
                    if (!isNaN(n)) return n;
                    const match = courses.find(c => c.name === tok || c.name.toLowerCase() === tok.toLowerCase());
                    return match ? match.id : null;
                })
                .filter(n => n !== null);
            const finalCourses = selectedFromCheckbox.length > 0 ? selectedFromCheckbox : fallbackFromTextarea;
            
            if (studentIndex !== -1) {
                // 更新学员数据
                students[studentIndex] = {
                    ...students[studentIndex],
                    name: document.getElementById('editStudentName').value,
                    email: document.getElementById('editStudentEmail').value,
                    group: document.getElementById('editStudentGroup').value,
                    joinDate: document.getElementById('editStudentJoinDate').value,
                    progress: parseInt(document.getElementById('editStudentProgress').value) || 0,
                    studyTime: parseInt(document.getElementById('editStudentStudyTime').value) || 0,
                    courses: finalCourses
                };
            } else {
                // 添加新学员
                const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
                students.push({
                    id: newId,
                    name: document.getElementById('editStudentName').value,
                    email: document.getElementById('editStudentEmail').value,
                    group: document.getElementById('editStudentGroup').value,
                    joinDate: document.getElementById('editStudentJoinDate').value,
                    progress: parseInt(document.getElementById('editStudentProgress').value) || 0,
                    studyTime: parseInt(document.getElementById('editStudentStudyTime').value) || 0,
                    courses: finalCourses
                });
            }
            
            // 保存到localStorage
            localStorage.setItem('taixuanStudents', JSON.stringify(students));
            
            // 更新学员表格
            renderStudentsTable();
            
            // 更新分组表格
            renderGroupsTable();
            
            // 关闭弹窗
            studentEditModal.style.display = 'none';
            
            // 显示成功消息
            alert('学员信息已成功保存！');
        });

        // 添加新学员
        addStudentBtn.addEventListener('click', function() {
            // 清空表单
            document.getElementById('editStudentName').value = '';
            document.getElementById('editStudentEmail').value = '';
            document.getElementById('editStudentJoinDate').value = '';
            document.getElementById('editStudentProgress').value = '';
            document.getElementById('editStudentStudyTime').value = '';
            document.getElementById('editStudentCourses').value = '';
            // 渲染课程复选框列表（新学员默认不勾选）
            renderCourseCheckboxList([]);
            
            // 填充分组下拉菜单
            const groupSelect = document.getElementById('editStudentGroup');
            groupSelect.innerHTML = '';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.name;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
            
            // 设置表单提交时的学员ID
            studentEditForm.setAttribute('data-student-id', '');
            studentEditTitle.textContent = '添加新学员';
            
            studentEditModal.style.display = 'flex';
        });

        // 删除学员
        function deleteStudent(studentId) {
            if (confirm('确定要删除这个学员吗？此操作不可撤销。')) {
                const target = students.find(s => s.id === studentId);
                students = students.filter(s => s.id !== studentId);
                
                // 保存到localStorage
                localStorage.setItem('taixuanStudents', JSON.stringify(students));
                
                // 若存在同邮箱/同用户名的会员，同步注销其会员资格
                if (target) {
                    const mlist = getMembers();
                    const match = mlist.find(x =>
                        (x.email && x.email === target.email) ||
                        (x.username && x.username === target.name)
                    );
                    if (match) {
                        revokeMember(match.email);
                    }
                }

                // 更新学员表格
                renderStudentsTable();
                
                // 更新分组表格
                renderGroupsTable();
                
                alert('学员已删除');
            }
        }

        // 打开分组编辑弹窗
        function openGroupEditModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                document.getElementById('editGroupName').value = group.name;
                document.getElementById('editGroupManager').value = group.manager;
                document.getElementById('editGroupCreateDate').value = group.createDate;
                document.getElementById('editGroupDescription').value = group.description || '';
                // 设置班组级别（默认为1：绿）
                const levelEl = document.getElementById('editGroupLevel');
                if (levelEl) levelEl.value = String(group.level || 1);
                
                // 设置表单提交时的分组ID
                groupEditForm.setAttribute('data-group-id', groupId);
                groupEditTitle.textContent = '编辑分组';
                
                groupEditModal.style.display = 'flex';
            }
        }

        // 关闭分组编辑弹窗
        closeGroupEditModal.addEventListener('click', function() {
            groupEditModal.style.display = 'none';
        });

        cancelGroupEdit.addEventListener('click', function() {
            groupEditModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === groupEditModal) {
                groupEditModal.style.display = 'none';
            }
        });

        // 分组编辑表单提交
        groupEditForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const groupId = parseInt(this.getAttribute('data-group-id'));
            const groupIndex = groups.findIndex(g => g.id === groupId);
            
            if (groupIndex !== -1) {
                // 更新分组数据
                groups[groupIndex] = {
                    ...groups[groupIndex],
                    name: document.getElementById('editGroupName').value,
                    manager: document.getElementById('editGroupManager').value,
                    createDate: document.getElementById('editGroupCreateDate').value,
                    description: document.getElementById('editGroupDescription').value,
                    level: parseInt(document.getElementById('editGroupLevel').value) || 1
                };
            } else {
                // 添加新分组
                const newId = groups.length > 0 ? Math.max(...groups.map(g => g.id)) + 1 : 1;
                groups.push({
                    id: newId,
                    name: document.getElementById('editGroupName').value,
                    manager: document.getElementById('editGroupManager').value,
                    createDate: document.getElementById('editGroupCreateDate').value,
                    description: document.getElementById('editGroupDescription').value,
                    level: parseInt(document.getElementById('editGroupLevel').value) || 1,
                    studentCount: 0
                });
            }
            
            // 保存到localStorage
            localStorage.setItem('taixuanGroups', JSON.stringify(groups));
            
            // 更新分组表格
            renderGroupsTable();
            
            // 关闭弹窗
            groupEditModal.style.display = 'none';
            
            // 显示成功消息
            alert('分组信息已成功保存！');
        });

        // 添加新分组
        addGroupBtn.addEventListener('click', function() {
            // 清空表单
            document.getElementById('editGroupName').value = '';
            document.getElementById('editGroupManager').value = '荡气';
            document.getElementById('editGroupCreateDate').value = '';
            document.getElementById('editGroupDescription').value = '';
            const levelEl = document.getElementById('editGroupLevel');
            if (levelEl) levelEl.value = '1';
            
            // 设置表单提交时的分组ID
            groupEditForm.setAttribute('data-group-id', '');
            groupEditTitle.textContent = '添加新分组';
            
            groupEditModal.style.display = 'flex';
        });

        // 删除分组
        function deleteGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            // 检查是否有学员属于这个分组
            const studentsInGroup = students.filter(s => s.group === group.name);
            
            if (studentsInGroup.length > 0) {
                alert(`无法删除分组"${group.name}"，因为还有${studentsInGroup.length}名学员属于这个分组。请先将这些学员分配到其他分组。`);
                return;
            }
            
            if (confirm('确定要删除这个分组吗？此操作不可撤销。')) {
                groups = groups.filter(g => g.id !== groupId);
                
                // 保存到localStorage
                localStorage.setItem('taixuanGroups', JSON.stringify(groups));
                
                // 更新分组表格
                renderGroupsTable();
                
                alert('分组已删除');
            }
        }

        // 打开课程编辑弹窗
        function openCourseEditModal(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (course) {
                document.getElementById('editCourseName').value = course.name;
                document.getElementById('editCourseCategory').value = course.category;
                document.getElementById('editCourseInstructor').value = course.instructor;
                document.getElementById('editCoursePrice').value = course.price;
                document.getElementById('editCourseLevel').value = course.level;
                document.getElementById('editCourseDuration').value = course.duration;
                document.getElementById('editCourseStudents').value = course.students;
                document.getElementById('editCourseProgress').value = course.avgProgress;
                document.getElementById('editCourseDescription').value = course.description;
                // 新增：填充封面图URL
                document.getElementById('editCourseImageUrl').value = course.imageUrl || '';
                
                // 设置表单提交时的课程ID
                courseEditForm.setAttribute('data-course-id', courseId);
                courseEditTitle.textContent = '编辑课程';
                
                courseEditModal.style.display = 'flex';
            }
        }

        // 关闭课程编辑弹窗
        closeCourseEditModal.addEventListener('click', function() {
            courseEditModal.style.display = 'none';
        });

        cancelCourseEdit.addEventListener('click', function() {
            courseEditModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === courseEditModal) {
                courseEditModal.style.display = 'none';
            }
        });

        // 课程编辑表单提交
        courseEditForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courseId = parseInt(this.getAttribute('data-course-id'));
            const courseIndex = courses.findIndex(c => c.id === courseId);
            
            if (courseIndex !== -1) {
                // 更新课程数据
                courses[courseIndex] = {
                    ...courses[courseIndex],
                    name: document.getElementById('editCourseName').value,
                    category: document.getElementById('editCourseCategory').value,
                    instructor: document.getElementById('editCourseInstructor').value,
                    price: parseInt(document.getElementById('editCoursePrice').value) || 0,
                    level: document.getElementById('editCourseLevel').value,
                    duration: parseInt(document.getElementById('editCourseDuration').value) || 0,
                    students: parseInt(document.getElementById('editCourseStudents').value) || 0,
                    avgProgress: parseInt(document.getElementById('editCourseProgress').value) || 0,
                    description: document.getElementById('editCourseDescription').value,
                    imageUrl: document.getElementById('editCourseImageUrl').value
                };
            } else {
                // 添加新课程
                const newId = courses.length > 0 ? Math.max(...courses.map(c => c.id)) + 1 : 1;
                courses.push({
                    id: newId,
                    name: document.getElementById('editCourseName').value,
                    category: document.getElementById('editCourseCategory').value,
                    instructor: document.getElementById('editCourseInstructor').value,
                    price: parseInt(document.getElementById('editCoursePrice').value) || 0,
                    level: document.getElementById('editCourseLevel').value,
                    duration: parseInt(document.getElementById('editCourseDuration').value) || 0,
                    students: parseInt(document.getElementById('editCourseStudents').value) || 0,
                    avgProgress: parseInt(document.getElementById('editCourseProgress').value) || 0,
                    description: document.getElementById('editCourseDescription').value,
                    imageUrl: document.getElementById('editCourseImageUrl').value
                });
            }
            
            // 保存到localStorage
            localStorage.setItem('taixuanCourses', JSON.stringify(courses));
            
            // 更新课程表格
            renderCoursesTable();
            
            // 更新首页课程展示
            renderCourseCards();
            
            // 关闭弹窗
            courseEditModal.style.display = 'none';
            
            // 显示成功消息
            alert('课程信息已成功保存！');
        });

        // 添加新课程
        addCourseBtn.addEventListener('click', function() {
            // 清空表单
            document.getElementById('editCourseName').value = '';
            document.getElementById('editCourseCategory').value = '易经基础';
            document.getElementById('editCourseInstructor').value = '荡气';
            document.getElementById('editCoursePrice').value = '';
            document.getElementById('editCourseLevel').value = 'bronze';
            document.getElementById('editCourseDuration').value = '';
            document.getElementById('editCourseStudents').value = '';
            document.getElementById('editCourseProgress').value = '';
            document.getElementById('editCourseDescription').value = '';
            // 新增：清空封面图URL
            document.getElementById('editCourseImageUrl').value = '';
            
            // 设置表单提交时的课程ID
            courseEditForm.setAttribute('data-course-id', '');
            courseEditTitle.textContent = '添加新课程';
            
            courseEditModal.style.display = 'flex';
        });

        // 删除课程
        function deleteCourse(courseId) {
            if (confirm('确定要删除这个课程吗？此操作不可撤销。')) {
                courses = courses.filter(c => c.id !== courseId);
                
                // 保存到localStorage
                localStorage.setItem('taixuanCourses', JSON.stringify(courses));
                
                // 更新首页课程展示
                renderCourseCards();
                
                // 更新课程管理表格
                renderCoursesTable();
                
                alert('课程已删除');
            }
        }

        // 打开公众课编辑弹窗
        function openPublicClassEditModal(publicClassId) {
            const publicClass = publicClasses.find(pc => pc.id === publicClassId);
            if (publicClass) {
                document.getElementById('editPublicClassName').value = publicClass.title;
                document.getElementById('editPublicClassTime').value = publicClass.time;
                document.getElementById('editPublicClassPlatform').value = publicClass.platform;
                document.getElementById('editPublicClassDescription').value = publicClass.description;
                
                // 设置表单提交时的公众课ID
                publicClassEditForm.setAttribute('data-public-class-id', publicClassId);
                publicClassEditTitle.textContent = '编辑公众课';
                
                publicClassEditModal.style.display = 'flex';
            }
        }

        // 关闭公众课编辑弹窗
        closePublicClassEditModal.addEventListener('click', function() {
            publicClassEditModal.style.display = 'none';
        });

        cancelPublicClassEdit.addEventListener('click', function() {
            publicClassEditModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === publicClassEditModal) {
                publicClassEditModal.style.display = 'none';
            }
        });

        // 公众课编辑表单提交
        publicClassEditForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const publicClassId = parseInt(this.getAttribute('data-public-class-id'));
            const publicClassIndex = publicClasses.findIndex(pc => pc.id === publicClassId);
            
            if (publicClassIndex !== -1) {
                // 更新公众课数据
                publicClasses[publicClassIndex] = {
                    ...publicClasses[publicClassIndex],
                    title: document.getElementById('editPublicClassName').value,
                    time: document.getElementById('editPublicClassTime').value,
                    platform: document.getElementById('editPublicClassPlatform').value,
                    description: document.getElementById('editPublicClassDescription').value
                };
            } else {
                // 添加新公众课
                const newId = publicClasses.length > 0 ? Math.max(...publicClasses.map(pc => pc.id)) + 1 : 1;
                publicClasses.push({
                    id: newId,
                    title: document.getElementById('editPublicClassName').value,
                    time: document.getElementById('editPublicClassTime').value,
                    platform: document.getElementById('editPublicClassPlatform').value,
                    description: document.getElementById('editPublicClassDescription').value
                });
            }
            
            // 保存到localStorage
            localStorage.setItem('taixuanPublicClasses', JSON.stringify(publicClasses));
            
            // 更新公众课表格
            renderPublicClassesTable();
            
            // 更新首页公众课展示
            renderPublicClasses();
            
            // 关闭弹窗
            publicClassEditModal.style.display = 'none';
            
            // 显示成功消息
            alert('公众课信息已成功保存！');
        });

        // 添加新公众课
        addPublicClassBtn.addEventListener('click', function() {
            // 清空表单
            document.getElementById('editPublicClassName').value = '';
            document.getElementById('editPublicClassTime').value = '';
            document.getElementById('editPublicClassPlatform').value = '';
            document.getElementById('editPublicClassDescription').value = '';
            
            // 设置表单提交时的公众课ID
            publicClassEditForm.setAttribute('data-public-class-id', '');
            publicClassEditTitle.textContent = '添加新公众课';
            
            publicClassEditModal.style.display = 'flex';
        });

        // 删除公众课
        function deletePublicClass(publicClassId) {
            if (confirm('确定要删除这个公众课吗？此操作不可撤销。')) {
                publicClasses = publicClasses.filter(pc => pc.id !== publicClassId);
                
                // 保存到localStorage
                localStorage.setItem('taixuanPublicClasses', JSON.stringify(publicClasses));
                
                // 更新公众课表格
                renderPublicClassesTable();
                
                // 更新首页公众课展示
                renderPublicClasses();
                
                alert('公众课已删除');
            }
        }

        // 管理员标签切换
        adminTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // 更新标签状态
                adminTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // 显示对应的面板
                adminPanels.forEach(panel => {
                    panel.style.display = 'none';
                    if (panel.id === `${tabName}-panel`) {
                        panel.style.display = 'block';
                    }
                });
                
                // 根据标签加载相应数据
                if (tabName === 'students') {
                    renderStudentsTable();
                } else if (tabName === 'courses') {
                    renderCoursesTable();
                } else if (tabName === 'groups') {
                    renderGroupsTable();
                } else if (tabName === 'public-classes') {
                    renderPublicClassesTable();
                } else if (tabName === 'whitelist') {
                    renderWhitelist();
                } else if (tabName === 'messages') {
                    renderMessagesTable();
                    renderAnnouncementsTable();
                } else if (tabName === 'stats') {
                    updateStatsData();
                } else if (tabName === 'user-stats') {
                    // 显示用户属性面板
                    document.getElementById('user-stats-panel').style.display = 'block';
                    // 预填当前用户数据
                    try {
                        const cu = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                        const level = Number(cu.level || 1);
                        const xp = Number(cu.xp || 0);
                        const coins = Number(cu.coins || 0);
                        document.getElementById('currentLevel').textContent = 'Lv' + level;
                        document.getElementById('currentCoins').textContent = String(coins);
                        document.getElementById('statsLevel').value = level;
                        document.getElementById('statsXp').value = xp;
                        document.getElementById('statsCoins').value = coins;
                        const threshold = getLevelThreshold(level);
                        const pct = (level < 6 && isFinite(threshold)) ? Math.round(Math.min(100, (xp / threshold) * 100)) : 100;
                        const labelEl = document.getElementById('currentProgressLabel');
                        const barEl = document.getElementById('currentProgressBar');
                        if (labelEl) labelEl.textContent = (level < 6 && isFinite(threshold)) ? (xp + '/' + threshold) : '满级';
                        if (barEl) barEl.style.width = pct + '%';
                    } catch(e) {}
                } else if (tabName === 'discount-codes') {
                    document.getElementById('discount-codes-panel').style.display = 'block';
                    renderDiscountCodesTable();
                    const searchInput = document.getElementById('discountCodeSearch');
                    if (searchInput && !searchInput.dataset.bound) {
                        searchInput.addEventListener('input', () => renderDiscountCodesTable(searchInput.value.trim()));
                        searchInput.dataset.bound = '1';
                    }
                } else if (tabName === 'vip-codes') {
                    document.getElementById('vip-codes-panel').style.display = 'block';
                    renderVipCodesDesktop();
                }
            });
        });

        // 更新统计数据
        function updateStatsData() {
            const totalRevenue = courses.reduce((sum, course) => sum + course.price * course.students, 0);
            document.getElementById('statsTotalRevenue').textContent = '¥' + totalRevenue.toLocaleString();
            document.getElementById('monthlyRevenue').textContent = '¥' + Math.round(totalRevenue * 0.1).toLocaleString();
            
            const courseCompletion = students.reduce((sum, student) => sum + student.progress, 0) / students.length;
            document.getElementById('courseCompletion').textContent = `${Math.round(courseCompletion)}%`;
            
            const activeRate = (students.filter(s => s.progress > 0).length / students.length) * 100;
            document.getElementById('activeRate').textContent = `${Math.round(activeRate)}%`;
            
            // 渲染热门课程
            const popularCourses = document.getElementById('popularCourses');
            const sortedCourses = [...courses].sort((a, b) => b.students - a.students);
            popularCourses.innerHTML = sortedCourses.slice(0, 5).map(course => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <span>${course.name}</span>
                    <span style="color: var(--admin-color); font-weight: bold;">${course.students}人</span>
                </div>
            `).join('');
            
            // 渲染分组分布
            const groupDistribution = document.getElementById('groupDistribution');
            groupDistribution.innerHTML = groups.map(group => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <span>${group.name}</span>
                    <span style="color: var(--admin-color); font-weight: bold;">${group.studentCount}人</span>
                </div>
            `).join('');
        }

        // 折扣激活码辅助函数与事件
        function getDiscountCodes() {
            return JSON.parse(localStorage.getItem('taixuanDiscountCodes')) || [];
        }
        function saveDiscountCodes(codes) {
            localStorage.setItem('taixuanDiscountCodes', JSON.stringify(codes));
        }
        function computeFinalPrice(price, discountPercent) {
            return Math.round(price * (1 - (Number(discountPercent) || 0) / 100));
        }
        function openDiscountModal(course) {
            try {
                if (requireAdmin && typeof requireAdmin === 'function' && requireAdmin()) {
                    alert('管理员不能购买课程');
                    return;
                }
                const modal = document.getElementById('discountModal');
                const nameEl = document.getElementById('discountCourseName');
                const origEl = document.getElementById('discountOriginalPrice');
                const coinsEl = document.getElementById('discountUserCoins');
                const finalEl = document.getElementById('discountFinalPrice');
                const noneOpt = document.getElementById('discountNone');
                const opt5 = document.getElementById('discount5');
                const opt10 = document.getElementById('discount10');
                const confirmBtn = document.getElementById('confirmDiscountBtn');
                const cancelBtn = document.getElementById('cancelDiscountBtn');
                const closeBtn = document.getElementById('closeDiscountModal');
                const codeInfo = document.getElementById('discountCodeInfo');
                const codeText = document.getElementById('generatedDiscountCode');
                const codeLink = document.getElementById('generatedDiscountLink');

                const cu = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                const userCoins = Number(cu.coins || 0);
                nameEl.textContent = course.name;
                origEl.textContent = String(course.price || 0);
                coinsEl.textContent = String(userCoins);

                // 根据铜币禁用不可用选项
                 opt5.disabled = userCoins < 50;
                 opt10.disabled = userCoins < 100;
                 noneOpt.checked = true;
                 codeInfo.style.display = 'none';

                function recalc() {
                    const selected = document.querySelector('input[name="discountOption"]:checked');
                    const dp = Number(selected ? selected.value : 0);
                    finalEl.textContent = String(computeFinalPrice(Number(course.price || 0), dp));
                }
                [noneOpt, opt5, opt10].forEach(r => r && r.addEventListener('change', recalc, { once: false }));
                recalc();

                function closeModal() { modal.style.display = 'none'; }
                closeBtn.onclick = closeModal;
                cancelBtn.onclick = closeModal;

                confirmBtn.onclick = function() {
                    const selected = document.querySelector('input[name="discountOption"]:checked');
                    const discountPercent = Number(selected ? selected.value : 0);
                    const coinsNeeded = discountPercent === 10 ? 100 : (discountPercent === 5 ? 50 : 0);
                    if (userCoins < coinsNeeded) {
                        alert('铜币不足，无法选择该优惠。');
                        return;
                    }
                    const cu2 = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                    if (!cu2.email && !cu2.username) {
                        alert('请登录并完善邮箱或用户名后再申请激活码');
                        return;
                    }
                    const key = (cu2.email || cu2.username) + '::' + (course.id || course.name);
                    const listAll = getDiscountCodes();
                    const hasPendingOrApproved = listAll.some(it => {
                        const itKey = (it.studentEmail || it.studentName) + '::' + (it.courseId || it.courseName);
                        return itKey === key && (it.status === 'pending' || it.status === 'approved');
                    });
                    if (hasPendingOrApproved) {
                        alert('申请期间不可重复申请或已通过，不能重复申请');
                        return;
                    }

                    const finalPrice = computeFinalPrice(Number(course.price || 0), discountPercent);
                    const code = ('DC' + Math.random().toString(36).slice(2, 8) + Date.now().toString(36).slice(-2)).toUpperCase();
                    const now = new Date().toISOString();
                    const item = {
                        id: code,
                        code,
                        studentName: cu2.username || '',
                        studentEmail: cu2.email || '',
                        courseId: course.id,
                        courseName: course.name,
                        originalPrice: Number(course.price || 0),
                        discountPercent,
                        coinsUsed: coinsNeeded,
                        finalPrice,
                        status: 'pending',
                        createdAt: now
                    };
                    const list = getDiscountCodes();
                    list.unshift(item);
                    saveDiscountCodes(list);

                    // 显示生成结果
                    codeText.textContent = code;
                    codeLink.href = '#';
                    codeLink.textContent = '激活码：' + code;
                    codeInfo.style.display = 'block';
                    alert('激活码已生成，等待管理员审批');
                };

                modal.style.display = 'flex';
            } catch (e) {
                console.error(e);
                alert('打开优惠弹窗失败');
            }
        }
        function renderDiscountCodesTable(keyword) {
            const tbody = document.getElementById('discountCodesTableBody');
            if (!tbody) return;
            const list = getDiscountCodes();
            const kw = (keyword || '').toLowerCase();
            const filtered = list.filter(it => {
                if (it.status === 'rejected' || it.status === 'approved') return false; // 隐藏已驳回与已通过记录，仅显示待审
                const s = [it.code, it.studentName, it.studentEmail, it.courseName, it.status].join(' ').toLowerCase();
                return !kw || s.includes(kw);
            });
            tbody.innerHTML = filtered.map(it => `
                <tr>
                    <td>${safeText(it.code)}</td>
                    <td>${safeText(it.studentName || '-')}</td>
                    <td>${safeText(it.studentEmail || '-')}</td>
                    <td>${safeText(it.courseName)}</td>
                    <td>¥${Number(it.originalPrice)}</td>
                    <td>${Number(it.discountPercent)}%</td>
                    <td>${Number(it.coinsUsed || 0)}</td>
                    <td>${safeText(it.status)}</td>
                    <td>${safeText(new Date(it.createdAt).toLocaleString())}</td>
                    <td>
                        <button class="save-btn" data-action="approve" data-id="${safeText(it.id)}" ${it.status==='approved'?'disabled':''}>通过</button>
                        <button class="cancel-btn" data-action="reject" data-id="${safeText(it.id)}" ${it.status==='rejected'?'disabled':''}>驳回</button>
                    </td>
                </tr>
            `).join('');
            // 绑定按钮事件
            Array.from(tbody.querySelectorAll('button[data-action]')).forEach(btn => {
                btn.onclick = function() {
                    const id = this.getAttribute('data-id');
                    const act = this.getAttribute('data-action');
                    if (act === 'approve') approveDiscountCode(id);
                    else if (act === 'reject') rejectDiscountCode(id);
                };
            });
        }
        function approveDiscountCode(id) {
            if (!requireAdmin()) { alert('需要管理员权限'); return; }
            const list = getDiscountCodes();
            const idx = list.findIndex(i => i.id === id);
            if (idx < 0) return;
            const item = list[idx];
            if (item.status === 'approved') {
                alert('该激活码已审批通过');
                return;
            }
            // 已拥有该课程则拒绝审批，防止重复激活
            try {
                const stuIdx = students.findIndex(s => (item.studentEmail && s.email === item.studentEmail) || (s.name === item.studentName));
                if (stuIdx >= 0) {
                    const sc = students[stuIdx].courses;
                    if (Array.isArray(sc) && sc.includes(item.courseName)) {
                        alert('该用户已购买并激活该课程，不能重复激活');
                        item.status = 'rejected';
                        list[idx] = item;
                        saveDiscountCodes(list);
                        renderDiscountCodesTable();
                        return;
                    }
                }
            } catch(e) {}
            // 铜币扣除（members与taixuanUser）
            try {
                const members = getMembers();
                const cu = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                const mIdx = members.findIndex(m => (item.studentEmail && m.email === item.studentEmail) || (m.username && m.username === item.studentName));
                if (mIdx >= 0) {
                    const coins = Number(members[mIdx].coins || 0);
                    const need = Number(item.coinsUsed || 0);
                    if (coins < need) {
                        alert('会员铜币不足，无法审批通过');
                        return;
                    }
                    members[mIdx].coins = coins - need;
                    saveMembers(members);
                }
                if (cu && (cu.username === item.studentName || cu.email === item.studentEmail)) {
                    const ccoins = Number(cu.coins || 0);
                    const need = Number(item.coinsUsed || 0);
                    if (ccoins < need) {
                        alert('当前登录用户铜币不足，无法审批通过');
                        return;
                    }
                    cu.coins = ccoins - need;
                    localStorage.setItem('taixuanUser', JSON.stringify(cu));
                    const coinsEl = document.getElementById('currentCoins');
                    if (coinsEl) coinsEl.textContent = String(cu.coins);
                }
            } catch(e) {}
            // 纳入课程到学员
            try {
                const stuIdx = students.findIndex(s => (item.studentEmail && s.email === item.studentEmail) || (s.name === item.studentName));
                let student;
                if (stuIdx >= 0) {
                    student = students[stuIdx];
                } else {
                    student = {
                        id: 'S' + Date.now(),
                        name: item.studentName || (item.studentEmail || '匿名用户'),
                        email: item.studentEmail || '',
                        studyTime: 0,
                        courses: [],
                        progress: 0,
                        groupId: null,
                        joinDate: new Date().toISOString()
                    };
                    students.push(student);
                }
                if (!Array.isArray(student.courses)) student.courses = [];
                if (!student.courses.includes(item.courseName)) student.courses.push(item.courseName);
                // 更新课程统计
                const cIdx = courses.findIndex(c => c.id === item.courseId);
                if (cIdx >= 0) {
                    const current = Number(courses[cIdx].students || 0);
                    courses[cIdx].students = current + 1;
                }
                // 保存学员与课程
                localStorage.setItem('taixuanStudents', JSON.stringify(students));
                localStorage.setItem('taixuanCourses', JSON.stringify(courses));
                // 刷新个人课程页（如有）
                try { if (typeof updateMyCoursesData === 'function') updateMyCoursesData(); } catch(e) {}
            } catch(e) {}
            // 设为通过并保存
            item.status = 'approved';
            list[idx] = item;
            saveDiscountCodes(list);
            renderDiscountCodesTable();
            alert('审批通过并已纳入课程');
        }
        function rejectDiscountCode(id) {
            if (!requireAdmin()) { alert('需要管理员权限'); return; }
            const list = getDiscountCodes();
            const idx = list.findIndex(i => i.id === id);
            if (idx < 0) return;
            if (list[idx].status === 'approved') {
                alert('该激活码已通过，不能驳回');
                return;
            }
            list[idx].status = 'rejected';
            saveDiscountCodes(list);
            renderDiscountCodesTable();
            alert('已驳回该激活码');
        }
        function deleteDiscountCode(id) {
            const all = getDiscountCodes();
            const list = all.filter(i => i.id !== id);
            saveDiscountCodes(list);
            renderDiscountCodesTable();
        }

        // VIP激活码管理（桌面端）
        function getVipCodes(){
            try { return JSON.parse(localStorage.getItem('taixuanVipCodes')) || []; } catch(e){ return []; }
        }
        function saveVipCodes(list){
            localStorage.setItem('taixuanVipCodes', JSON.stringify(list));
        }
        function generateVipCode(plan){
            const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let s = '';
            for (let i=0;i<8;i++){ s += alphabet[Math.floor(Math.random()*alphabet.length)]; }
            const prefix = plan === 'yearly' ? 'VIP-Y-' : plan === 'monthly' ? 'VIP-M-' : 'VIP-';
            return prefix + s;
        }
        function renderVipCodesDesktop(){
            const tbody = document.getElementById('vipCodesTableBodyDesktop');
            const empty = document.getElementById('vipCodesEmptyDesktop');
            if (!tbody) return;
            const list = getVipCodes();
            if (!list.length) {
                if (empty) empty.style.display = 'table-row';
                tbody.innerHTML = '';
                return;
            }
            if (empty) empty.style.display = 'none';
            tbody.innerHTML = list.map(item => {
                const issued = item.issuedTo || '-';
                const user = item.usedBy || '-';
                const statusText = item.status === 'used' ? '已使用' : '未使用';
                const createdText = item.createdAt ? new Date(item.createdAt).toLocaleString() : '-';
                const planLabel = item.plan === 'yearly' ? '年度' : (item.plan === 'monthly' ? '月度' : '-');
                return `<tr data-code="${(item.code||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}">
                    <td>${(item.code||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</td>
                    <td>${planLabel}</td>
                    <td>${statusText}</td>
                    <td>${(issued||'-').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</td>
                    <td>${(user||'-').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</td>
                    <td>${createdText}</td>
                    <td>
                        <button class="save-btn copy-code-btn">复制</button>
                        <button class="cancel-btn delete-code-btn">删除</button>
                    </td>
                </tr>`;
            }).join('');
        }
        // 生成新激活码（管理员）
        const desktopVipNewMonthlyBtn = document.getElementById('desktopVipNewMonthlyBtn');
        const desktopVipNewYearlyBtn = document.getElementById('desktopVipNewYearlyBtn');
        if (desktopVipNewMonthlyBtn) {
            desktopVipNewMonthlyBtn.addEventListener('click', function(){
                if (!requireAdmin()) { alert('需要管理员权限'); return; }
                const code = generateVipCode('monthly');
                const list = getVipCodes();
                const u = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                list.push({ code, plan: 'monthly', status: 'unused', createdAt: Date.now(), issuedTo: u.username || 'admin' });
                saveVipCodes(list);
                renderVipCodesDesktop();
                alert('已生成月度VIP激活码：' + code);
            });
        }
        if (desktopVipNewYearlyBtn) {
            desktopVipNewYearlyBtn.addEventListener('click', function(){
                if (!requireAdmin()) { alert('需要管理员权限'); return; }
                const code = generateVipCode('yearly');
                const list = getVipCodes();
                const u = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                list.push({ code, plan: 'yearly', status: 'unused', createdAt: Date.now(), issuedTo: u.username || 'admin' });
                saveVipCodes(list);
                renderVipCodesDesktop();
                alert('已生成年度VIP激活码：' + code);
            });
        }
        // 桌面端表格内复制/删除
        document.addEventListener('click', function(e){
            const panel = document.getElementById('vip-codes-panel');
            if (!panel || panel.style.display === 'none') return;
            const t = e.target;
            if (t.classList && t.classList.contains('copy-code-btn')) {
                const tr = t.closest('tr');
                const code = tr && tr.dataset.code;
                if (!code) return;
                try { navigator.clipboard.writeText(code); alert('已复制：' + code); }
                catch { alert('请手动复制：' + code); }
                return;
            }
            if (t.classList && t.classList.contains('delete-code-btn')) {
                const tr = t.closest('tr');
                const code = tr && tr.dataset.code;
                if (!code) return;
                const list = getVipCodes().filter(i => i.code !== code);
                saveVipCodes(list);
                renderVipCodesDesktop();
                return;
            }
        });

        // 会员登录系统
        loginBtn.addEventListener('click', function() {
            loginModal.style.display = 'flex';
        });

        closeLoginModal.addEventListener('click', function() {
            loginModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });

        // 登录标签切换
        loginTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // 更新标签状态
                loginTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // 显示对应的表单
                loginForms.forEach(form => {
                    form.classList.remove('active');
                    if (form.id === `${tabName}Form`) {
                        form.classList.add('active');
                    }
                });
            });
        });

        // 登录表单提交
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const usernameOrEmail = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            // 管理员登录
            if (usernameOrEmail === adminAccount.username && password === adminAccount.password) {
                const userInfo = {
                    username: adminAccount.username,
                    role: adminAccount.role,
                    isLoggedIn: true
                };
                // 管理员不使用等级/经验/铜币属性
                localStorage.setItem('taixuanUser', JSON.stringify(userInfo));
                updateAuthUI(userInfo.username, userInfo.role);
                loginModal.style.display = 'none';
                alert('管理员登录成功！');
                return;
            }

            // 会员登录（需激活）
            const members = getMembers();
            const m = members.find(x => x.email === usernameOrEmail || x.username === usernameOrEmail);
            if (!m) {
                alert('未找到该会员，请检查用户名/邮箱或先注册。');
                return;
            }
            if (m.status !== MEMBER_STATUS.active) {
                alert('该会员尚未激活或已被注销，无法登录。');
                return;
            }

            const sUsername = safeText(m.username);
            const sEmail = safeText(m.email);
            let userInfo = {
                username: sUsername,
                email: sEmail,
                role: 'user',
                isLoggedIn: true,
                level: Number(m.level || 1),
                xp: Number(m.xp || 0),
                coins: Math.min(999, Number(m.coins || 0)),
                lastRewardDate: m.lastRewardDate || ''
            };
            // 登录时根据激活码记录同步VIP状态与到期时间
            try {
                const vipList = JSON.parse(localStorage.getItem('taixuanVipCodes')) || [];
                const usedByUser = vipList.filter(i => i.status === 'used' && i.usedBy === sUsername);
                if (usedByUser.length) {
                    usedByUser.sort((a,b)=>Number(b.usedAt||0)-Number(a.usedAt||0));
                    const latest = usedByUser[0];
                    const inferredPlan = latest.plan || (typeof latest.code === 'string' && latest.code.startsWith('VIP-M-') ? 'monthly' : (typeof latest.code === 'string' && latest.code.startsWith('VIP-Y-') ? 'yearly' : ''));
                    let expireTs = 0;
                    if (latest.usedAt) {
                        if (inferredPlan === 'monthly') expireTs = Number(latest.usedAt) + 30*24*60*60*1000;
                        else if (inferredPlan === 'yearly') expireTs = Number(latest.usedAt) + 365*24*60*60*1000;
                    }
                    userInfo.vipPlan = inferredPlan || '';
                    userInfo.vipExpireAt = expireTs || 0;
                    userInfo.isVIP = !expireTs || Date.now() < expireTs;
                }
            } catch(e) {}
            userInfo = applyDailyLoginReward(ensureUserStats(userInfo));
            if (userInfo.coins > 999) userInfo.coins = 999;
            localStorage.setItem('taixuanUser', JSON.stringify(userInfo));
            // 同步每日奖励到会员存储
            m.level = userInfo.level;
            m.xp = userInfo.xp;
            m.coins = userInfo.coins;
            m.lastRewardDate = userInfo.lastRewardDate;
            saveMembers(members);
            updateAuthUI(userInfo.username, userInfo.role);
            loginModal.style.display = 'none';
            alert('登录成功！');
        });

        // 注册表单提交
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const usernameInput = document.getElementById('registerUsername').value;
            const emailInput = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const inviteCodeInput = document.getElementById('registerInviteCode').value;

            if (password !== confirmPassword) {
                alert('两次输入的密码不一致，请重新输入！');
                return;
            }

            if (!isInviteValid(inviteCodeInput)) {
                 alert('邀请码无效或已过期，请联系管理员。');
                 return;
             }

            const username = safeText(usernameInput);
            const email = safeText(emailInput);

            const members = getMembers();
            const existing = members.find(x => x.email === email || x.username === username);
            if (existing && existing.status !== MEMBER_STATUS.revoked) {
                alert('该邮箱或用户名已注册，请直接登录或更换。');
                return;
            }

            if (existing && existing.status === MEMBER_STATUS.revoked) {
                // 复活被注销的会员，重新进入待审批
                existing.username = username;
                existing.email = email;
                existing.inviteCode = inviteCodeInput;
                existing.status = MEMBER_STATUS.pending;
                existing.createdAt = Date.now();
                saveMembers(members);
            } else {
                const newMember = {
                    username,
                    email,
                    inviteCode: inviteCodeInput,
                    status: MEMBER_STATUS.pending,
                    createdAt: Date.now()
                };
                members.push(newMember);
                saveMembers(members);
            }

            // 让新注册会员“自动出现在”学员管理面板
            if (typeof renderStudentsTable === 'function') renderStudentsTable();
            if (typeof renderWhitelist === 'function') renderWhitelist();

            loginModal.style.display = 'none';
            alert('注册成功！已提交审批，请等待管理员审核。');
        });

        // 更新登录状态UI
        function updateAuthUI(username, role) {
            const sUsername = safeText(username || '');
            const firstChar = sUsername.charAt(0);
            const u = JSON.parse(localStorage.getItem('taixuanUser')) || {};
            const coins = Number(u.coins || 0);
            const xp = Number(u.xp || 0);
            const level = Number(u.level || 1);
            const threshold = getLevelThreshold(level);
            const progressPct = (level < 6 && isFinite(threshold)) ? Math.max(0, Math.min(100, Math.floor((xp / threshold) * 100))) : 100;
            // 计算VIP状态与过期：优先用户记录，其次根据激活码及类型推断
            let isVipFlag = !!u.isVIP;
            let vipExpireAt = Number(u.vipExpireAt || 0);
            let vipPlan = u.vipPlan || '';
            const nowTs = Date.now();
            if (vipExpireAt) {
                isVipFlag = nowTs < vipExpireAt;
            }
            try {
                const vipList = JSON.parse(localStorage.getItem('taixuanVipCodes')) || [];
                const usedByUser = vipList.filter(i => i.status === 'used' && i.usedBy === sUsername);
                if (usedByUser.length) {
                    usedByUser.sort((a,b)=>Number(b.usedAt||0)-Number(a.usedAt||0));
                    const latest = usedByUser[0];
                    const inferredPlan = latest.plan || (typeof latest.code === 'string' && latest.code.startsWith('VIP-M-') ? 'monthly' : (typeof latest.code === 'string' && latest.code.startsWith('VIP-Y-') ? 'yearly' : ''));
                    let calcExpire = 0;
                    if (latest.usedAt) {
                        if (inferredPlan === 'monthly') calcExpire = Number(latest.usedAt) + 30*24*60*60*1000;
                        else if (inferredPlan === 'yearly') calcExpire = Number(latest.usedAt) + 365*24*60*60*1000;
                    }
                    if (calcExpire) {
                        vipExpireAt = vipExpireAt || calcExpire;
                        vipPlan = vipPlan || inferredPlan;
                        isVipFlag = nowTs < calcExpire;
                    } else {
                        // 无法计算过期（无类型或无时间），视为不设过期
                        isVipFlag = true;
                    }
                }
            } catch(e) {}
            // 回写用户对象中的VIP到期与类型，确保后续渲染一致
            try {
                u.vipExpireAt = vipExpireAt || u.vipExpireAt || 0;
                u.vipPlan = vipPlan || u.vipPlan || '';
                u.isVIP = !!isVipFlag;
                localStorage.setItem('taixuanUser', JSON.stringify(u));
            } catch(e) {}

            if (role === 'admin') {
                authSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar admin-avatar">管</div>
                        <div class="user-tooltip">
                            <div class="line"><span class="label">角色</span><span class="value">管理员</span></div>
                        </div>
                        <span>${sUsername}${isVipFlag ? '（大会员）' : ''}</span>
                        <button class="logout-btn" id="logoutBtn">退出</button>
                    </div>
                `;
                adminPanelLink.style.display = 'block';
                myCoursesLink.style.display = 'none';
            } else {
                authSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar ${isVipFlag ? 'vip' : ''}">${firstChar}</div>
                        <div class="user-tooltip">
                            <div class="line"><span class="label">等级</span><span class="value">Lv${level}</span></div>
                            <div class="line"><span class="label">铜币</span><span class="value">${coins}</span></div>
                            <div class="line"><span class="label">经验值</span><span class="value">${(level < 6 && isFinite(threshold)) ? (xp + '/' + threshold) : '满级'}</span></div>
                            <div class="line"><span class="label">会员状态</span><span class="value">${isVipFlag ? '大会员' : '普通'}</span></div>
                            <div class="user-progress"><div class="user-progress-bar" style="width: ${progressPct}%;"></div></div>
                        </div>
                        <span>${sUsername}</span>
                        <button class="logout-btn" id="logoutBtn">退出</button>
                    </div>
                `;
                adminPanelLink.style.display = 'none';
                myCoursesLink.style.display = 'block';
            }
            
            // 绑定退出按钮事件
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('taixuanUser');
                location.reload();
            });
            
            // 绑定我的课程链接事件
            myCoursesLink.addEventListener('click', function(e) {
                e.preventDefault();
                showMyCoursesPage();
            });
            
            // 绑定管理面板链接事件
            if (role === 'admin') {
                adminPanelLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    showAdminPanel();
                });
            }
            // 邮件：根据登录状态更新显示与气泡（刷新后兜底处理）
            try {
                const mailItem = document.getElementById('mailNavItem');
                if (mailItem) mailItem.style.display = (role === 'admin') ? 'none' : 'block';
                if (typeof updateMailVisibility === 'function') updateMailVisibility();
                if (typeof updateMailIndicator === 'function') updateMailIndicator();
            } catch(e) {}
        }

        // 保存用户属性
        (function initUserStatsEditor(){
            const btn = document.getElementById('saveUserStatsBtn');
            if (!btn) return;
            btn.addEventListener('click', function(){
                const target = (document.getElementById('statsTarget').value || '').trim();
                const level = Number(document.getElementById('statsLevel').value);
                const xp = Number(document.getElementById('statsXp').value);
                const coins = Number(document.getElementById('statsCoins').value);
                if (!(level >= 1 && level <= 6) || xp < 0 || coins < 0) {
                    alert('请输入有效的等级(1-6)、经验(>=0)、铜币(>=0)。');
                    return;
                }
                const coinsCapped = Math.min(999, coins);
                const cu = JSON.parse(localStorage.getItem('taixuanUser')) || null;
                // 修改当前登录用户或未指定目标
                if (!target || (cu && (cu.username === target || cu.email === target))) {
                    // 管理员不具备等级/经验/铜币属性，不允许修改当前管理员自身
                    if (cu && cu.role === 'admin') {
                        alert('管理员不具备等级、经验、铜币属性；请在“目标用户”输入会员的用户名或邮箱进行修改。');
                        return;
                    }
                    const updated = ensureUserStats(cu || {});
                    const label = '当前用户：' + (cu ? (cu.username || cu.email || '') : '');
                    if (!confirm(`确认修改以下用户属性？\n${label}\n等级: Lv${level}\n经验: ${xp}\n铜币: ${coinsCapped}`)) { return; }
                    const norm = normalizeLevelXp(level, xp);
                    updated.level = norm.level;
                    updated.xp = norm.xp;
                    updated.coins = coinsCapped;
                    localStorage.setItem('taixuanUser', JSON.stringify(updated));
                    updateAuthUI(updated.username, updated.role);
                    const lvEl = document.getElementById('currentLevel');
                    const coinsEl = document.getElementById('currentCoins');
                    if (lvEl) lvEl.textContent = 'Lv' + level;
                    if (coinsEl) coinsEl.textContent = String(coinsCapped);
                    const threshold = getLevelThreshold(level);
                    const pct = (level < 6 && isFinite(threshold)) ? Math.round(Math.min(100, (xp / threshold) * 100)) : 100;
                    const labelEl = document.getElementById('currentProgressLabel');
                    const barEl = document.getElementById('currentProgressBar');
                    if (labelEl) labelEl.textContent = (level < 6 && isFinite(threshold)) ? (xp + '/' + threshold) : '满级';
                    if (barEl) barEl.style.width = pct + '%';
                    const lvlInput = document.getElementById('statsLevel');
                    const xpInput = document.getElementById('statsXp');
                    if (lvlInput) lvlInput.value = String(updated.level);
                    if (xpInput) xpInput.value = String(updated.xp);
                    alert('已保存当前用户属性。');
                    // 如果为会员，同时同步到 taixuanMembers
                    if (updated && updated.role === 'user') {
                        const members = getMembers();
                        const mm = members.find(x => x.email === updated.email || x.username === updated.username);
                        if (mm) {
                            mm.level = updated.level;
                            mm.xp = updated.xp;
                            mm.coins = updated.coins;
                            mm.lastRewardDate = updated.lastRewardDate || '';
                            saveMembers(members);
                        }
                    }
                } else {
                    // 修改其他用户（会员）
                    const members = getMembers();
                    const mm = members.find(x => x.email === target || x.username === target);
                    if (!mm) {
                        alert('未找到该用户，请输入已注册会员的用户名或邮箱。');
                        return;
                    }
                    const label = '目标用户：' + (mm.username || mm.email || '');
                    if (!confirm(`确认修改以下用户属性？\n${label}\n等级: Lv${level}\n经验: ${xp}\n铜币: ${coinsCapped}`)) { return; }
                    const norm = normalizeLevelXp(level, xp);
                    mm.level = norm.level;
                    mm.xp = norm.xp;
                    mm.coins = coinsCapped;
                    // 保持其 lastRewardDate 不变
                    saveMembers(members);
                    const lvlInput = document.getElementById('statsLevel');
                    const xpInput = document.getElementById('statsXp');
                    if (lvlInput) lvlInput.value = String(mm.level);
                    if (xpInput) xpInput.value = String(mm.xp);
                    alert('已保存指定用户属性。');
                }
            });
            // 目标用户预填：输入用户名或邮箱后自动填充等级/经验/铜币
            const targetInput = document.getElementById('statsTarget');
            if (targetInput) {
                const prefill = function() {
                    const key = (targetInput.value || '').trim();
                    if (!key) return;
                    const members = getMembers();
                    const mm = members.find(x => x.email === key || x.username === key);
                    if (mm) {
                        const lvEl = document.getElementById('statsLevel');
                        const xpEl = document.getElementById('statsXp');
                        const coinsEl = document.getElementById('statsCoins');
                        if (lvEl) lvEl.value = String(Number(mm.level || 1));
                        if (xpEl) xpEl.value = String(Number(mm.xp || 0));
                        if (coinsEl) coinsEl.value = String(Math.min(999, Number(mm.coins || 0)));
                    }
                };
                targetInput.addEventListener('change', prefill);
                targetInput.addEventListener('blur', prefill);
                targetInput.addEventListener('input', prefill);
            }
        })();

        // 显示我的课程页面
        function showMyCoursesPage() {
            const currentUser = JSON.parse(localStorage.getItem('taixuanUser'));
            if (currentUser && currentUser.role === 'admin') {
                alert('管理员没有“我的课程”，请使用管理员面板。');
                showHomePage();
                return;
            }
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            myCoursesSection.style.display = 'block';
            
            // 更新我的课程数据
            updateMyCoursesData();
        }

        // 更新我的课程数据（基于学员分组的 gating）
        function updateMyCoursesData() {
            const currentUser = JSON.parse(localStorage.getItem('taixuanUser'));
            
            // 在学员列表中查找当前用户（优先邮箱，其次用户名）
            const student = currentUser ? (
                students.find(s => (s.email && currentUser.email && s.email === currentUser.email) || (s.name === currentUser.username))
            ) : null;
            
            // 显示当前用户所在班组（未登录/未登记/未分组友好提示）
            const userGroupEl = document.getElementById('userGroupName');
            if (userGroupEl) {
                let groupLabel = '未分组';
                let color = '#666';
                if (!currentUser) {
                    groupLabel = '未登录';
                    color = '#666';
                } else if (!student) {
                    groupLabel = '未登记';
                    color = '#666';
                } else {
                    groupLabel = student.group || '未分组';
                    const grp = groups.find(g => g.name === student.group);
                    const level = grp && grp.level ? grp.level : 1; // 默认1:绿
                    color = level === 1 ? 'green' : level === 2 ? 'gold' : level === 3 ? 'red' : 'black';
                }
                userGroupEl.textContent = safeText(groupLabel);
                userGroupEl.style.color = color;
                userGroupEl.style.fontWeight = '600';
            }
            
            // gating：未匹配学员、分组为“未分组”、或未配置课程 -> 无课程
            let userCoursesList = [];
            if (student && Array.isArray(student.courses) && student.courses.length > 0) {
                userCoursesList = student.courses.map(cItem => {
                    const numericId = typeof cItem === 'number' ? cItem : parseInt(cItem, 10);
                    let course = null;
                    if (!isNaN(numericId)) {
                        course = courses.find(c => c.id === numericId);
                    }
                    if (!course) {
                        course = courses.find(c => c.name === String(cItem));
                    }
                    const title = course ? course.name : String(cItem);
                    return {
                        title: title,
                        instructor: course ? course.instructor : '待指定',
                        category: course ? course.category : '',
                        imageUrl: course ? (course.imageUrl || '') : '',
                        progress: student.progress || 0,
                        studyTime: student.studyTime || 0
                    };
                });
                // 去重：相同课程只保留一个
                const seenTitles = new Set();
                userCoursesList = userCoursesList.filter(c => {
                    const t = String(c.title || '').toLowerCase().trim();
                    if (seenTitles.has(t)) return false;
                    seenTitles.add(t);
                    return true;
                });
            }
            
            // 统计数据（空数据安全处理）
            document.getElementById('totalUserCourses').textContent = userCoursesList.length;
            document.getElementById('completedUserCourses').textContent = userCoursesList.filter(course => course.progress === 100).length;
            
            const totalProgress = userCoursesList.length > 0
                ? userCoursesList.reduce((sum, course) => sum + course.progress, 0) / userCoursesList.length
                : 0;
            document.getElementById('totalUserProgress').textContent = `${Math.round(totalProgress)}%`;
            
            const totalStudyTime = userCoursesList.reduce((sum, course) => sum + (course.studyTime || 0), 0);
            document.getElementById('userStudyTime').textContent = totalStudyTime;
            
            // 渲染课程网格（为空则渲染为空，实现“什么都没有”）
            const coursesGrid = document.getElementById('coursesGrid');
            const safeUserCourses = userCoursesList.map(c => ({
                ...c,
                title: safeText(c.title),
                instructor: safeText(c.instructor),
                category: safeText(c.category),
                imageUrl: safeText(c.imageUrl || '')
            }));
            coursesGrid.innerHTML = safeUserCourses.map(course => `
                <div class="course-card">
                    <div class="course-image" style="text-align:center;">
                        ${course.imageUrl ? `<img src="${course.imageUrl}" alt="${course.title} 封面" style="max-width:100%;height:auto;border-radius:8px;">` : ``}
                    </div>
                    <div class="course-content">
                        <h3 class="course-title">${course.title}</h3>
                        <div class="course-meta">
                            <span>讲师: ${course.instructor}</span>
                            <span>分类: ${course.category}</span>
                        </div>
                        <div class="progress-container">
                            <div class="course-progress-bar">
                                <div class="course-progress-fill" style="width: ${course.progress}%"></div>
                            </div>
                            <div class="course-progress-text">
                                <span>学习进度</span>
                                <span>${course.progress}%</span>
                            </div>
                        </div>
                        <div class="course-actions">
                            <button class="continue-btn">继续学习</button>
                            <button class="review-btn">复习课程</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 显示管理员面板（权限校验）
        function showAdminPanel() {
            const currentUser = JSON.parse(localStorage.getItem('taixuanUser'));
            if (!currentUser || currentUser.role !== 'admin') {
                alert('权限不足：仅管理员可访问。');
                showHomePage();
                return;
            }
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            adminSection.style.display = 'block';
            
            // 初始化管理员面板数据
            renderStudentsTable();
            renderGroupsTable();
            renderCoursesTable();
            renderPublicClassesTable();
            renderMessagesTable();
            renderAnnouncementsTable();
        }

        // 绑定联系导师弹窗事件
        const contactModal = document.getElementById('contactModal');
        const closeModal = document.getElementById('closeModal');

        closeModal.addEventListener('click', function() {
            contactModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === contactModal) {
                contactModal.style.display = 'none';
            }
        });

        // 绑定VIP激活弹窗事件
        const vipActivateModal = document.getElementById('vipActivateModal');
        const closeVipActivateModal = document.getElementById('closeVipActivateModal');
        if (closeVipActivateModal) {
            closeVipActivateModal.addEventListener('click', function() {
                vipActivateModal.style.display = 'none';
                document.body.style.overflow = '';
                // 清除已选择的赞助类型
                localStorage.removeItem('vipDesiredPlan');
            });
        }
        window.addEventListener('click', function(event) {
            if (event.target === vipActivateModal) {
                vipActivateModal.style.display = 'none';
                document.body.style.overflow = '';
                // 清除已选择的赞助类型
                localStorage.removeItem('vipDesiredPlan');
            }
        });
        const desktopVipActivateBtn = document.getElementById('desktopVipActivateBtn');
        if (desktopVipActivateBtn) {
            desktopVipActivateBtn.addEventListener('click', function(){
                const code = (document.getElementById('desktopVipActivationInput').value || '').trim();
                if (!code) { alert('请输入激活码'); return; }
                const userInfo = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                if (!userInfo || !userInfo.isLoggedIn) { alert('请先登录再激活VIP'); return; }
                let list;
                try { list = JSON.parse(localStorage.getItem('taixuanVipCodes')) || []; } catch(e) { list = []; }
                const item = list.find(x => x.code === code);
                if (!item) { alert('未找到该激活码，请确认后再试'); return; }
                if (item.status === 'used') { alert('该激活码已被使用'); return; }
                // 预判激活码类型
                const inferredPlan = item.plan || (typeof item.code === 'string' && item.code.startsWith('VIP-M-') ? 'monthly' : (typeof item.code === 'string' && item.code.startsWith('VIP-Y-') ? 'yearly' : ''));
                // 检查与所选赞助类型一致性
                const desiredPlan = localStorage.getItem('vipDesiredPlan') || '';
                if (desiredPlan && inferredPlan && inferredPlan !== desiredPlan) {
                    alert(`您选择的是${desiredPlan==='yearly'?'年度':'月度'}赞助，请使用对应类型的激活码`);
                    return;
                }
                // 检查当前会员类型与到期，禁止跨类型激活
                let currentPlan = userInfo.vipPlan || '';
                let currentExpire = Number(userInfo.vipExpireAt || 0);
                if (!currentExpire || Date.now() >= currentExpire) {
                    try {
                        const usedByUser = list.filter(i => i.status === 'used' && i.usedBy === userInfo.username);
                        if (usedByUser.length) {
                            usedByUser.sort((a,b)=>Number(b.usedAt||0)-Number(a.usedAt||0));
                            const latest = usedByUser[0];
                            const latestPlan = latest.plan || (typeof latest.code === 'string' && latest.code.startsWith('VIP-M-') ? 'monthly' : (typeof latest.code === 'string' && latest.code.startsWith('VIP-Y-') ? 'yearly' : ''));
                            if (latest.usedAt && latestPlan) {
                                currentPlan = latestPlan;
                                currentExpire = latestPlan === 'monthly' ? Number(latest.usedAt) + 30*24*60*60*1000 : Number(latest.usedAt) + 365*24*60*60*1000;
                            }
                        }
                    } catch(e) {}
                }
                if (currentPlan && currentExpire && Date.now() < currentExpire && inferredPlan && inferredPlan !== currentPlan) {
                    alert(`当前为${currentPlan==='yearly'?'年度':'月度'}VIP（未过期），不能使用${inferredPlan==='yearly'?'年度':'月度'}激活码`);
                    return;
                }
                // 标记使用并写入到期
                item.status = 'used';
                item.usedBy = userInfo.username;
                item.usedAt = Date.now();
                if (!item.plan && inferredPlan) { item.plan = inferredPlan; }
                localStorage.setItem('taixuanVipCodes', JSON.stringify(list));
                let expireTs = 0;
                if (item.usedAt) {
                    if (inferredPlan === 'monthly') expireTs = Number(item.usedAt) + 30*24*60*60*1000;
                    else if (inferredPlan === 'yearly') expireTs = Number(item.usedAt) + 365*24*60*60*1000;
                }
                userInfo.vipPlan = inferredPlan || '';
                userInfo.vipExpireAt = expireTs || 0;
                userInfo.isVIP = !expireTs || Date.now() < expireTs;
                localStorage.setItem('taixuanUser', JSON.stringify(userInfo));
                updateAuthUI(userInfo.username, userInfo.role);
                alert('VIP已激活，感谢赞助！');
                vipActivateModal.style.display = 'none';
                document.body.style.overflow = '';
            });
        }

        // 邮件弹窗关闭事件
        const mailModal = document.getElementById('mailModal');
        const closeMailModal = document.getElementById('closeMailModal');
        closeMailModal.addEventListener('click', function() {
            mailModal.style.display = 'none';
            document.body.style.overflow = '';
        });
        window.addEventListener('click', function(event) {
            if (event.target === mailModal) {
                mailModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && mailModal && mailModal.style.display === 'flex') {
                mailModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        const refreshMailModalBtn = document.getElementById('refreshMailModalBtn');
        if (refreshMailModalBtn) {
            refreshMailModalBtn.addEventListener('click', function() {
                try {
                    renderMailAnnouncementsModal();
                    renderMailRepliesModal();
                } catch(e) {}
            });
        }
        // 轻量入场动效：分屏进入时淡入上移
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('section-visible');
                }
            });
        }, { threshold: 0.3 });
        document.querySelectorAll('section, footer').forEach(el => observer.observe(el));
    </script>
<script><!-- 已移除全局粒子效果脚本：保留语录横幅粒子效果 --></script>
    <!-- 接入 Supabase（使用全局配置 supabase.config.js）用于云同步 -->
    <script src="./supabase.config.js?v=prod1"></script>
    <script src="./assets/supabase.js?v=prod1"></script>
    <script>
      function isSupabaseConfigValid(){
        try{
          const u = (window.__SUPABASE__ && window.__SUPABASE__.url) || '';
          const a = (window.__SUPABASE__ && window.__SUPABASE__.anon) || '';
          const okDomain = /^https:\/\/[a-z0-9-]+\.supabase\.co$/i.test(u) && !/your-project\.supabase\.co/i.test(u);
          return !!(window.supabase && okDomain && a && a.length > 20);
        }catch(e){ return false; }
      }
      try {
        if (isSupabaseConfigValid()) {
          window.supabaseClient = window.supabase.createClient(window.__SUPABASE__.url, window.__SUPABASE__.anon);
          try { const n = document.getElementById('supabase-not-ready'); if (n) n.remove(); } catch(e){}

          // 自愈：保证 members 存在当前用户记录
          window.ensureMemberRow = async function(userId, email){
            try {
              const { data: existing } = await supabaseClient
                .from('members').select('user_id').eq('user_id', userId).limit(1).maybeSingle();
              if (!existing) {
                await supabaseClient.from('members').insert({ user_id: userId, email: email || '', role: 'user' });
              }
            } catch(e) {}
          };
        } else {
          console.warn('Supabase 未初始化或 SDK 未加载：请放置 /assets/supabase.js 并在 supabase.config.js 填写项目配置');
          try {
            const note = document.createElement('div');
            note.style.position = 'fixed';
            note.style.bottom = '10px';
            note.style.right = '10px';
            note.style.zIndex = '9999';
            note.style.background = '#fff7e6';
            note.style.border = '1px solid #ffd591';
            note.style.color = '#ad4e00';
            note.style.padding = '8px 12px';
            note.style.borderRadius = '8px';
            note.style.boxShadow = '0 6px 16px rgba(0,0,0,0.06)';
            note.id = 'supabase-not-ready';
            note.textContent = '云读写未就绪：请将 Supabase SDK 放到 /assets/supabase.js，并配置 supabase.config.js';
            document.body.appendChild(note);

            // 统一的初始化尝试：配置有效且 SDK 可用时创建客户端并移除提示
            function tryInit(){
              try {
                if (isSupabaseConfigValid() && window.supabase && !window.supabaseClient) {
                  window.supabaseClient = window.supabase.createClient(window.__SUPABASE__.url, window.__SUPABASE__.anon);
                  const n = document.getElementById('supabase-not-ready'); if (n) n.remove();
                  return true;
                }
              } catch(_) {}
              return false;
            }

            // 首次延迟尝试（应对异步加载）
            try { setTimeout(tryInit, 600); } catch(_) {}

            // 事件驱动：SDK 加载器触发后再次尝试
            try { window.addEventListener('supabase-loaded', tryInit); } catch(_) {}

            // 周期性重试：最多 10 秒（适配 CDN 失败回退到本地最小客户端的场景）
            try {
              const start = Date.now();
              const iv = setInterval(function(){
                if (tryInit()) { clearInterval(iv); }
                else if (Date.now() - start > 10000) { clearInterval(iv); }
              }, 500);
            } catch(_) {}
          } catch(e){}
        }
      } catch(e) { console.warn('Supabase 初始化失败或未配置：', e); }
    </script>
    <script>
      (function(){
        function isAdmin(){
          try { const u = JSON.parse(localStorage.getItem('taixuanUser')); return !!(u && u.role === 'admin'); } catch(e){ return false; }
        }
        // 仅在管理员管理面板中启动诊断
        window.startSupabaseDiagnostics = function(){
          if (!isAdmin()) return;
          var cont = document.querySelector('#diagnostics-panel #supabase-diagnostics-content');
          if (!cont) return;
          if (cont.getAttribute('data-started') === '1') return;
          cont.setAttribute('data-started','1');
          function snap(){
            var sdk = !!(window.supabase && window.supabase.createClient);
            var client = !!window.supabaseClient;
            var cfg = (window.__SUPABASE__||{});
            var valid = (function(){ try{ var u=(cfg&&cfg.url)||''; var a=(cfg&&cfg.anon)||''; var okDomain=/^https:\/\/[a-z0-9-]+\.supabase\.co$/i.test(u) && !/your-project\.supabase\.co/i.test(u); return !!(window.supabase && okDomain && a && a.length>20);}catch(e){return false;} })();
            var html = ''
              + 'SDK: ' + (sdk?'ok':'missing') + '<br>'
              + 'Client: ' + (client?'ok':'missing') + '<br>'
              + 'Valid: ' + (valid?'true':'false') + '<br>'
              + 'URL: ' + (cfg.url||'(none)') + '<br>'
              + 'Anon.len: ' + ((cfg.anon||'').length);
            cont.innerHTML = html;
            try {
              if (valid && sdk && !window.supabaseClient) {
                window.supabaseClient = window.supabase.createClient(cfg.url, cfg.anon);
              }
              if (window.supabaseClient) {
                var n = document.getElementById('supabase-not-ready'); if (n) n.remove();
              }
            } catch(e){}
          }
          var start = Date.now();
          var iv = setInterval(function(){ snap(); if (Date.now() - start > 10000) clearInterval(iv); }, 1000);
          snap();
        };
        // 点击诊断标签时启动
        document.addEventListener('DOMContentLoaded', function(){
          var btn = document.querySelector('.admin-tab[data-tab="diagnostics"]');
          if (btn) btn.addEventListener('click', function(){ if (typeof startSupabaseDiagnostics === 'function') startSupabaseDiagnostics(); });
        });
      })();
    </script>
    <script>
      (function(){
        function cloudGetStudents(){ try { return JSON.parse(localStorage.getItem('taixuanStudents')) || []; } catch(e){ return []; } }
        function cloudGetGroups(){ try { return JSON.parse(localStorage.getItem('taixuanGroups')) || []; } catch(e){ return []; } }
        window.cloudLoadToLocal = async function(){
          if (!window.supabaseClient) return;
          try {
            const { data: sess } = await supabaseClient.auth.getSession();
            const me = sess.session?.user; if (!me) return;
            try { await ensureMemberRow(me.id, me.email || ''); } catch(_){ }
            const { data: stu } = await supabaseClient.from('students').select('*');
            const { data: grp } = await supabaseClient.from('groups').select('*');
            if (Array.isArray(stu)) localStorage.setItem('taixuanStudents', JSON.stringify(stu));
            if (Array.isArray(grp)) localStorage.setItem('taixuanGroups', JSON.stringify(grp));
          } catch(e){ console.warn('云拉取失败：', e); }
        };
        window.cloudSaveFromLocal = async function(){
          if (!window.supabaseClient) return;
          try {
            const { data: sess } = await supabaseClient.auth.getSession();
            const me = sess.session?.user; if (!me) return;
            try { await ensureMemberRow(me.id, me.email || ''); } catch(_){ }
            const s = cloudGetStudents(); const g = cloudGetGroups();
            if (s.length) {
              await supabaseClient.from('students').upsert(
                s.map(x => ({
                  id: x.id,
                  name: x.name || '',
                  email: x.email || '',
                  group: x.group || '',
                  joinDate: x.joinDate || '',
                  progress: Number(x.progress||0),
                  studyTime: Number(x.studyTime||0),
                  courses: Array.isArray(x.courses)? x.courses : [],
                  user_id: me.id
                })), { onConflict: 'id' }
              );
            }
            if (g.length) {
              await supabaseClient.from('groups').upsert(
                g.map(y => ({
                  name: y.name || '',
                  manager: y.manager || '',
                  createDate: y.createDate || '',
                  description: y.description || '',
                  level: Number(y.level||1)
                })), { onConflict: 'name' }
              );
            }
            console.log('云写回完成');
          } catch(e){ console.warn('云写回失败：', e); }
        };
        document.addEventListener('DOMContentLoaded', async () => {
          try {
            await (window.cloudLoadToLocal?.() || Promise.resolve());
            const user = JSON.parse(localStorage.getItem('taixuanUser')) || {};
            if (user && user.role === 'admin') {
              setInterval(() => { window.cloudSaveFromLocal?.(); }, 30000);
            }
          } catch(e){}
        });
      })();
    </script>
<script>
    // KV 云同步的 Key 白名单（存成整段 JSON，结构等同 localStorage）
    const CLOUD_KV_KEYS = [
        'taixuanCourses',
        'taixuanPublicClasses',
        'taixuanInviteCodes',
        'taixuanVipCodes',
        'taixuanDiscountCodes',
        'taixuanAnnouncements',
        'taixuanMessages',
        'taixuanMembers',
        'taixuanMusicSettings',
        'vipDesiredPlan',
        'taixuanInviteInit'
    ];

    async function cloudLoadKVToLocal() {
        try {
            if (!isSupabaseConfigValid()) return;
            if (!window.supabaseClient) return;
            for (const key of CLOUD_KV_KEYS) {
                const { data, error } = await supabaseClient
                    .from('app_kv_store')
                    .select('value')
                    .eq('key', key)
                    .maybeSingle();
                if (error) {
                    console.warn('[KV] Load error for', key, error.message);
                    continue;
                }
                if (data && data.value !== undefined) {
                    // 拉取到的 cloud JSON 覆盖本地
                    localStorage.setItem(key, JSON.stringify(data.value));
                    console.log('[KV] Loaded', key, 'items:', Array.isArray(data.value) ? data.value.length : 1);
                } else {
                    console.log('[KV] No cloud value for', key);
                }
            }
            // 拉取后刷新相关 UI（如果渲染函数存在）
            try {
                if (typeof renderInviteCodesTable === 'function') renderInviteCodesTable();
                if (typeof renderVipCodesDesktop === 'function') renderVipCodesDesktop();
                if (typeof renderDiscountCodesTable === 'function') renderDiscountCodesTable('');
                if (typeof renderCoursesTable === 'function') renderCoursesTable();
                if (typeof renderPublicClassesTable === 'function') renderPublicClassesTable();
                if (typeof renderAnnouncements === 'function') renderAnnouncements();
                if (typeof renderMessages === 'function') renderMessages();
            } catch (e) {}
        } catch (e) {
            console.warn('[KV] cloudLoadKVToLocal failed', e);
        }
    }

    async function cloudSaveKVFromLocal() {
        try {
            if (!isSupabaseConfigValid()) return;
            if (!window.supabaseClient) return;
            // 仅管理员写回
            try {
                const u = JSON.parse(localStorage.getItem('taixuanUser')) || {};
                if (!(u && u.role === 'admin')) return;
            } catch (e) { return; }

            window.__KV_LAST_SENT__ = window.__KV_LAST_SENT__ || {};
            for (const key of CLOUD_KV_KEYS) {
                let value;
                try {
                    value = JSON.parse(localStorage.getItem(key) || '[]');
                } catch (e) {
                    value = [];
                }
                const fingerprint = JSON.stringify(value);
                if (window.__KV_LAST_SENT__[key] === fingerprint) {
                    continue;
                }
                const payload = { key, value };
                const { error } = await supabaseClient
                    .from('app_kv_store')
                    .upsert(payload, { onConflict: 'key' });
                if (error) {
                    console.warn('[KV] Save error for', key, error.message);
                } else {
                    window.__KV_LAST_SENT__[key] = fingerprint;
                    console.log('[KV] Saved', key, 'items:', Array.isArray(value) ? value.length : 1);
                }
            }
        } catch (e) {
            console.warn('[KV] cloudSaveKVFromLocal failed', e);
        }
    }

    (function initCloudKVSync() {
        try {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(cloudLoadKVToLocal, 1000);
            });
        } catch (e) {}
        try {
            let loadTimer = null, saveTimer = null;
            let loadMs = null, saveMs = null;
            let lastActivity = Date.now();
            function desiredInterval(){
              const hidden = document.visibilityState === 'hidden';
              const idle = Date.now() - lastActivity > 15000;
              return (hidden || idle) ? 5000 : 1000;
            }
            function ensureIntervals(){
              const interval = desiredInterval();
              if (loadMs !== interval) { if (loadTimer) clearInterval(loadTimer); loadTimer = setInterval(cloudLoadKVToLocal, interval); loadMs = interval; }
              if (saveMs !== interval) { if (saveTimer) clearInterval(saveTimer); saveTimer = setInterval(cloudSaveKVFromLocal, interval); saveMs = interval; }
            }
            ['mousemove','keydown','touchstart','scroll'].forEach(evt => { window.addEventListener(evt, () => { lastActivity = Date.now(); ensureIntervals(); }, { passive:true }); });
            document.addEventListener('visibilitychange', ensureIntervals);
            ensureIntervals();
            setInterval(ensureIntervals, 10000);
         } catch (e) {}
      })();
  </script>
  <script>
    (function(){
      try {
        var params = new URLSearchParams(location.search);
        if (params.get('auto') !== '1') return;
        function addOverlay(){
          // 支持通过 URL 参数隐藏叠层：&autoOverlay=0
          try { if (typeof params !== 'undefined' && params.get('autoOverlay') === '0') return null; } catch(_){}
          var note = document.createElement('div');
          note.style.position = 'fixed'; note.style.bottom = '12px'; note.style.right = '12px'; note.style.zIndex = '99999';
          note.style.padding = '10px 14px'; note.style.borderRadius = '8px'; note.style.boxShadow = '0 6px 16px rgba(0,0,0,0.08)';
          note.style.fontSize = '13px'; note.style.lineHeight = '1.4'; note.style.border = '1px solid #91d5ff';
          note.style.background = '#e6f7ff'; note.style.color = '#0050b3';
          note.id = 'auto-verify-overlay'; note.textContent = 'AutoVerify: running...';
          document.body.appendChild(note); return note;
        }
        function setOverlay(msg, ok){
          var n = document.getElementById('auto-verify-overlay'); if (!n) return;
          n.textContent = 'AutoVerify: ' + msg;
          if (ok) { n.style.background = '#f6ffed'; n.style.borderColor = '#b7eb8f'; n.style.color = '#135200'; }
          else { n.style.background = '#fff1f0'; n.style.borderColor = '#ffa39e'; n.style.color = '#a8071a'; }
        }
        async function run(){
          var overlay = addOverlay();
          try {
            if (!(typeof isSupabaseConfigValid === 'function' && isSupabaseConfigValid() && window.supabase)) { setOverlay('SDK/config missing'); return; }
            if (!window.supabaseClient) window.supabaseClient = window.supabase.createClient(window.__SUPABASE__.url, window.__SUPABASE__.anon);
            var { data: sess } = await supabaseClient.auth.getSession();
            var user = sess && sess.session && sess.session.user || null;
            if (!user) {
              var email = 'diagnostic+' + Date.now() + '@example.com';
              var password = 'Diag_' + Math.random().toString(36).slice(2) + 'Aa1!';
              try { await supabaseClient.auth.signUp({ email: email, password: password }); } catch(e) {}
              var si = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
              if (si && si.error) { setOverlay('login failed: ' + si.error.message); return; }
              ({ data: sess } = await supabaseClient.auth.getSession());
              user = sess && sess.session && sess.session.user || null;
            }
            if (!user) { setOverlay('no session after login'); return; }
            try { await ensureMemberRow(user.id, user.email || ''); } catch(_){}
            // KV 写入与读取
            try {
              await supabaseClient.from('app_kv_store').upsert({ key:'diagnostic', value:{ ok:true, ts: Date.now(), user: user.email || '' } }, { onConflict:'key' });
              await supabaseClient.from('app_kv_store').select('value').eq('key','diagnostic').maybeSingle();
            } catch(_){}
            // 学员/分组写入
            try {
              var s = [{ name:'Auto Student', email:user.email||'', group:'AutoGroup', joinDate:new Date().toISOString(), progress:1, studyTime:1, courses:[], user_id: user.id }];
              var g = [{ name:'AutoGroup', manager:user.email||'', createDate:new Date().toISOString(), description:'Auto verify', level:1 }];
              try { await supabaseClient.from('students').upsert(s, { onConflict:'id' }); } catch(_){}
              try { await supabaseClient.from('groups').upsert(g, { onConflict:'name' }); } catch(_){}
            } catch(_){}
            // 拉取与 RPC 绑定
            try { if (typeof cloudLoadToLocal === 'function') await cloudLoadToLocal(); } catch(_){}
            try { await supabaseClient.rpc('link_my_student_record'); } catch(_){}
            setOverlay('OK', true);
          } catch(e) {
            setOverlay('error: ' + (e && e.message ? e.message : e));
          }
        }
        document.addEventListener('DOMContentLoaded', function(){ run(); });
      } catch(e) {}
    })();
  </script>
  </body>
  </html>